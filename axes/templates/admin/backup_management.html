{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .backup-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
    }
    
    .backup-section {
        background: var(--primary);
        border: 1px solid var(--hairline-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: var(--body-fg);
    }
    
    .backup-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .backup-form .form-group {
        margin-bottom: 0;
    }
    
    .backup-list {
        margin-top: 20px;
    }
    
    .backup-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 15px;
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        margin-bottom: 15px;
        background: var(--darkened-bg);
        color: var(--body-fg);
    }
    
    .backup-info {
        flex: 1;
    }
    
    .backup-stats {
        margin-top: 10px;
        font-size: 0.9em;
        color: var(--secondary-fg);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 8px;
    }
    
    .stat-item {
        background: var(--primary);
        padding: 5px 8px;
        border-radius: 3px;
        border: 1px solid var(--hairline-color);
        text-align: center;
    }
    
    .stat-label {
        font-size: 0.8em;
        color: var(--secondary-fg);
        display: block;
    }
    
    .stat-value {
        font-weight: bold;
        color: var(--body-fg);
        display: block;
    }
    
    .backup-actions {
        display: flex;
        gap: 10px;
        margin-left: 15px;
    }
    
    .btn-danger {
        background-color: var(--delete-button-bg);
        border-color: var(--delete-button-bg);
        color: var(--delete-button-fg);
    }
    
    .btn-danger:hover {
        background-color: var(--delete-button-hover-bg);
        border-color: var(--delete-button-hover-bg);
    }
    
    .btn-primary {
        background-color: var(--button-bg);
        border-color: var(--button-bg);
        color: var(--button-fg);
    }
    
    .btn-primary:hover {
        background-color: var(--button-hover-bg);
        border-color: var(--button-hover-bg);
    }
    
    .file-size {
        color: var(--secondary-fg);
        font-size: 0.9em;
    }
    
    .file-date {
        color: var(--secondary-fg);
        font-size: 0.8em;
    }
    
    /* Anv칛nd Django's CSS-variabler f칬r konsekvent styling */
    .backup-section h2 {
        color: var(--body-fg);
        margin-bottom: 15px;
    }
    
    .backup-section h1 {
        color: var(--body-fg);
        margin-bottom: 20px;
    }
    
    .backup-section ul {
        color: var(--body-fg);
    }
    
    .backup-section code {
        background: var(--darkened-bg);
        color: var(--body-fg);
        padding: 2px 4px;
        border-radius: 3px;
        border: 1px solid var(--hairline-color);
    }
    
    /* Checkbox styling f칬r dark mode */
    .backup-form input[type="checkbox"] {
        accent-color: var(--link-fg);
    }
    
    .backup-form label {
        color: var(--body-fg);
    }
    
    .no-stats {
        font-style: italic;
        color: var(--secondary-fg);
    }
</style>
{% endblock %}

{% block content %}
<div class="backup-container">
    <h1>{{ title }}</h1>
    
    <!-- Varning f칬r 친terst칛llning -->
    <div class="backup-section" style="background-color: var(--message-warning-bg); border: 1px solid var(--message-warning-border); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h3 style="color: var(--message-warning-fg); margin-top: 0;">丘멆잺 Viktigt om 친terst칛llning</h3>
        <p style="color: var(--message-warning-fg); margin-bottom: 0;">
            <strong>칀terst칛llning fr친n backup ers칛tter all nuvarande data!</strong> 
            Se till att du har en backup av din nuvarande data innan du 친terst칛ller fr친n en 칛ldre backup.
        </p>
    </div>
    
    <!-- Visa restore output om det finns -->
    {% if restore_output %}
        <div class="backup-section" style="background-color: var(--message-success-bg); border: 1px solid var(--message-success-border); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="color: var(--message-success-fg); margin-top: 0;">游늶 칀terst칛llningslogg</h3>
            <pre style="background-color: var(--darkened-bg); color: var(--body-fg); padding: 10px; border-radius: 3px; border: 1px solid var(--hairline-color); overflow-x: auto; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">{{ restore_output }}</pre>
        </div>
    {% endif %}
    
    <!-- Visa backup output om det finns -->
    {% if backup_output %}
        <div class="backup-section" style="background-color: var(--message-success-bg); border: 1px solid var(--message-success-border); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3 style="color: var(--message-success-fg); margin-top: 0;">游늶 Backup-logg</h3>
            <pre style="background-color: var(--darkened-bg); color: var(--body-fg); padding: 10px; border-radius: 3px; border: 1px solid var(--hairline-color); overflow-x: auto; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">{{ backup_output }}</pre>
        </div>
    {% endif %}
    
    <!-- Skapa ny backup -->
    <div class="backup-section">
        <h2>Skapa ny backup</h2>
        <form method="post" class="backup-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_backup">
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="include_media" checked>
                    Inkludera media-filer
                </label>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="compress" checked>
                    Komprimera backup
                </label>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    Skapa backup
                </button>
            </div>
        </form>
    </div>
    
    <!-- Lista befintliga backuper -->
    <div class="backup-section">
        <h2>Befintliga backuper</h2>
        
        {% if backups %}
            <div class="backup-list">
                {% for backup in backups %}
                    <div class="backup-item">
                        <div class="backup-info">
                            <strong>{{ backup.filename }}</strong>
                            <div class="file-size">
                                Storlek: {{ backup.size|filesizeformat }}
                            </div>
                            <div class="file-date">
                                Skapad: {{ backup.modified|date:"Y-m-d H:i:s" }}
                            </div>
                            
                            {% if backup.stats %}
                                <div class="backup-stats">
                                    <strong>Inneh친ll:</strong>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <span class="stat-label">Yxor</span>
                                            <span class="stat-value">{{ backup.stats.database.axes }}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Kontakter</span>
                                            <span class="stat-value">{{ backup.stats.database.contacts }}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Tillverkare</span>
                                            <span class="stat-value">{{ backup.stats.database.manufacturers }}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Transaktioner</span>
                                            <span class="stat-value">{{ backup.stats.database.transactions }}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">M친tt</span>
                                            <span class="stat-value">{{ backup.stats.database.measurements }}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Bilder</span>
                                            <span class="stat-value">{{ backup.stats.database.axe_images|add:backup.stats.database.manufacturer_images }}</span>
                                        </div>
                                        {% if backup.stats.media_files %}
                                        <div class="stat-item">
                                            <span class="stat-label">Media-filer</span>
                                            <span class="stat-value">{{ backup.stats.media_files }}</span>
                                        </div>
                                        {% endif %}
                                        {% if backup.stats.financial.total_buy_value > 0 %}
                                        <div class="stat-item">
                                            <span class="stat-label">K칬pv칛rde</span>
                                            <span class="stat-value">{{ backup.stats.financial.total_buy_value|floatformat:0 }} kr</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="backup-stats">
                                    <span class="no-stats">Ingen statistik tillg칛nglig</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="backup-actions">
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="restore_backup">
                                <input type="hidden" name="filename" value="{{ backup.filename }}">
                                <button type="submit" class="btn btn-primary btn-sm" 
                                        onclick="return confirm('츿r du s칛ker p친 att du vill 친terst칛lla fr친n denna backup? Detta kommer att ers칛tta all nuvarande data!')">
                                    칀terst칛ll
                                </button>
                            </form>
                            <form method="post" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete_backup">
                                <input type="hidden" name="filename" value="{{ backup.filename }}">
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('츿r du s칛ker p친 att du vill radera denna backup?')">
                                    Ta bort
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>Inga backuper finns 칛nnu.</p>
        {% endif %}
    </div>
    
    <!-- Information -->
    <div class="backup-section">
        <h2>Information</h2>
        <ul>
            <li>Backuper sparas i: <code>{{ backup_dir }}</code></li>
            <li>Gamla backuper (칛ldre 칛n 30 dagar) raderas automatiskt</li>
            <li>F칬r att 친terst칛lla fr친n backup, anv칛nd kommandot: <code>python manage.py restore_backup backup_fil --confirm</code></li>
            <li>Backuper inkluderar databas och eventuellt media-filer</li>
            <li>Statistik visas f칬r varje backup (antal yxor, kontakter, transaktioner, etc.)</li>
        </ul>
    </div>
</div>
{% endblock %} 