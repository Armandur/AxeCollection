{% extends 'axes/base.html' %}
{% load axe_filters %}

{% block title %}Kontakter - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .profit-positive { color: #198754; }
    .profit-negative { color: #dc3545; }
    
    .contact-link {
        text-decoration: none;
        color: inherit;
    }
    
    .contact-link:hover {
        color: #0d6efd;
        text-decoration: underline;
    }
    
    .member-badge {
        font-size: 0.7em;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Kontakter</h1>

<!-- Statistik-kort -->
{% include 'axes/_contact_stats_cards.html' %}

<!-- Kontaktertabell -->
<div class="table-responsive">
    <table id="contactsTable" class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Namn</th>
                <th>Alias</th>
                <th>E-post</th>
                <th>Telefon</th>
                <th>NAJ</th>
                <th>Köp / Sälj</th>
                <th>Ekonomi</th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr data-href="{% url 'contact_detail' contact.pk %}">
                <td>
                    <a href="{% url 'contact_detail' contact.pk %}" class="contact-link">
                        {{ contact.name }}
                    </a>
                </td>
                <td>
                    {% if contact.alias %}
                        {{ contact.alias }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if contact.email %}
                        <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if contact.phone %}
                        <a href="tel:{{ contact.phone }}">{{ contact.phone }}</a>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if contact.is_naj_member %}
                        <span class="badge bg-success member-badge">NAJ-medlem</span>
                    {% else %}
                        <span class="badge bg-secondary member-badge">Inte medlem</span>
                    {% endif %}
                </td>
                <td data-order="{{ contact.total_transactions }}">
                    <span class="text-danger">{{ contact.buy_count }}</span> / <span class="text-success">{{ contact.sale_count }}</span>
                </td>
                <td data-order="{{ contact.net_value }}">
                    <span class="text-danger">{{ contact.total_buy_value|format_decimal }} kr</span>
                    {% if contact.total_buy_shipping > 0 %}
                        <span class="text-muted">({{ contact.total_buy_shipping|format_decimal }} kr)</span>
                    {% endif %}
                    <br>
                    <span class="text-success">{{ contact.total_sale_value|format_decimal }} kr</span>
                    {% if contact.total_sale_shipping > 0 %}
                        <span class="text-muted">({{ contact.total_sale_shipping|format_decimal }} kr)</span>
                    {% endif %}
                    <br>
                    <span class="{% if contact.net_value >= 0 %}profit-positive{% else %}profit-negative{% endif %} fw-bold">
                        {{ contact.net_value|format_decimal }} kr
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#contactsTable').DataTable({
        language: {
            "emptyTable": "Ingen data tillgänglig i tabellen",
            "info": "Visar _START_ till _END_ av _TOTAL_ poster",
            "infoEmpty": "Visar 0 till 0 av 0 poster",
            "infoFiltered": "(filtrerat från _MAX_ totala poster)",
            "lengthMenu": "Visa _MENU_ poster",
            "loadingRecords": "Laddar...",
            "processing": "Bearbetar...",
            "search": "Sök:",
            "zeroRecords": "Inga matchande poster hittades",
            "paginate": {
                "first": "Första",
                "last": "Sista",
                "next": "Nästa",
                "previous": "Föregående"
            },
            "aria": {
                "sortAscending": ": aktivera för att sortera kolumnen stigande",
                "sortDescending": ": aktivera för att sortera kolumnen fallande"
            },
             "buttons": {
                "copy": "Kopiera",
                "csv": "CSV",
                "excel": "Excel",
                "pdf": "PDF",
                "print": "Skriv ut",
                "colvis": "Visa kolumner"
            }
        },
        order: [[0, 'asc']], // Sortera efter namn som standard
        layout: {
            topStart: 'pageLength',
            topCenter: 'search',
            topEnd: {
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print', 'colvis'
                ]
            }
        }
    });

    // Klickbara rader
    $('#contactsTable tbody').on('click', 'tr', function (event) {
        // Förhindra att klicket propagerar om man klickar på en länk eller knapp inuti raden
        if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || $(event.target).closest('a, button').length) {
            return;
        }
        var href = $(this).data('href');
        if (href) {
            window.location.href = href;
        }
    });
});
</script>
{% endblock %} 