{% extends 'axes/base.html' %}

{% block title %}{% if is_edit %}Redigera yxa{% else %}Skapa ny yxa{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        {% if is_edit %}
                            <i class="fas fa-edit me-2"></i>Redigera yxa
                            <span class="badge bg-secondary ms-2">ID: {{ axe.id }}</span>
                        {% else %}
                            <i class="fas fa-plus-circle me-2"></i>Skapa ny yxa
                            <span class="badge bg-secondary ms-2">ID: {{ next_id }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Notifikationssektion -->
                    <div id="notification" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="notification-message"></span>
                    </div>
                    
                    <form id="axeForm" method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturer.id_for_label }}" class="form-label">
                                        {{ form.manufacturer.label }}
                                    </label>
                                    {{ form.manufacturer }}
                                    {% if form.manufacturer.errors %}
                                        <div class="text-danger">{{ form.manufacturer.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">
                                        {{ form.model.label }}
                                    </label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Kontakthantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Försäljare/Kontakt
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig kontakt -->
                                <div class="mb-3">
                                    <label for="{{ form.contact_search.id_for_label }}" class="form-label">
                                        {{ form.contact_search.label }}
                                    </label>
                                    <div class="position-relative">
                                        {{ form.contact_search }}
                                        <div id="contactSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            <!-- Sökresultat visas här -->
                                        </div>
                                    </div>
                                    <div class="form-text">{{ form.contact_search.help_text }}</div>
                                    {% if form.contact_search.errors %}
                                        <div class="text-danger">{{ form.contact_search.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Ny kontakt (visas endast om sökning misslyckas) -->
                                <div id="newContactSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny kontakt</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.contact_name.id_for_label }}" class="form-label">
                                                    {{ form.contact_name.label }}
                                                </label>
                                                {{ form.contact_name }}
                                                <div class="form-text">{{ form.contact_name.help_text }}</div>
                                                {% if form.contact_name.errors %}
                                                    <div class="text-danger">{{ form.contact_name.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.contact_alias.id_for_label }}" class="form-label">
                                                    {{ form.contact_alias.label }}
                                                </label>
                                                {{ form.contact_alias }}
                                                <div class="form-text">{{ form.contact_alias.help_text }}</div>
                                                {% if form.contact_alias.errors %}
                                                    <div class="text-danger">{{ form.contact_alias.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.contact_email.id_for_label }}" class="form-label">
                                                    {{ form.contact_email.label }}
                                                </label>
                                                {{ form.contact_email }}
                                                <div class="form-text">{{ form.contact_email.help_text }}</div>
                                                {% if form.contact_email.errors %}
                                                    <div class="text-danger">{{ form.contact_email.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="{{ form.contact_phone.id_for_label }}" class="form-label">
                                                    {{ form.contact_phone.label }}
                                                </label>
                                                {{ form.contact_phone }}
                                                <div class="form-text">{{ form.contact_phone.help_text }}</div>
                                                {% if form.contact_phone.errors %}
                                                    <div class="text-danger">{{ form.contact_phone.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="{{ form.contact_comment.id_for_label }}" class="form-label">
                                            {{ form.contact_comment.label }}
                                        </label>
                                        {{ form.contact_comment }}
                                        <div class="form-text">{{ form.contact_comment.help_text }}</div>
                                        {% if form.contact_comment.errors %}
                                            <div class="text-danger">{{ form.contact_comment.errors }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="form-check">
                                        {{ form.is_naj_member }}
                                        <label class="form-check-label" for="{{ form.is_naj_member.id_for_label }}">
                                            {{ form.is_naj_member.label }}
                                        </label>
                                        <div class="form-text">{{ form.is_naj_member.help_text }}</div>
                                        {% if form.is_naj_member.errors %}
                                            <div class="text-danger">{{ form.is_naj_member.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Plattformshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>Plattform
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig plattform -->
                                <div class="mb-3">
                                    <label for="{{ form.platform_search.id_for_label }}" class="form-label">
                                        {{ form.platform_search.label }}
                                    </label>
                                    <div class="position-relative">
                                        {{ form.platform_search }}
                                        <div id="platformSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            <!-- Sökresultat visas här -->
                                        </div>
                                    </div>
                                    <div class="form-text">Börja skriva för att söka efter befintlig plattform eller skapa ny</div>
                                    {% if form.platform_search.errors %}
                                        <div class="text-danger">{{ form.platform_search.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Transaktionshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-money-bill me-2"></i>Transaktion
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3 position-relative">
                                            <label for="{{ form.transaction_price.id_for_label }}" class="form-label">
                                                {{ form.transaction_price.label }}
                                            </label>
                                            <div class="input-group">
                                                {{ form.transaction_price }}
                                                <span id="transaction-type-badge" class="input-group-text ms-2">
                                                    <!-- Badge placeras här av JS -->
                                                </span>
                                            </div>
                                        </div>
                                        <div class="form-text">{{ form.transaction_price.help_text }}</div>
                                        {% if form.transaction_price.errors %}
                                            <div class="text-danger">{{ form.transaction_price.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.transaction_shipping.id_for_label }}" class="form-label">
                                                {{ form.transaction_shipping.label }}
                                            </label>
                                            {{ form.transaction_shipping }}
                                            <div class="form-text">{{ form.transaction_shipping.help_text }}</div>
                                            {% if form.transaction_shipping.errors %}
                                                <div class="text-danger">{{ form.transaction_shipping.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">
                                        {{ form.transaction_date.label }}
                                    </label>
                                    {{ form.transaction_date }}
                                    <div class="form-text">{{ form.transaction_date.help_text }}</div>
                                    {% if form.transaction_date.errors %}
                                        <div class="text-danger">{{ form.transaction_date.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_comment.id_for_label }}" class="form-label">
                                        {{ form.transaction_comment.label }}
                                    </label>
                                    {{ form.transaction_comment }}
                                    <div class="form-text">{{ form.transaction_comment.help_text }}</div>
                                    {% if form.transaction_comment.errors %}
                                        <div class="text-danger">{{ form.transaction_comment.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Förbättrad bilduppladdning för mobil -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.images.label }}</label>
                            
                            <!-- Mobilvänliga knappar -->
                            <div class="d-flex flex-wrap gap-2 mb-3 mobile-upload-buttons">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openCamera()">
                                    <i class="fas fa-camera me-1"></i>Ta foto
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFiles()">
                                    <i class="fas fa-images me-1"></i>Välj bilder
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleUrlInput()">
                                    <i class="fas fa-link me-1"></i>Lägg till URL
                                </button>
                            </div>

                            <!-- Drag & drop område (dolt på mobil) -->
                            <div class="upload-area d-none d-md-block" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Dra och släpp bilder här</h5>
                                    <p class="text-muted">eller klicka för att välja filer</p>
                                    <p class="text-muted small">Du kan också klistra in bilder (Ctrl+V) eller dra URL:er från webbläsaren</p>
                                    {{ form.images }}
                                </div>
                            </div>

                            <!-- Dolda filinputs för mobil -->
                            <div class="d-none">
                                {{ form.images }}
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                                <input type="file" id="fileInput" accept="image/*" multiple>
                            </div>

                            <div class="form-text">{{ form.images.help_text }}</div>
                            {% if form.images.errors %}
                                <div class="text-danger">{{ form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- URL-input för bilder (kollapsbar) -->
                        <div class="mb-4" id="urlInputSection" style="display: none;">
                            <label for="imageUrl" class="form-label">Lägg till bild från URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/bild.jpg">
                                <button class="btn btn-outline-secondary" type="button" id="addUrlBtn">
                                    <i class="fas fa-plus"></i> Lägg till
                                </button>
                            </div>
                            <div class="form-text">Klistra in URL:er från Tradera, eBay eller andra sidor</div>
                        </div>

                        <!-- Befintliga bilder (endast i redigeringsläge) -->
                        {% if is_edit and axe.images.all %}
                            <div class="mb-4">
                                <h6>Befintliga bilder:</h6>
                                <div class="row" id="existingImagesContainer">
                                    {% for image in axe.images.all %}
                                        <div class="col-6 col-md-3 mb-3 existing-image-item" data-image-id="{{ image.id }}" draggable="true">
                                            <div class="card position-relative">
                                                <img src="{{ image.image.url }}" class="card-img-top" alt="Bild {{ forloop.counter }}" style="height: 150px; object-fit: cover;">
                                                <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removeExistingImage({{ image.id }})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <div class="card-body p-2">
                                                    <small class="text-muted">{{ image.description|default:"Bild" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div id="removedImagesContainer"></div>
                            </div>
                        {% endif %}

                        <!-- Förhandsvisning av nya bilder -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <h6>Förhandsvisning av nya bilder:</h6>
                            <div class="row" id="previewContainer"></div>
                        </div>

                        <!-- Flytta hiddenInputs hit, precis före knapparna -->
                        <div id="hiddenInputs"></div>

                        <!-- Måttsektion (endast i redigeringsläge) -->
                        {% if is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-ruler me-2"></i>Mått ({{ measurements.count }})
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Måttmallar -->
                                {% if measurement_templates %}
                                <div class="mb-3">
                                    <p class="text-muted small mb-2">Välj en mall för att snabbt lägga till vanliga mått:</p>
                                    <div class="d-flex flex-wrap">
                                        {% for template_name, template_measurements in measurement_templates.items %}
                                        <button class="btn btn-outline-primary btn-sm me-2 mb-2" 
                                                onclick="loadTemplate('{{ template_name }}')"
                                                title="{{ template_name }}: {{ template_measurements|length }} mått">
                                            <i class="fas fa-list me-1"></i>{{ template_name }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Manuellt tillägg av mått -->
                                <div class="measurement-form mb-3">
                                    <h6 class="mb-3">Lägg till nytt mått</h6>
                                    <form id="measurementForm" method="post" action="{% url 'add_measurement' axe.pk %}">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-4">
                                                {{ measurement_form.name.label_tag }}
                                                {{ measurement_form.name }}
                                                <div class="custom-field" id="custom-name-field">
                                                    {{ measurement_form.custom_name.label_tag }}
                                                    {{ measurement_form.custom_name }}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                {{ measurement_form.value.label_tag }}
                                                {{ measurement_form.value }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ measurement_form.unit.label_tag }}
                                                {{ measurement_form.unit }}
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="fas fa-plus me-1"></i>
                                                    <span class="d-none d-md-inline">Lägg till</span>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- Batch-måttformulär (dolt från början) -->
                                <div class="measurement-form mt-3" id="batchMeasurementFormContainer" style="display:none;">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Batch-läggning av mått:</strong> Fyll i värdena nedan och klicka "Lägg till alla" för att lägga till alla mått samtidigt. Måtten sparas direkt och visas i tabellen nedan.
                                    </div>
                                    <h6 class="mb-3">Lägg till flera mått från mall</h6>
                                    <form id="batchMeasurementForm" method="post" action="{% url 'add_measurements_from_template' axe.pk %}">
                                        {% csrf_token %}
                                        <div id="batchMeasurementRows"></div>
                                        <div class="text-end mt-2">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-plus me-1"></i>Lägg till alla mått
                                            </button>
                                            <button type="button" class="btn btn-link text-danger" onclick="hideBatchForm()">Avbryt</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Befintliga mått med inline-redigering -->
                                {% if measurements %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Måtttyp</th>
                                                <th>Värde</th>
                                                <th>Enhet</th>
                                                <th>Åtgärder</th>
                                            </tr>
                                        </thead>
                                        <tbody id="measurementsTableBody">
                                            {% for measurement in measurements %}
                                            <tr data-measurement-id="{{ measurement.id }}">
                                                <td>
                                                    <strong>{{ measurement.name }}</strong>
                                                </td>
                                                <td>
                                                    <input type="number" 
                                                           class="form-control form-control-sm measurement-value" 
                                                           value="{{ measurement.value }}" 
                                                           step="any" 
                                                           style="width: 80px;"
                                                           onchange="updateMeasurement({{ measurement.id }}, this.value, this.parentElement.nextElementSibling.querySelector('.measurement-unit').value)">
                                                </td>
                                                <td>
                                                    <input type="text" 
                                                           class="form-control form-control-sm measurement-unit" 
                                                           value="{{ measurement.unit }}" 
                                                           style="width: 60px;"
                                                           onchange="updateMeasurement({{ measurement.id }}, this.parentElement.previousElementSibling.querySelector('.measurement-value').value, this.value)">
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="deleteMeasurement({{ measurement.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted text-center py-3">
                                    <i class="fas fa-ruler fa-2x mb-2"></i><br>
                                    Inga mått registrerade än. Lägg till ditt första mått ovan.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between">
                            <a href="{% if is_edit %}{% url 'axe_detail' axe.pk %}{% else %}{% url 'axe_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Uppdatera yxa{% else %}Spara yxa{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: #f8f9fa;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-area input[type="file"] {
    display: none;
}

.preview-item {
    position: relative;
    margin-bottom: 1rem;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
}

.preview-item .remove-btn:hover {
    background: #c82333;
}

/* Måttsektion CSS */
.measurement-form {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.custom-field {
    display: none;
}

.custom-field.show {
    display: block;
}

.template-btn {
    margin: 0.25rem;
}

/* Mobiloptimeringar */
@media (max-width: 768px) {
    .mobile-upload-buttons {
        justify-content: center;
    }
    
    .mobile-upload-buttons .btn {
        flex: 1;
        min-width: 120px;
    }
    
    .preview-item {
        margin-bottom: 0.5rem;
    }
    
    .preview-item img {
        height: 120px;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation för URL-input */
.url-input-enter {
    animation: slideDown 0.3s ease-out;
}

.url-input-exit {
    animation: slideUp 0.3s ease-in;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

.overlay-remove-indicator {
    padding: 0.75rem !important;
    box-sizing: border-box;
}

.preview-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.preview-item:active {
    cursor: grabbing;
}

.preview-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.preview-item[draggable="true"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const cameraInput = document.getElementById('cameraInput');
    const selectFileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const imageUrlInput = document.getElementById('imageUrl');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const urlInputSection = document.getElementById('urlInputSection');
    const selectedItems = new Map(); // Map för att hålla reda på både filer och URL:er

    // Mobilvänliga funktioner
    window.openCamera = function() {
        cameraInput.click();
    };

    window.selectFiles = function() {
        selectFileInput.click();
    };

    window.toggleUrlInput = function() {
        if (urlInputSection.style.display === 'none') {
            urlInputSection.style.display = 'block';
            urlInputSection.classList.add('url-input-enter');
            imageUrlInput.focus();
        } else {
            urlInputSection.classList.add('url-input-exit');
            setTimeout(() => {
                urlInputSection.style.display = 'none';
                urlInputSection.classList.remove('url-input-exit');
            }, 300);
        }
    };

    // Kamerainput hantering
    cameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        cameraInput.value = '';
    });

    // Filval input hantering
    selectFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        selectFileInput.value = '';
    });

    // Drag & drop funktionalitet (endast desktop)
    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Hantera filer
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
            
            // Hantera URL:er (text)
            const text = e.dataTransfer.getData('text');
            if (text && isImageUrl(text)) {
                handleImageUrl(text);
            }
        });
    }

    // Filval via input
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
    }

    // Kontaktsökning
    const contactSearchInput = document.getElementById('{{ form.contact_search.id_for_label }}');
    const newContactSection = document.getElementById('newContactSection');
    const contactSearchResults = document.getElementById('contactSearchResults');
    let contactSearchTimeout;
    
    if (contactSearchInput) {
        contactSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            
            // Rensa tidigare timeout
            clearTimeout(contactSearchTimeout);
            
            if (searchValue.length >= 2) {
                // Debounce sökningen
                contactSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_contacts' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results.length > 0) {
                                // Visa dropdown med resultat
                                showContactResults(data.results);
                                newContactSection.style.display = 'none';
                            } else {
                                // Inga resultat, visa ny kontaktsektion
                                hideContactResults();
                                newContactSection.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            hideContactResults();
                            newContactSection.style.display = 'block';
                        });
                }, 300);
            } else {
                hideContactResults();
                newContactSection.style.display = 'none';
            }
        });
        
        // Visa ny kontaktsektion om användaren börjar skriva i namn-fältet
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        if (contactNameInput) {
            contactNameInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    hideContactResults();
                    newContactSection.style.display = 'block';
                }
            });
        }
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!contactSearchInput.contains(e.target) && !contactSearchResults.contains(e.target)) {
                hideContactResults();
            }
        });
    }
    
    function showContactResults(results) {
        contactSearchResults.innerHTML = '';
        results.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <div>
                    <strong>${contact.name}</strong>
                    ${contact.alias ? `<br><small class="text-muted">${contact.alias}</small>` : ''}
                    ${contact.email ? `<br><small class="text-muted">${contact.email}</small>` : ''}
                    ${contact.phone ? `<br><small class="text-muted">${contact.phone}</small>` : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                contactSearchInput.value = contact.name;
                hideContactResults();
                newContactSection.style.display = 'none';
            });
            contactSearchResults.appendChild(item);
        });
        contactSearchResults.style.display = 'block';
    }
    
    function hideContactResults() {
        contactSearchResults.style.display = 'none';
    }

    // Plattformssökning
    const platformSearchInput = document.getElementById('{{ form.platform_search.id_for_label }}');
    const platformSearchResults = document.getElementById('platformSearchResults');
    let platformSearchTimeout;
    
    if (platformSearchInput) {
        platformSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            
            // Rensa tidigare timeout
            clearTimeout(platformSearchTimeout);
            
            if (searchValue.length >= 2) {
                // Debounce sökningen
                platformSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_platforms' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            platformSearchResults.innerHTML = '';
                            if (data.results && data.results.length > 0) {
                                // Visa dropdown med resultat
                                data.results.forEach(platform => {
                                    const item = document.createElement('div');
                                    item.className = 'dropdown-item';
                                    item.innerHTML = `
                                        <div><strong>${platform.name}</strong></div>
                                    `;
                                    item.addEventListener('click', () => {
                                        platformSearchInput.value = platform.name;
                                        platformSearchResults.style.display = 'none';
                                    });
                                    platformSearchResults.appendChild(item);
                                });
                                platformSearchResults.style.display = 'block';
                            } else {
                                // Om ingen match, visa "Skapa ny"
                                platformSearchResults.innerHTML = `
                                    <div class="dropdown-item">
                                        <a href="#" class="text-decoration-none text-dark">
                                            <i class="fas fa-plus-circle me-1"></i> Skapa ny plattform: "${searchValue}"
                                        </a>
                                    </div>
                                `;
                                platformSearchResults.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            platformSearchResults.innerHTML = `
                                <div class="dropdown-item text-danger">
                                    Fel vid sökning: ${error.message}
                                </div>
                            `;
                            platformSearchResults.style.display = 'block';
                        });
                }, 300);
            } else {
                platformSearchResults.style.display = 'none';
            }
        });
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!platformSearchInput.contains(e.target) && !platformSearchResults.contains(e.target)) {
                platformSearchResults.style.display = 'none';
            }
        });
    }

    // Klistra in (Ctrl+V) - endast på desktop
    if (!isMobile()) {
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    handleFiles([file]);
                }
            }
            
            // Hantera klistrade URL:er
            const text = e.clipboardData.getData('text');
            if (text && isImageUrl(text)) {
                handleImageUrl(text);
            }
        });
    }

    // URL-knapp
    addUrlBtn.addEventListener('click', () => {
        const url = imageUrlInput.value.trim();
        if (url && isImageUrl(url)) {
            handleImageUrl(url);
            imageUrlInput.value = '';
        } else {
            alert('Vänligen ange en giltig bild-URL');
        }
    });

    // Enter i URL-fältet
    imageUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addUrlBtn.click();
        }
    });

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function isImageUrl(url) {
        return url.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i) || 
               url.includes('tradera.com') || 
               url.includes('ebay.com') ||
               url.includes('bilder') ||
               url.includes('image');
    }

    function handleFiles(files) {
        files.forEach(file => {
            if (file.type.startsWith('image/') && !selectedItems.has(file.name)) {
                selectedItems.set(file.name, { type: 'file', data: file });
                createPreview(file, file.name);
                
                // Lägg till filen i det faktiska formulärfältet
                const formFileInput = document.querySelector('input[name="images"]');
                if (formFileInput) {
                    // Skapa en ny FileList med den nya filen
                    const dt = new DataTransfer();
                    
                    // Lägg till befintliga filer
                    if (formFileInput.files) {
                        for (let i = 0; i < formFileInput.files.length; i++) {
                            dt.items.add(formFileInput.files[i]);
                        }
                    }
                    
                    // Lägg till den nya filen
                    dt.items.add(file);
                    
                    // Uppdatera input-fältet
                    formFileInput.files = dt.files;
                }
            }
        });
        
        updatePreviewVisibility();
    }

    function handleImageUrl(url) {
        const urlId = 'url_' + Date.now();
        if (!selectedItems.has(urlId)) {
            selectedItems.set(urlId, { type: 'url', data: url });
            createUrlPreview(url, urlId);
        }
        updatePreviewVisibility();
    }

    function createPreview(file, id) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewContainer = document.getElementById('imagePreview');
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item col-md-2 col-sm-3 col-6 mb-3';
            previewItem.draggable = true;
            previewItem.dataset.id = id;
            
            previewItem.innerHTML = `
                <div class="position-relative">
                    <img src="${e.target.result}" class="img-fluid rounded" style="height: 150px; width: 100%; object-fit: cover;" alt="Förhandsvisning">
                    <div class="position-absolute top-0 end-0 p-1">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePreview('${id}')" title="Ta bort bild">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="position-absolute bottom-0 start-0 w-100 p-1">
                        <small class="text-white bg-dark bg-opacity-75 rounded px-1">${id}</small>
                    </div>
                </div>
            `;
            
            // Lägg till drag & drop event listeners
            previewItem.addEventListener('dragstart', handleDragStart);
            previewItem.addEventListener('dragover', handleDragOver);
            previewItem.addEventListener('drop', handleDrop);
            previewItem.addEventListener('dragenter', handleDragEnter);
            previewItem.addEventListener('dragleave', handleDragLeave);
            
            previewContainer.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    }
    
    // Drag & drop funktioner för nya bilder
    let draggedPreviewElement = null;
    
    function handleDragStart(e) {
        draggedPreviewElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (draggedPreviewElement !== this) {
            const previewContainer = document.getElementById('imagePreview');
            const allItems = Array.from(previewContainer.children);
            const draggedIndex = allItems.indexOf(draggedPreviewElement);
            const dropIndex = allItems.indexOf(this);
            
            // Flytta elementet
            if (draggedIndex < dropIndex) {
                this.parentNode.insertBefore(draggedPreviewElement, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedPreviewElement, this);
            }
            
            // Uppdatera ordningen i formulärfältet
            updateFormFileOrder();
        }
        
        draggedPreviewElement.style.opacity = '1';
        draggedPreviewElement = null;
    }
    
    function updateFormFileOrder() {
        const previewContainer = document.getElementById('imagePreview');
        const formFileInput = document.querySelector('input[name="images"]');
        
        if (formFileInput) {
            const dt = new DataTransfer();
            const previewItems = Array.from(previewContainer.children);
            
            previewItems.forEach(item => {
                const id = item.dataset.id;
                const itemData = selectedItems.get(id);
                if (itemData && itemData.type === 'file') {
                    // Hitta filen i original FileList
                    for (let i = 0; i < formFileInput.files.length; i++) {
                        if (formFileInput.files[i].name === id) {
                            dt.items.add(formFileInput.files[i]);
                            break;
                        }
                    }
                }
            });
            
            formFileInput.files = dt.files;
        }
    }

    function createUrlPreview(url, id) {
        const previewItem = document.createElement('div');
        previewItem.className = 'col-6 col-md-3 preview-item';
        previewItem.innerHTML = `
            <img src="${url}" alt="Förhandsvisning" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QnJva2VuIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">
            <button type="button" class="remove-btn" onclick="removePreview('${id}')">
                <i class="fas fa-times"></i>
            </button>
            <div class="preview-info">
                <small class="text-muted">URL-bild</small>
            </div>
        `;
        previewContainer.appendChild(previewItem);
    }

    function updatePreviewVisibility() {
        if (selectedItems.size > 0) {
            imagePreview.style.display = 'block';
        } else {
            imagePreview.style.display = 'none';
        }
    }

    // Global funktion för att ta bort förhandsvisning
    window.removePreview = function(id) {
        const item = selectedItems.get(id);
        if (item && item.type === 'file') {
            // Ta bort filen från formulärfältet
            const formFileInput = document.querySelector('input[name="images"]');
            if (formFileInput) {
                const dt = new DataTransfer();
                for (let i = 0; i < formFileInput.files.length; i++) {
                    if (formFileInput.files[i].name !== id) {
                        dt.items.add(formFileInput.files[i]);
                    }
                }
                formFileInput.files = dt.files;
            }
        }
        
        selectedItems.delete(id);
        const previewItem = document.querySelector(`[onclick="removePreview('${id}')"]`).closest('.preview-item');
        previewItem.remove();
        updatePreviewVisibility();
    };

    // Lägg till drag & drop för befintliga bilder
    let draggedExistingElement = null; // Deklarera variabeln för befintliga bilder
    
    const existingImageItems = document.querySelectorAll('.existing-image-item');
    existingImageItems.forEach(item => {
        item.addEventListener('dragstart', handleExistingDragStart);
        item.addEventListener('dragover', handleExistingDragOver);
        item.addEventListener('drop', handleExistingDrop);
        item.addEventListener('dragenter', handleExistingDragEnter);
        item.addEventListener('dragleave', handleExistingDragLeave);
    });
    
    function handleExistingDragStart(e) {
        draggedExistingElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }
    
    function handleExistingDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleExistingDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }
    
    function handleExistingDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleExistingDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (draggedExistingElement !== this) {
            const container = document.getElementById('existingImagesContainer');
            const allItems = Array.from(container.children);
            const draggedIndex = allItems.indexOf(draggedExistingElement);
            const dropIndex = allItems.indexOf(this);
            
            // Flytta elementet
            if (draggedIndex < dropIndex) {
                this.parentNode.insertBefore(draggedExistingElement, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedExistingElement, this);
            }
            
            // Uppdatera ordningen i backend (skicka med i formuläret)
            updateExistingImageOrder();
        }
        
        draggedExistingElement.style.opacity = '1';
        draggedExistingElement = null;
    }
    
    function updateExistingImageOrder() {
        const container = document.getElementById('existingImagesContainer');
        const imageItems = Array.from(container.children);
        const orderData = imageItems.map((item, index) => ({
            id: item.dataset.imageId,
            order: index + 1
        }));
        
        console.log('Uppdaterar bildordning:', orderData); // Debug
        
        // Skapa dolda inputs för ordningen
        const hiddenInputs = document.getElementById('hiddenInputs');
        const existingOrderInputs = hiddenInputs.querySelectorAll('input[name="image_order"]');
        existingOrderInputs.forEach(input => input.remove());
        
        orderData.forEach(item => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'image_order';
            input.value = `${item.id}:${item.order}`;
            hiddenInputs.appendChild(input);
            console.log('Lagt till input:', input.value); // Debug
        });
    }

    // Hantera formulärsubmit
    document.getElementById('axeForm').addEventListener('submit', function(e) {
        const hiddenInputs = document.getElementById('hiddenInputs');
        hiddenInputs.innerHTML = ''; // Rensa ALLTID först!
        updateExistingImageOrder(); // Lägg till bildordning
        console.log('Submit-funktionen körs'); // DEBUG
        // Skapa dolda inputs för URL:er
        selectedItems.forEach((item, id) => {
            if (item.type === 'url') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'image_urls';
                input.value = item.data;
                hiddenInputs.appendChild(input);
            }
        });
        
        // Lägg till dolda inputs för borttagna bilder
        const removedImages = window.removedExistingImages || [];
        removedImages.forEach(imageId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'removed_images';
            input.value = imageId;
            hiddenInputs.appendChild(input);
        });
        
        // DEBUG: Skriv ut vad som finns i hiddenInputs
        console.log('hiddenInputs vid submit:', hiddenInputs.innerHTML);
    });
});

// Global funktion för att ta bort befintliga bilder
window.removeExistingImage = function(imageId) {
    if (confirm('Är du säker på att du vill ta bort denna bild?')) {
        const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
        if (imageItem) {
            // Lägg till i listan över borttagna bilder
            if (!window.removedExistingImages) {
                window.removedExistingImages = [];
            }
            window.removedExistingImages.push(imageId);
            
            // Dölj bilden (lägg till opacity och disabled state)
            imageItem.style.opacity = '0.5';
            imageItem.style.pointerEvents = 'none';
            
            // Lägg till en indikator för att bilden kommer att tas bort
            const card = imageItem.querySelector('.card');
            const removeIndicator = document.createElement('div');
            removeIndicator.className = 'position-absolute w-100 h-100 d-flex align-items-center justify-content-center overlay-remove-indicator';
            removeIndicator.style.cssText = 'top: 0; left: 0; background: rgba(220, 53, 69, 0.8); color: white; font-weight: bold; border-radius: 0.375rem; padding: 0.75rem; box-sizing: border-box;';
            removeIndicator.innerHTML = '<span>KOMMER ATT TAS BORT</span>';
            card.appendChild(removeIndicator);
        }
    }
};

function updateTransactionTypeBadge() {
    const priceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
    const badge = document.getElementById('transaction-type-badge');
    let value = parseFloat(priceInput.value.replace(',', '.'));
    if (isNaN(value)) {
        badge.innerHTML = '';
        return;
    }
    if (value < 0) {
        badge.innerHTML = '<span class="badge bg-danger"><i class="bi bi-arrow-down-circle me-1"></i>KÖP</span>';
    } else if (value > 0) {
        badge.innerHTML = '<span class="badge bg-success"><i class="bi bi-arrow-up-circle me-1"></i>SÄLJ</span>';
    } else {
        badge.innerHTML = '';
    }
}
document.addEventListener('DOMContentLoaded', function() {
    const priceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
    if (priceInput) {
        priceInput.addEventListener('input', updateTransactionTypeBadge);
        updateTransactionTypeBadge();
    }
});

// Notifikationsfunktion
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const messageSpan = document.getElementById('notification-message');
    
    // Ta bort tidigare klasser
    notification.className = 'alert';
    
    // Lägg till rätt klass och ikon
    if (type === 'success') {
        notification.classList.add('alert-success');
        messageSpan.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
    } else if (type === 'error') {
        notification.classList.add('alert-danger');
        messageSpan.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
    } else if (type === 'warning') {
        notification.classList.add('alert-warning');
        messageSpan.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
    }
    
    // Visa notifikationen
    notification.style.display = 'block';
    
    // Scrolla till notifikationen
    notification.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Dölj efter 3 sekunder
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Hantera formulärsubmit
document.getElementById('axeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    // Visa laddningsindikator
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sparar...';
    submitButton.disabled = true;
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            // Om vi får en redirect, följ den
            window.location.href = response.url;
            return;
        }
        return response.text();
    })
    .then(data => {
        if (data) {
            // Om vi fick data tillbaka, visa notifikation
            showNotification('Yxan har uppdaterats framgångsrikt!', 'success');
            
            // Återställ knappen
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ett fel uppstod vid uppdatering av yxan.', 'error');
        
        // Återställ knappen
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
});

{% if is_edit %}
// Måttfunktionalitet (endast i redigeringsläge)
const measurementTemplates = {{ measurement_templates|safe }};

function loadTemplate(templateName) {
    const template = measurementTemplates[templateName];
    if (!template) {
        alert(`Mall "${templateName}" hittades inte.`);
        return;
    }
    // Visa batchformuläret
    const container = document.getElementById('batchMeasurementFormContainer');
    const rows = document.getElementById('batchMeasurementRows');
    rows.innerHTML = '';
    template.forEach((m, idx) => {
        rows.innerHTML += `
            <div class="row mb-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Måttyp</label>
                    <input type="text" class="form-control" name="measurements[${idx}][name]" value="${m.name}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Värde</label>
                    <input type="number" step="any" class="form-control" name="measurements[${idx}][value]" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Enhet</label>
                    <input type="text" class="form-control" name="measurements[${idx}][unit]" value="${m.unit}" required>
                </div>
            </div>
        `;
    });
    container.style.display = '';
    // Scrolla till formuläret
    container.scrollIntoView({behavior: 'smooth'});
}

function hideBatchForm() {
    document.getElementById('batchMeasurementFormContainer').style.display = 'none';
}

function updateMeasurement(measurementId, value, unit) {
    const formData = new FormData();
    formData.append('value', value);
    formData.append('unit', unit);
    
    fetch(`/yxor/{{ axe.pk }}/matt/${measurementId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Visa bekräftelse
            const row = document.querySelector(`[data-measurement-id="${measurementId}"]`);
            if (row) {
                row.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
            showNotification('Måttet har uppdaterats!', 'success');
        } else {
            showNotification('Fel vid uppdatering av mått: ' + (data.error || 'Okänt fel'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fel vid uppdatering av mått', 'error');
    });
}

function deleteMeasurement(measurementId) {
    if (!confirm('Är du säker på att du vill ta bort detta mått?')) return;
    
    // Hitta raden som ska tas bort
    const row = document.querySelector(`[data-measurement-id="${measurementId}"]`);
    if (!row) {
        showNotification('Kunde inte hitta måttet att ta bort', 'error');
        return;
    }
    
    fetch(`/yxor/{{ axe.pk }}/matt/${measurementId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ta bort raden från DOM med en snygg animation
            row.style.transition = 'all 0.3s ease';
            row.style.opacity = '0';
            row.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                row.remove();
                showNotification('Måttet har tagits bort!', 'success');
            }, 300);
        } else {
            showNotification('Fel vid borttagning av mått: ' + (data.error || 'Okänt fel'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Fel vid borttagning av mått', 'error');
    });
}

// Hantera batchformulär submit
if (document.getElementById('batchMeasurementForm')) {
    document.getElementById('batchMeasurementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);
        
        // Visa laddningsindikator på knappen
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Lägger till mått...';
        submitBtn.disabled = true;
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Räkna hur många mått som lades till
                const formRows = form.querySelectorAll('input[name*="[value]"]');
                const addedCount = formRows.length;
                showNotification(`${addedCount} mått har lagts till framgångsrikt!`, 'success');
                // Ladda om sidan efter 2 sekunder så att notifikationen hinner visas
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Fel vid tillägg av mått: ' + (data.error || 'Okänt fel'), 'error');
                // Återställ knappen vid fel
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Fel vid tillägg av mått', 'error');
            // Återställ knappen vid fel
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

// Hantera måttformulär
if (document.getElementById('measurementForm')) {
    document.getElementById('measurementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const formData = new FormData(form);
        
        // Visa laddningsindikator på knappen
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Lägger till mått...';
        submitBtn.disabled = true;
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Mått har lagts till framgångsrikt!', 'success');
                // Ladda om sidan efter 2 sekunder så att notifikationen hinner visas
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('Fel vid tillägg av mått: ' + (data.error || 'Okänt fel'), 'error');
                // Återställ knappen vid fel
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Fel vid tillägg av mått', 'error');
            // Återställ knappen vid fel
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

// Hantera anpassade fält
const nameSelect = document.getElementById('measurement-name');
const unitInput = document.getElementById('measurement-unit');
const customNameField = document.getElementById('custom-name-field');

if (nameSelect) {
    nameSelect.addEventListener('change', function() {
        if (this.value === 'Övrigt') {
            customNameField.classList.add('show');
        } else {
            customNameField.classList.remove('show');
            
            // Automatiskt fylla i enheten om det är en fördefinierad måtttyp
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.textContent.includes('(')) {
                const unitMatch = selectedOption.textContent.match(/\(([^)]+)\)/);
                if (unitMatch) {
                    unitInput.value = unitMatch[1];
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %} 