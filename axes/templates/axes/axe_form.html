{% extends 'axes/base.html' %}
{% load static %}
{% load axe_filters %}

{% block title %}{% if is_edit %}Redigera yxa{% else %}Skapa ny yxa{% endif %}{% endblock %}

{% block extra_head %}
{% if axe.pk %}
<script>
window.axeId = {{ axe.pk }};
window.measurementTemplates = {{ measurement_templates|safe }};
</script>
{% else %}
<script>
window.axeId = null;
window.measurementTemplates = {{ measurement_templates|safe }};
</script>
{% endif %}
<script src="{% static 'js/measurement_templates.js' %}"></script>
<style>
/* Tvinga dropdown direkt under inputfältet */
.position-relative .dropdown-menu {
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin-top: 0 !important;
}

/* Custom field för måttformulär */
.custom-field {
    display: none;
    margin-top: 10px;
}
.custom-field.show {
    display: block !important;
}

/* Inline redigering av mått */
tr.editing {
    background-color: #fff3cd;
    border: 2px solid #ffecb3;
}

tr.editing td {
    padding: 8px !important;
}

tr.editing .form-control-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        {% if is_edit %}
                            <i class="fas fa-edit me-2"></i>Redigera yxa
                            <span class="badge bg-secondary ms-2">ID: {{ axe.id }}</span>
                        {% else %}
                            <i class="fas fa-plus-circle me-2"></i>Skapa ny yxa
                            <span class="badge bg-secondary ms-2">ID: {{ next_id }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Notifikationssektion -->
                    <div id="notification" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="notification-message"></span>
                    </div>
                    
                    <form id="axeForm" method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturer.id_for_label }}" class="form-label">
                                        {{ form.manufacturer.label }}
                                    </label>
                                    {{ form.manufacturer }}
                                    {% if form.manufacturer.errors %}
                                        <div class="text-danger">{{ form.manufacturer.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">
                                        {{ form.model.label }}
                                    </label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Kontakthantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Försäljare/Kontakt
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig kontakt -->
                                <div class="position-relative">
                                    {% include 'axes/_form_field.html' with field=form.contact_search %}
                                    <!-- Dropdown för sökresultat -->
                                    <div id="contactSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny kontakt (visas endast om sökning misslyckas) -->
                                <div id="newContactSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny kontakt</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_name %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_alias %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_email %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_phone %}
                                        </div>
                                    </div>
                                    {% include 'axes/_form_field.html' with field=form.contact_comment %}
                                    {% include 'axes/_form_checkbox.html' with field=form.is_naj_member %}
                                    
                                    <!-- Adressfält för ny kontakt -->
                                    <hr class="my-3">
                                    <h6 class="text-muted">Adress (valfritt)</h6>
                                    {% include 'axes/_form_field.html' with field=form.contact_street %}
                                    <div class="row">
                                        <div class="col-md-4">
                                            {% include 'axes/_form_field.html' with field=form.contact_postal_code %}
                                        </div>
                                        <div class="col-md-8">
                                            {% include 'axes/_form_field.html' with field=form.contact_city %}
                                        </div>
                                    </div>
                                    {% include 'axes/_form_field.html' with field=form.contact_country_code %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Plattformshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>Plattform
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig plattform -->
                                <div class="position-relative">
                                    {% include 'axes/_form_field.html' with field=form.platform_search %}
                                    <!-- Dropdown för sökresultat -->
                                    <div id="platformSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny plattform (visas endast om sökning misslyckas) -->
                                <div id="newPlatformSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny plattform</h6>
                                    {% include 'axes/_form_field.html' with field=form.platform_name %}
                                    {% include 'axes/_form_field.html' with field=form.platform_url %}
                                    {% include 'axes/_form_field.html' with field=form.platform_comment %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Transaktionshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-money-bill me-2"></i>Transaktion
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% include 'axes/_form_input_group.html' with field=form.transaction_price addon_after='<span id="transaction-type-badge" class="input-group-text ms-2"></span>' %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.transaction_shipping.id_for_label }}" class="form-label">
                                                {{ form.transaction_shipping.label }}
                                            </label>
                                            {{ form.transaction_shipping }}
                                            <div class="form-text">{{ form.transaction_shipping.help_text }}</div>
                                            {% if form.transaction_shipping.errors %}
                                                <div class="text-danger">{{ form.transaction_shipping.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">
                                        {{ form.transaction_date.label }}
                                    </label>
                                    {{ form.transaction_date }}
                                    <div class="form-text">{{ form.transaction_date.help_text }}</div>
                                    {% if form.transaction_date.errors %}
                                        <div class="text-danger">{{ form.transaction_date.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_comment.id_for_label }}" class="form-label">
                                        {{ form.transaction_comment.label }}
                                    </label>
                                    {{ form.transaction_comment }}
                                    <div class="form-text">{{ form.transaction_comment.help_text }}</div>
                                    {% if form.transaction_comment.errors %}
                                        <div class="text-danger">{{ form.transaction_comment.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Förbättrad bilduppladdning för mobil -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.images.label }}</label>
                            
                            <!-- Mobilvänliga knappar -->
                            <div class="d-flex flex-wrap gap-2 mb-3 mobile-upload-buttons">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openCamera()">
                                    <i class="fas fa-camera me-1"></i>Ta foto
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFiles()">
                                    <i class="fas fa-images me-1"></i>Välj bilder
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleUrlInput()">
                                    <i class="fas fa-link me-1"></i>Lägg till URL
                                </button>
                            </div>

                            <!-- Drag & drop område (dolt på mobil) -->
                            <div class="upload-area d-none d-md-block" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Dra och släpp bilder här</h5>
                                    <p class="text-muted">eller klicka för att välja filer</p>
                                    <p class="text-muted small">Du kan också klistra in bilder (Ctrl+V) eller dra URL:er från webbläsaren</p>
                                    {{ form.images }}
                                </div>
                            </div>

                            <!-- Dolda filinputs för mobil -->
                            <div class="d-none">
                                {{ form.images }}
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                                <input type="file" id="fileInput" accept="image/*" multiple>
                            </div>

                            <div class="form-text">{{ form.images.help_text }}</div>
                            {% if form.images.errors %}
                                <div class="text-danger">{{ form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- URL-input för bilder (kollapsbar) -->
                        <div class="mb-4" id="urlInputSection" style="display: none;">
                            <label for="imageUrl" class="form-label">Lägg till bild från URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/bild.jpg">
                                <button class="btn btn-outline-secondary" type="button" id="addUrlBtn">
                                    <i class="fas fa-plus"></i> Lägg till
                                </button>
                            </div>
                            <div class="form-text">Klistra in URL:er från Tradera, eBay eller andra sidor</div>
                        </div>

                        <!-- Befintliga bilder (endast i redigeringsläge) -->
                        {% if is_edit and axe.images.all %}
                            <div class="mb-4">
                                <h6>Befintliga bilder:</h6>
                                <div class="row" id="existingImagesContainer">
                                    {% for image in axe.images.all %}
                                        <div class="col-6 col-md-3 mb-3 existing-image-item" data-image-id="{{ image.id }}" draggable="true">
                                            <div class="card position-relative">
                                                <img src="{{ image.image.url }}" class="card-img-top" alt="Bild {{ forloop.counter }}" style="height: 150px; object-fit: cover;">
                                                <div class="position-absolute" style="top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                                    {{ image.image.name|basename }}
                                                </div>
                                                <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removeExistingImage({{ image.id }})">
                                                    <i class="fas fa-times"></i>
                                                </button>

                                                <div class="card-body p-2">
                                                    <small class="text-muted">{{ image.description|default:"Bild" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div id="removedImagesContainer"></div>
                            </div>
                        {% endif %}

                        <!-- Förhandsvisning av nya bilder -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <h6>Förhandsvisning av nya bilder:</h6>
                            <div class="row" id="previewContainer"></div>
                        </div>

                        <!-- Flytta hiddenInputs hit, precis före knapparna -->
                        <div id="hiddenInputs"></div>
                        <div class="d-flex justify-content-between">
                            <a href="{% if is_edit %}{% url 'axe_detail' axe.pk %}{% else %}{% url 'axe_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitButton">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Uppdatera yxa{% else %}Spara yxa{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Måttsektion (endast i redigeringsläge) - Flyttad utanför axeForm -->
{% if is_edit %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-ruler me-2"></i>Mått (<span class="measurement-count">{{ measurements.count }}</span>)
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Måttmallar -->
                    {% if measurement_templates %}
                    <div class="mb-3">
                        <p class="text-muted small mb-2">Välj en mall för att snabbt lägga till vanliga mått:</p>
                        <div class="d-flex flex-wrap">
                            {% for template_name, template_measurements in measurement_templates.items %}
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 template-btn" 
                                    data-template="{{ template_name }}"
                                    title="{{ template_name }}: {{ template_measurements|length }} mått">
                                <i class="fas fa-list me-1"></i>{{ template_name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Manuellt tillägg av mått -->
                    <div class="measurement-form mb-3">
                        <h6 class="mb-3">Lägg till nytt mått</h6>
                        <form id="measurementForm" method="post" action="{% url 'add_measurement' axe.pk %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-3">
                                    {{ measurement_form.name.label_tag }}
                                    {{ measurement_form.name }}
                                    <div class="custom-field" id="custom-name-field">
                                        {{ measurement_form.custom_name.label_tag }}
                                        {{ measurement_form.custom_name }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    {{ measurement_form.value.label_tag }}
                                    {{ measurement_form.value }}
                                </div>
                                <div class="col-md-5">
                                    {{ measurement_form.unit_option.label_tag }}
                                    <div class="mb-2">
                                        <div class="btn-group w-100" role="group" aria-label="Välj enhet">
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_mm" value="mm" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_mm">mm</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_gram" value="gram" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_gram">gram</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_grader" value="grader" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_grader">grader</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_ovrig" value="ovrig" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_ovrig">Övrig</label>
                                        </div>
                                    </div>
                                    {{ measurement_form.unit }}
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-1"></i>
                                        <span class="d-none d-md-inline">Lägg till</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Batch-måttformulär (dolt från början) -->
                    <div class="measurement-form mt-3" id="batchMeasurementFormContainer" style="display:none;">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Batch-läggning av mått:</strong> Fyll i värdena nedan och klicka "Lägg till alla" för att lägga till alla mått samtidigt. Måtten sparas direkt och visas i tabellen nedan.
                        </div>
                        <h6 class="mb-3">Lägg till flera mått från mall</h6>
                        <form id="batchMeasurementForm" method="post" action="{% url 'add_measurements_from_template' axe.pk %}">
                            {% csrf_token %}
                            <div id="batchMeasurementRows"></div>
                            <div class="text-end mt-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>Lägg till mått
                                </button>
                                <button type="button" class="btn btn-link text-danger" data-action="hideBatchForm">Avbryt</button>
                            </div>
                        </form>
                    </div>

                    <!-- Befintliga mått med inline-redigering -->
                    <div class="table-responsive measurement-list" {% if not measurements %}style="display:none;"{% endif %}>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Måtttyp</th>
                                    <th>Värde</th>
                                    <th>Enhet</th>
                                    <th>Åtgärder</th>
                                </tr>
                            </thead>
                            <tbody id="measurementsTableBody">
                                {% for measurement in measurements %}
                                <tr data-measurement-id="{{ measurement.id }}">
                                    <td class="measurement-name">{{ measurement.name }}</td>
                                    <td class="measurement-value">{{ measurement.value|format_decimal }}</td>
                                    <td class="measurement-unit">{{ measurement.unit }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-edit-measurement" 
                                                    data-measurement-id="{{ measurement.id }}"
                                                    data-name="{{ measurement.name }}"
                                                    data-value="{{ measurement.value|format_decimal }}"
                                                    data-unit="{{ measurement.unit }}"
                                                    title="Redigera mått">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-delete-measurement" 
                                                    data-measurement-id="{{ measurement.id }}"
                                                    title="Ta bort mått">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="measurement-empty-state text-center py-3" {% if measurements %}style="display:none;"{% endif %}>
                        <i class="fas fa-ruler fa-2x mb-2"></i><br>
                        <p class="text-muted">Inga mått registrerade än. Lägg till ditt första mått ovan.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.upload-area {
    border: 2px dashed var(--bs-border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: var(--bs-secondary-bg);
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
}

.upload-area input[type="file"] {
    display: none;
}

.preview-item {
    position: relative;
    margin-bottom: 1rem;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
}

.preview-item .remove-btn:hover {
    background: #c82333;
}

/* Måttsektion CSS */
.measurement-form {
    background-color: var(--bs-secondary-bg);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}



.template-btn {
    margin: 0.25rem;
}

/* Mobiloptimeringar */
@media (max-width: 768px) {
    .mobile-upload-buttons {
        justify-content: center;
    }
    
    .mobile-upload-buttons .btn {
        flex: 1;
        min-width: 120px;
    }
    
    .preview-item {
        margin-bottom: 0.5rem;
    }
    
    .preview-item img {
        height: 120px;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation för URL-input */
.url-input-enter {
    animation: slideDown 0.3s ease-out;
}

.url-input-exit {
    animation: slideUp 0.3s ease-in;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

.overlay-remove-indicator {
    padding: 0.75rem !important;
    box-sizing: border-box;
}

.preview-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.preview-item:active {
    cursor: grabbing;
}

.preview-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.preview-item[draggable="true"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Drag & drop för befintliga bilder */
.existing-image-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.existing-image-item:active {
    cursor: grabbing;
}

.existing-image-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.existing-image-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.existing-image-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // === GLOBALA FUNKTIONER ===
    
    // === TA BORT BILD (flera bilder) ===
    window.removeExistingImage = function(imageId) {
        if (confirm('Är du säker på att du vill ta bort denna bild?')) {
    
            // Lägg till en dold input för att markera bilden som borttagen
            const hiddenInputs = document.getElementById('hiddenInputs');
            if (hiddenInputs) {
                // Kontrollera om denna bild redan är markerad för borttagning
                const existingInputs = hiddenInputs.querySelectorAll(`input[name="remove_images"][value="${imageId}"]`);
                if (existingInputs.length === 0) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'remove_images';
                    hiddenInput.value = imageId;
                    hiddenInputs.appendChild(hiddenInput);
                }
            }
            // Ta bort bilden från DOM
            const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imageElement) {
                imageElement.remove();
                // Visa notifikation
                showNotification('Bild markerad för borttagning', 'success');
            }
        }
    };

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const cameraInput = document.getElementById('cameraInput');
    const selectFileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const imageUrlInput = document.getElementById('imageUrl');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const urlInputSection = document.getElementById('urlInputSection');
    const selectedItems = new Map(); // Map för att hålla reda på både filer och URL:er

    // Mobilvänliga funktioner
    window.openCamera = function() {
        cameraInput.click();
    };

    window.selectFiles = function() {
        selectFileInput.click();
    };

    window.toggleUrlInput = function() {
        if (!urlInputSection) {
            return;
        }
        
        if (urlInputSection.style.display === 'none' || urlInputSection.style.display === '') {
            urlInputSection.style.display = 'block';
            urlInputSection.classList.add('url-input-enter');
            if (imageUrlInput) {
                imageUrlInput.focus();
            }
        } else {
            urlInputSection.classList.add('url-input-exit');
            setTimeout(() => {
                urlInputSection.style.display = 'none';
                urlInputSection.classList.remove('url-input-exit');
            }, 300);
        }
    };

    // Kamerainput hantering
    cameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        cameraInput.value = '';
    });

    // Filval input hantering
    selectFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        selectFileInput.value = '';
    });

    // Drag & drop funktionalitet (endast desktop)
    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Hantera filer
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
            
            // Hantera URL:er - testa olika format
            let urlText = e.dataTransfer.getData('text');
            if (!urlText) {
                urlText = e.dataTransfer.getData('url');
            }
            if (!urlText) {
                // Försök extrahera URL från HTML
                const html = e.dataTransfer.getData('text/html');
                if (html) {
                    const urlMatch = html.match(/href=["']([^"']+)["']/);
                    if (urlMatch) {
                        urlText = urlMatch[1];
                    }
                }
            }
            
            if (urlText && isImageUrl(urlText)) {
                handleImageUrl(urlText);
            }
        });
    }

    // Filval via input
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
    }

    // Bilduppladdningsfunktioner
    function handleFiles(files) {
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addImagePreview(file, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function handleImageUrl(url) {
        if (isImageUrl(url)) {
            addImagePreview(null, url, url);
        }
    }

    function isImageUrl(text) {
        // Kontrollera om det är en giltig URL
        try {
            const url = new URL(text);
        } catch (e) {
            return false;
        }
        
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
        const url = text.toLowerCase();
        const hasImageExtension = imageExtensions.some(ext => url.includes(ext));
        const isKnownSite = url.includes('tradera.com') || 
                           url.includes('ebay.com') ||
                           url.includes('blocket.se') ||
                           url.includes('facebook.com') ||
                           url.includes('instagram.com');
        
        return hasImageExtension || isKnownSite;
    }

    function addImagePreview(file, dataUrl, url = null) {
        
        const previewDiv = document.createElement('div');
        previewDiv.className = 'col-6 col-md-3 mb-3 preview-item';
        
        // För URL-bilder, försök ladda ner och visa bilden
        if (url && !file) {
            // Lägg till previewDiv i containern först
            previewContainer.appendChild(previewDiv);
            imagePreview.style.display = 'block';
            
            // Visa en laddningsindikator medan vi försöker ladda bilden
            previewDiv.innerHTML = `
                <div class="card position-relative">
                                            <div class="text-center p-3" style="background: var(--bs-secondary-bg); height: 150px; display: flex; align-items: center; justify-content: center;">
                        <div>
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                            <br><small class="text-muted">Laddar bild...</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Skapa en temporär img-element för att testa om bilden kan laddas
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            
            tempImg.onload = function() {
                // Bilden laddades framgångsrikt, visa den
                previewDiv.innerHTML = `
                    <div class="card position-relative">
                        <img src="${url}" class="card-img-top" alt="URL-förhandsvisning" style="height: 150px; object-fit: cover;" crossorigin="anonymous">
                        <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-body p-2">
                            <small class="text-muted">URL-bild</small>
                        </div>
                    </div>
                `;
            };
            
            tempImg.onerror = function() {
                // Bilden kunde inte laddas, visa fallback
                previewDiv.innerHTML = `
                    <div class="card position-relative">
                        <div class="text-center p-3" style="background: var(--bs-secondary-bg); height: 150px; display: flex; align-items: center; justify-content: center;">
                            <div>
                                <i class="fas fa-link fa-2x text-muted mb-2"></i>
                                <br><small class="text-muted">URL-bild</small>
                                <br><small class="text-muted">Kommer att laddas på servern</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-body p-2">
                            <small class="text-muted">${url}</small>
                        </div>
                    </div>
                `;
            };
            
            // Starta laddningen
            tempImg.src = url;
        } else {
            previewDiv.innerHTML = `
                <div class="card position-relative">
                    <img src="${dataUrl}" class="card-img-top" alt="Förhandsvisning" style="height: 150px; object-fit: cover;">
                    <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="card-body p-2">
                        <small class="text-muted">${file ? file.name : 'URL-bild'}</small>
                    </div>
                </div>
            `;
        }
        
        // Spara referens till fil eller URL
        const itemId = Date.now() + Math.random();
        selectedItems.set(itemId, { file, url, element: previewDiv });
        previewDiv.dataset.itemId = itemId;
        
        // Lägg till previewDiv i containern (endast för filer, URL:er hanteras separat)
        if (!url || file) {
            previewContainer.appendChild(previewDiv);
            imagePreview.style.display = 'block';
        }
    }

    window.removePreview = function(button) {
        const previewItem = button.closest('.preview-item');
        const itemId = previewItem.dataset.itemId;
        selectedItems.delete(itemId);
        previewItem.remove();
        
        if (previewContainer.children.length === 0) {
            imagePreview.style.display = 'none';
        }
    };

    // Kontaktsökning
    const contactSearchInput = document.getElementById('{{ form.contact_search.id_for_label }}');
    const newContactSection = document.getElementById('newContactSection');
    const contactSearchResults = document.getElementById('contactSearchResults');
    let contactSearchTimeout;
    
    if (contactSearchInput) {
        contactSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            
            // Rensa tidigare timeout
            clearTimeout(contactSearchTimeout);
            
            if (searchValue.length >= 2) {
                // Debounce sökningen
                contactSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_contacts' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results.length > 0) {
                                // Visa dropdown med resultat
                                showContactResults(data.results);
                                newContactSection.style.display = 'none';
                            } else {
                                // Inga resultat, visa ny kontaktsektion
                                hideContactResults();
                                showNewContactSection(searchValue);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            hideContactResults();
                            showNewContactSection(searchValue);
                        });
                }, 300);
            } else {
                hideContactResults();
                newContactSection.style.display = 'none';
            }
        });
        
        // Visa ny kontaktsektion om användaren börjar skriva i namn-fältet
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        if (contactNameInput) {
            contactNameInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    hideContactResults();
                    showNewContactSection(this.value.trim());
                }
            });
        }
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!contactSearchInput.contains(e.target) && !contactSearchResults.contains(e.target)) {
                hideContactResults();
            }
        });
    }
    
    function showContactResults(results) {
        contactSearchResults.innerHTML = '';
        results.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <div>
                    <strong>${contact.name}</strong>
                    ${contact.alias ? `<br><small class="text-muted">${contact.alias}</small>` : ''}
                    ${contact.email ? `<br><small class="text-muted">${contact.email}</small>` : ''}
                    ${contact.phone ? `<br><small class="text-muted">${contact.phone}</small>` : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                contactSearchInput.value = contact.name;
                hideContactResults();
                const newContactSection = document.getElementById('newContactSection');
                if (newContactSection) {
                    newContactSection.style.display = 'none';
                }
            });
            contactSearchResults.appendChild(item);
        });
        contactSearchResults.style.display = 'block';
    }
    
    function hideContactResults() {
        contactSearchResults.style.display = 'none';
    }
    
    // Funktioner för att visa/dölja sektioner för nya kontakter och plattformar
    function showNewContactSection(searchValue = '') {
        hideContactResults();
        const newContactSection = document.getElementById('newContactSection');
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        
        if (newContactSection) {
            newContactSection.style.display = 'block';
        }
        
        if (contactNameInput && searchValue) {
            contactNameInput.value = searchValue;
        }
    }
    
    window.showNewPlatformSection = function(searchValue = '') {
        const platformSearchResults = document.getElementById('platformSearchResults');
        const newPlatformSection = document.getElementById('newPlatformSection');
        const platformNameInput = document.getElementById('{{ form.platform_name.id_for_label }}');
        const platformUrlInput = document.getElementById('{{ form.platform_url.id_for_label }}');
        const platformCommentInput = document.getElementById('{{ form.platform_comment.id_for_label }}');
        
        if (platformSearchResults) {
            platformSearchResults.style.display = 'none';
        }
        
        if (newPlatformSection) {
            newPlatformSection.style.display = 'block';
        }
        
        if (platformNameInput) {
            platformNameInput.value = searchValue;
            platformNameInput.focus();
        }
        if (platformUrlInput) {
            platformUrlInput.value = '';
        }
        if (platformCommentInput) {
            platformCommentInput.value = '';
        }
    };

    // Plattformssökning
    const platformSearchInput = document.getElementById('{{ form.platform_search.id_for_label }}');
    const platformSearchResults = document.getElementById('platformSearchResults');
    let platformSearchTimeout;
    
    if (platformSearchInput) {
        platformSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            clearTimeout(platformSearchTimeout);
            if (searchValue.length >= 2) {
                platformSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_platforms' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            platformSearchResults.innerHTML = '';
                            if (data.results && data.results.length > 0) {
                                // Visa dropdown med resultat
                                data.results.forEach(platform => {
                                    const item = document.createElement('div');
                                    item.className = 'dropdown-item';
                                    item.innerHTML = `<div><strong>${platform.name}</strong></div>`;
                                    item.addEventListener('click', () => {
                                        platformSearchInput.value = platform.name;
                                        platformSearchResults.style.display = 'none';
                                        const newPlatformSection = document.getElementById('newPlatformSection');
                                        if (newPlatformSection) {
                                            newPlatformSection.style.display = 'none';
                                        }
                                    });
                                    platformSearchResults.appendChild(item);
                                });
                                platformSearchResults.style.display = 'block';
                            } else {
                                // Om ingen match, visa "Skapa ny"
                                const newId = 'showNewPlatformLink_' + Date.now();
                                platformSearchResults.innerHTML = `
                                    <div class="dropdown-item">
                                        <a href="#" class="text-decoration-none text-dark" id="${newId}">
                                            <i class="fas fa-plus-circle me-1"></i> Skapa ny plattform: "${searchValue}"
                                        </a>
                                    </div>
                                `;
                                platformSearchResults.style.display = 'block';
                                setTimeout(() => {
                                    const link = document.getElementById(newId);
                                    if (link) {
                                        link.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            showNewPlatformSection(searchValue);
                                        });
                                    }
                                }, 0);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            platformSearchResults.innerHTML = `
                                <div class="dropdown-item text-danger">
                                    Fel vid sökning: ${error.message}
                                </div>
                            `;
                            platformSearchResults.style.display = 'block';
                        });
                }, 300);
            } else {
                platformSearchResults.style.display = 'none';
            }
        });
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!platformSearchInput.contains(e.target) && !platformSearchResults.contains(e.target)) {
                platformSearchResults.style.display = 'none';
            }
        });
    }

    // === DRAG & DROP FÖR BEFINTLIGA BILDER ===
    const existingImagesContainer = document.getElementById('existingImagesContainer');
    let draggedExisting = null;

    if (existingImagesContainer) {
        existingImagesContainer.querySelectorAll('.existing-image-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedExisting = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedExisting = null;
            });
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedExisting && draggedExisting !== this) {
                    // Flytta elementet i DOM
                    if (Array.from(existingImagesContainer.children).indexOf(draggedExisting) < Array.from(existingImagesContainer.children).indexOf(this)) {
                        this.after(draggedExisting);
                    } else {
                        this.before(draggedExisting);
                    }
                }
            });
        });
    }



    // URL-hantering
    if (addUrlBtn && imageUrlInput) {
        addUrlBtn.addEventListener('click', () => {
            const url = imageUrlInput.value.trim();
            if (url) {
                handleImageUrl(url);
                imageUrlInput.value = '';
                // Visa notifikation
                showNotification('URL-bild tillagd', 'success');
            } else {
                showNotification('Ange en giltig URL', 'error');
            }
        });

        imageUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addUrlBtn.click();
            }
        });
        
        // Lägg till paste-hantering för URL-input
        imageUrlInput.addEventListener('paste', (e) => {
            setTimeout(() => {
                const pastedText = imageUrlInput.value.trim();
                if (pastedText && isImageUrl(pastedText)) {
                    handleImageUrl(pastedText);
                    imageUrlInput.value = '';
                    showNotification('URL-bild tillagd från klistrad text', 'success');
                }
            }, 100);
        });
    }

    // Klistra in hantering
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                handleFiles([file]);
            }
        }
    });

    // Transaktionstyp-beräkning
    const transactionPriceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
    const transactionTypeBadge = document.getElementById('transaction-type-badge');
    
    if (transactionPriceInput && transactionTypeBadge) {
        transactionPriceInput.addEventListener('input', function() {
            const value = parseFloat(this.value) || 0;
            if (value < 0) {
                transactionTypeBadge.textContent = 'KÖP';
                transactionTypeBadge.className = 'input-group-text ms-2 bg-danger text-white';
            } else if (value > 0) {
                transactionTypeBadge.textContent = 'SÄLJ';
                transactionTypeBadge.className = 'input-group-text ms-2 bg-success text-white';
            } else {
                transactionTypeBadge.textContent = '';
                transactionTypeBadge.className = 'input-group-text ms-2';
            }
        });
    }

    // Formulärhantering - Lägg till bilder i formuläret innan submit
    const submitButton = document.getElementById('submitButton');
    
    // Funktion för att förbereda formuläret
    function prepareFormForSubmit() {
        // Skapa en DataTransfer för att lägga till filer i file input
        const dataTransfer = new DataTransfer();
        
        // Lägg till alla förhandsvisade bilder
        selectedItems.forEach((item, itemId) => {
            if (item.file) {
                dataTransfer.items.add(item.file);
            }
        });
        
        // Lägg till filerna i det ursprungliga file input
        if (fileInput) {
            fileInput.files = dataTransfer.files;
        }
        
        // Lägg till URL:er som dolda inputs
        const hiddenInputs = document.getElementById('hiddenInputs');
        if (hiddenInputs) {
            // Ta bara bort URL-inputs, behåll bildborttagnings-inputs och bildordnings-inputs
            const removeImageInputs = hiddenInputs.querySelectorAll('input[name="remove_images"]');
            const imageOrderInputs = hiddenInputs.querySelectorAll('input[name="image_order"]');
            hiddenInputs.innerHTML = '';
            // Återställ bildborttagnings-inputs
            removeImageInputs.forEach(input => {
                hiddenInputs.appendChild(input);
            });
            
            // Hantera bildordning för befintliga bilder
            if (existingImagesContainer) {
                Array.from(existingImagesContainer.children).forEach((item, idx) => {
                    const imageId = item.getAttribute('data-image-id');
                    if (imageId) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'image_order';
                        input.value = imageId + ':' + (idx + 1);
                        hiddenInputs.appendChild(input);
                    }
                });
            }
            
            selectedItems.forEach((item, itemId) => {
                if (item.url) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'image_urls';
                    hiddenInput.value = item.url;
                    hiddenInputs.appendChild(hiddenInput);
                }
            });
        }
    }
    
    if (axeForm) {
        axeForm.addEventListener('submit', function(e) {
            prepareFormForSubmit();
        });
    }
    
    // Lägg till click-lyssnare på submit-knappen
    if (submitButton) {
        submitButton.addEventListener('click', function(e) {
            prepareFormForSubmit();
            // Manuellt trigga formuläret
            axeForm.submit();
        });
    }

    // === MÅTT-HANTERING ===
    
    // === ENHETSVÄLJARE FÖR MÅTT ===
    const unitRadios = document.querySelectorAll('input[name="unit_option"]');
    const customUnitInput = document.getElementById('measurement-unit');
    
    if (unitRadios.length > 0 && customUnitInput) {
        unitRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'ovrig') {
                    // Visa textfältet för egen enhet
                    customUnitInput.style.display = 'block';
                    customUnitInput.required = true;
                    customUnitInput.value = '';
                    customUnitInput.focus();
                } else {
                    // Dölj textfältet och sätt vald enhet
                    customUnitInput.style.display = 'none';
                    customUnitInput.required = false;
                    customUnitInput.value = this.value;
                }
            });
        });
        
        // Sätt initial enhet baserat på default-värde (mm)
        const mmRadio = document.getElementById('unit_mm');
        if (mmRadio && !document.querySelector('input[name="unit_option"]:checked')) {
            mmRadio.checked = true;
            customUnitInput.value = 'mm';
        }
        
        // Sätt initial enhet baserat på vald radio button
        const selectedRadio = document.querySelector('input[name="unit_option"]:checked');
        if (selectedRadio && selectedRadio.value !== 'ovrig') {
            customUnitInput.value = selectedRadio.value;
        }
    }
    
    // === SMART ENHETS-IFYLLNING BASERAT PÅ MÅTTTYP ===
    const measurementNameSelect = document.getElementById('measurement-name');
    
    // Måtttyper och deras enheter från servern
    const measurementTypesData = {{ measurement_types_data|safe }};
    
    if (measurementNameSelect && measurementTypesData) {
        measurementNameSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            if (selectedType && selectedType !== 'Övrigt' && measurementTypesData[selectedType]) {
                const recommendedUnit = measurementTypesData[selectedType];
                
                // Hitta motsvarande radio button
                const matchingRadio = document.querySelector(`input[name="unit_option"][value="${recommendedUnit}"]`);
                
                if (matchingRadio) {
                    // Välj motsvarande radio button
                    matchingRadio.checked = true;
                    matchingRadio.dispatchEvent(new Event('change'));
                } else {
                    // Om enheten inte finns bland radio buttons, välj "Övrig" och fyll i enheten
                    const ovrigRadio = document.querySelector('input[name="unit_option"][value="ovrig"]');
                    if (ovrigRadio) {
                        ovrigRadio.checked = true;
                        ovrigRadio.dispatchEvent(new Event('change'));
                        customUnitInput.value = recommendedUnit;
                    }
                }
            }
        });
    }
    
    // Sätt axeId och måttmallar för automatisk initiering
    // window.axeId = {{ axe.pk }}; // Moved to extra_head
    // const measurementTemplates = {{ measurement_templates|safe }}; // Moved to extra_head

});
</script>
{% endblock %}