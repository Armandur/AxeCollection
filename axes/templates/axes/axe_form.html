{% extends 'axes/base.html' %}

{% block title %}{% if is_edit %}Redigera yxa{% else %}Skapa ny yxa{% endif %}{% endblock %}

{% block content %}
<style>
/* Tvinga dropdown direkt under inputfältet */
.position-relative .dropdown-menu {
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin-top: 0 !important;
}
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        {% if is_edit %}
                            <i class="fas fa-edit me-2"></i>Redigera yxa
                            <span class="badge bg-secondary ms-2">ID: {{ axe.id }}</span>
                        {% else %}
                            <i class="fas fa-plus-circle me-2"></i>Skapa ny yxa
                            <span class="badge bg-secondary ms-2">ID: {{ next_id }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Notifikationssektion -->
                    <div id="notification" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="notification-message"></span>
                    </div>
                    
                    <form id="axeForm" method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturer.id_for_label }}" class="form-label">
                                        {{ form.manufacturer.label }}
                                    </label>
                                    {{ form.manufacturer }}
                                    {% if form.manufacturer.errors %}
                                        <div class="text-danger">{{ form.manufacturer.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">
                                        {{ form.model.label }}
                                    </label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Kontakthantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Försäljare/Kontakt
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig kontakt -->
                                <div class="position-relative">
                                    {% include 'axes/_form_field.html' with field=form.contact_search %}
                                    <!-- Dropdown för sökresultat -->
                                    <div id="contactSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny kontakt (visas endast om sökning misslyckas) -->
                                <div id="newContactSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny kontakt</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_name %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_alias %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_email %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_phone %}
                                        </div>
                                    </div>
                                    {% include 'axes/_form_field.html' with field=form.contact_comment %}
                                    {% include 'axes/_form_checkbox.html' with field=form.is_naj_member %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Plattformshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>Plattform
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig plattform -->
                                <div class="position-relative">
                                    {% include 'axes/_form_field.html' with field=form.platform_search %}
                                    <!-- Dropdown för sökresultat -->
                                    <div id="platformSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny plattform (visas endast om sökning misslyckas) -->
                                <div id="newPlatformSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny plattform</h6>
                                    {% include 'axes/_form_field.html' with field=form.platform_name %}
                                    {% include 'axes/_form_field.html' with field=form.platform_url %}
                                    {% include 'axes/_form_field.html' with field=form.platform_comment %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Transaktionshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-money-bill me-2"></i>Transaktion
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% include 'axes/_form_input_group.html' with field=form.transaction_price addon_after='<span id="transaction-type-badge" class="input-group-text ms-2"></span>' %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.transaction_shipping.id_for_label }}" class="form-label">
                                                {{ form.transaction_shipping.label }}
                                            </label>
                                            {{ form.transaction_shipping }}
                                            <div class="form-text">{{ form.transaction_shipping.help_text }}</div>
                                            {% if form.transaction_shipping.errors %}
                                                <div class="text-danger">{{ form.transaction_shipping.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">
                                        {{ form.transaction_date.label }}
                                    </label>
                                    {{ form.transaction_date }}
                                    <div class="form-text">{{ form.transaction_date.help_text }}</div>
                                    {% if form.transaction_date.errors %}
                                        <div class="text-danger">{{ form.transaction_date.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_comment.id_for_label }}" class="form-label">
                                        {{ form.transaction_comment.label }}
                                    </label>
                                    {{ form.transaction_comment }}
                                    <div class="form-text">{{ form.transaction_comment.help_text }}</div>
                                    {% if form.transaction_comment.errors %}
                                        <div class="text-danger">{{ form.transaction_comment.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Förbättrad bilduppladdning för mobil -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.images.label }}</label>
                            
                            <!-- Mobilvänliga knappar -->
                            <div class="d-flex flex-wrap gap-2 mb-3 mobile-upload-buttons">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openCamera()">
                                    <i class="fas fa-camera me-1"></i>Ta foto
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFiles()">
                                    <i class="fas fa-images me-1"></i>Välj bilder
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleUrlInput()">
                                    <i class="fas fa-link me-1"></i>Lägg till URL
                                </button>
                            </div>

                            <!-- Drag & drop område (dolt på mobil) -->
                            <div class="upload-area d-none d-md-block" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Dra och släpp bilder här</h5>
                                    <p class="text-muted">eller klicka för att välja filer</p>
                                    <p class="text-muted small">Du kan också klistra in bilder (Ctrl+V) eller dra URL:er från webbläsaren</p>
                                    {{ form.images }}
                                </div>
                            </div>

                            <!-- Dolda filinputs för mobil -->
                            <div class="d-none">
                                {{ form.images }}
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                                <input type="file" id="fileInput" accept="image/*" multiple>
                            </div>

                            <div class="form-text">{{ form.images.help_text }}</div>
                            {% if form.images.errors %}
                                <div class="text-danger">{{ form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- URL-input för bilder (kollapsbar) -->
                        <div class="mb-4" id="urlInputSection" style="display: none;">
                            <label for="imageUrl" class="form-label">Lägg till bild från URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/bild.jpg">
                                <button class="btn btn-outline-secondary" type="button" id="addUrlBtn">
                                    <i class="fas fa-plus"></i> Lägg till
                                </button>
                            </div>
                            <div class="form-text">Klistra in URL:er från Tradera, eBay eller andra sidor</div>
                        </div>

                        <!-- Befintliga bilder (endast i redigeringsläge) -->
                        {% if is_edit and axe.images.all %}
                            <div class="mb-4">
                                <h6>Befintliga bilder:</h6>
                                <div class="row" id="existingImagesContainer">
                                    {% for image in axe.images.all %}
                                        <div class="col-6 col-md-3 mb-3 existing-image-item" data-image-id="{{ image.id }}" draggable="true">
                                            <div class="card position-relative">
                                                <img src="{{ image.image.url }}" class="card-img-top" alt="Bild {{ forloop.counter }}" style="height: 150px; object-fit: cover;">
                                                <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removeExistingImage({{ image.id }})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <div class="card-body p-2">
                                                    <small class="text-muted">{{ image.description|default:"Bild" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div id="removedImagesContainer"></div>
                            </div>
                        {% endif %}

                        <!-- Förhandsvisning av nya bilder -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <h6>Förhandsvisning av nya bilder:</h6>
                            <div class="row" id="previewContainer"></div>
                        </div>

                        <!-- Flytta hiddenInputs hit, precis före knapparna -->
                        <div id="hiddenInputs"></div>

                        <!-- Måttsektion (endast i redigeringsläge) -->
                        {% if is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-ruler me-2"></i>Mått ({{ measurements.count }})
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Måttmallar -->
                                {% if measurement_templates %}
                                <div class="mb-3">
                                    <p class="text-muted small mb-2">Välj en mall för att snabbt lägga till vanliga mått:</p>
                                    <div class="d-flex flex-wrap">
                                        {% for template_name, template_measurements in measurement_templates.items %}
                                        <button class="btn btn-outline-primary btn-sm me-2 mb-2" 
                                                onclick="loadTemplate('{{ template_name }}')"
                                                title="{{ template_name }}: {{ template_measurements|length }} mått">
                                            <i class="fas fa-list me-1"></i>{{ template_name }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Manuellt tillägg av mått -->
                                <div class="measurement-form mb-3">
                                    <h6 class="mb-3">Lägg till nytt mått</h6>
                                    <form id="measurementForm" method="post" action="{% url 'add_measurement' axe.pk %}">
                                        {% csrf_token %}
                                        <div class="row">
                                            <div class="col-md-4">
                                                {{ measurement_form.name.label_tag }}
                                                {{ measurement_form.name }}
                                                <div class="custom-field" id="custom-name-field">
                                                    {{ measurement_form.custom_name.label_tag }}
                                                    {{ measurement_form.custom_name }}
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                {{ measurement_form.value.label_tag }}
                                                {{ measurement_form.value }}
                                            </div>
                                            <div class="col-md-3">
                                                {{ measurement_form.unit.label_tag }}
                                                {{ measurement_form.unit }}
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="fas fa-plus me-1"></i>
                                                    <span class="d-none d-md-inline">Lägg till</span>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- Batch-måttformulär (dolt från början) -->
                                <div class="measurement-form mt-3" id="batchMeasurementFormContainer" style="display:none;">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Batch-läggning av mått:</strong> Fyll i värdena nedan och klicka "Lägg till alla" för att lägga till alla mått samtidigt. Måtten sparas direkt och visas i tabellen nedan.
                                    </div>
                                    <h6 class="mb-3">Lägg till flera mått från mall</h6>
                                    <form id="batchMeasurementForm" method="post" action="{% url 'add_measurements_from_template' axe.pk %}">
                                        {% csrf_token %}
                                        <div id="batchMeasurementRows"></div>
                                        <div class="text-end mt-2">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-plus me-1"></i>Lägg till alla mått
                                            </button>
                                            <button type="button" class="btn btn-link text-danger" onclick="hideBatchForm()">Avbryt</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Befintliga mått med inline-redigering -->
                                {% if measurements %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Måtttyp</th>
                                                <th>Värde</th>
                                                <th>Enhet</th>
                                                <th>Åtgärder</th>
                                            </tr>
                                        </thead>
                                        <tbody id="measurementsTableBody">
                                            {% for measurement in measurements %}
                                            <tr data-measurement-id="{{ measurement.id }}">
                                                <td>
                                                    <strong>{{ measurement.name }}</strong>
                                                </td>
                                                <td>
                                                    <input type="number" 
                                                           class="form-control form-control-sm measurement-value" 
                                                           value="{{ measurement.value }}" 
                                                           step="any" 
                                                           style="width: 80px;"
                                                           onchange="updateMeasurement({{ measurement.id }}, this.value, this.parentElement.nextElementSibling.querySelector('.measurement-unit').value)">
                                                </td>
                                                <td>
                                                    <input type="text" 
                                                           class="form-control form-control-sm measurement-unit" 
                                                           value="{{ measurement.unit }}" 
                                                           style="width: 60px;"
                                                           onchange="updateMeasurement({{ measurement.id }}, this.parentElement.previousElementSibling.querySelector('.measurement-value').value, this.value)">
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="deleteMeasurement({{ measurement.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted text-center py-3">
                                    <i class="fas fa-ruler fa-2x mb-2"></i><br>
                                    Inga mått registrerade än. Lägg till ditt första mått ovan.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-between">
                            <a href="{% if is_edit %}{% url 'axe_detail' axe.pk %}{% else %}{% url 'axe_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Uppdatera yxa{% else %}Spara yxa{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: #f8f9fa;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-area input[type="file"] {
    display: none;
}

.preview-item {
    position: relative;
    margin-bottom: 1rem;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
}

.preview-item .remove-btn:hover {
    background: #c82333;
}

/* Måttsektion CSS */
.measurement-form {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.custom-field {
    display: none;
}

.custom-field.show {
    display: block;
}

.template-btn {
    margin: 0.25rem;
}

/* Mobiloptimeringar */
@media (max-width: 768px) {
    .mobile-upload-buttons {
        justify-content: center;
    }
    
    .mobile-upload-buttons .btn {
        flex: 1;
        min-width: 120px;
    }
    
    .preview-item {
        margin-bottom: 0.5rem;
    }
    
    .preview-item img {
        height: 120px;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation för URL-input */
.url-input-enter {
    animation: slideDown 0.3s ease-out;
}

.url-input-exit {
    animation: slideUp 0.3s ease-in;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

.overlay-remove-indicator {
    padding: 0.75rem !important;
    box-sizing: border-box;
}

.preview-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.preview-item:active {
    cursor: grabbing;
}

.preview-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.preview-item[draggable="true"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const cameraInput = document.getElementById('cameraInput');
    const selectFileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const imageUrlInput = document.getElementById('imageUrl');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const urlInputSection = document.getElementById('urlInputSection');
    const selectedItems = new Map(); // Map för att hålla reda på både filer och URL:er

    // Mobilvänliga funktioner
    window.openCamera = function() {
        cameraInput.click();
    };

    window.selectFiles = function() {
        selectFileInput.click();
    };

    window.toggleUrlInput = function() {
        if (urlInputSection.style.display === 'none') {
            urlInputSection.style.display = 'block';
            urlInputSection.classList.add('url-input-enter');
            imageUrlInput.focus();
        } else {
            urlInputSection.classList.add('url-input-exit');
            setTimeout(() => {
                urlInputSection.style.display = 'none';
                urlInputSection.classList.remove('url-input-exit');
            }, 300);
        }
    };

    // Kamerainput hantering
    cameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        cameraInput.value = '';
    });

    // Filval input hantering
    selectFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        selectFileInput.value = '';
    });

    // Drag & drop funktionalitet (endast desktop)
    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Hantera filer
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
            
            // Hantera URL:er (text)
            const text = e.dataTransfer.getData('text');
            if (text && isImageUrl(text)) {
                handleImageUrl(text);
            }
        });
    }

    // Filval via input
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
    }

    // Kontaktsökning
    const contactSearchInput = document.getElementById('{{ form.contact_search.id_for_label }}');
    const newContactSection = document.getElementById('newContactSection');
    const contactSearchResults = document.getElementById('contactSearchResults');
    let contactSearchTimeout;
    
    if (contactSearchInput) {
        contactSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            
            // Rensa tidigare timeout
            clearTimeout(contactSearchTimeout);
            
            if (searchValue.length >= 2) {
                // Debounce sökningen
                contactSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_contacts' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results.length > 0) {
                                // Visa dropdown med resultat
                                showContactResults(data.results);
                                newContactSection.style.display = 'none';
                            } else {
                                // Inga resultat, visa ny kontaktsektion
                                hideContactResults();
                                showNewContactSection(searchValue);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            hideContactResults();
                            showNewContactSection(searchValue);
                        });
                }, 300);
            } else {
                hideContactResults();
                newContactSection.style.display = 'none';
            }
        });
        
        // Visa ny kontaktsektion om användaren börjar skriva i namn-fältet
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        if (contactNameInput) {
            contactNameInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    hideContactResults();
                    showNewContactSection(this.value.trim());
                }
            });
        }
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!contactSearchInput.contains(e.target) && !contactSearchResults.contains(e.target)) {
                hideContactResults();
            }
        });
    }
    
    function showContactResults(results) {
        contactSearchResults.innerHTML = '';
        results.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <div>
                    <strong>${contact.name}</strong>
                    ${contact.alias ? `<br><small class="text-muted">${contact.alias}</small>` : ''}
                    ${contact.email ? `<br><small class="text-muted">${contact.email}</small>` : ''}
                    ${contact.phone ? `<br><small class="text-muted">${contact.phone}</small>` : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                contactSearchInput.value = contact.name;
                hideContactResults();
                const newContactSection = document.getElementById('newContactSection');
                if (newContactSection) {
                    newContactSection.style.display = 'none';
                }
            });
            contactSearchResults.appendChild(item);
        });
        contactSearchResults.style.display = 'block';
    }
    
    function hideContactResults() {
        contactSearchResults.style.display = 'none';
    }
    
    // Funktioner för att visa/dölja sektioner för nya kontakter och plattformar
    function showNewContactSection(searchValue = '') {
        hideContactResults();
        const newContactSection = document.getElementById('newContactSection');
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        
        if (newContactSection) {
            newContactSection.style.display = 'block';
        }
        
        if (contactNameInput && searchValue) {
            contactNameInput.value = searchValue;
        }
    }
    
    window.showNewPlatformSection = function(searchValue = '') {
        const platformSearchResults = document.getElementById('platformSearchResults');
        const newPlatformSection = document.getElementById('newPlatformSection');
        const platformNameInput = document.getElementById('{{ form.platform_name.id_for_label }}');
        const platformUrlInput = document.getElementById('{{ form.platform_url.id_for_label }}');
        const platformCommentInput = document.getElementById('{{ form.platform_comment.id_for_label }}');
        
        if (platformSearchResults) {
            platformSearchResults.style.display = 'none';
        }
        
        if (newPlatformSection) {
            newPlatformSection.style.display = 'block';
        }
        
        if (platformNameInput) {
            platformNameInput.value = searchValue;
            platformNameInput.focus();
        }
        if (platformUrlInput) {
            platformUrlInput.value = '';
        }
        if (platformCommentInput) {
            platformCommentInput.value = '';
        }
    };

    // Plattformssökning
    const platformSearchInput = document.getElementById('{{ form.platform_search.id_for_label }}');
    const platformSearchResults = document.getElementById('platformSearchResults');
    let platformSearchTimeout;
    
    if (platformSearchInput) {
        platformSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            clearTimeout(platformSearchTimeout);
            if (searchValue.length >= 2) {
                platformSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_platforms' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            platformSearchResults.innerHTML = '';
                            if (data.results && data.results.length > 0) {
                                // Visa dropdown med resultat
                                data.results.forEach(platform => {
                                    const item = document.createElement('div');
                                    item.className = 'dropdown-item';
                                    item.innerHTML = `<div><strong>${platform.name}</strong></div>`;
                                    item.addEventListener('click', () => {
                                        platformSearchInput.value = platform.name;
                                        platformSearchResults.style.display = 'none';
                                        const newPlatformSection = document.getElementById('newPlatformSection');
                                        if (newPlatformSection) {
                                            newPlatformSection.style.display = 'none';
                                        }
                                    });
                                    platformSearchResults.appendChild(item);
                                });
                                platformSearchResults.style.display = 'block';
                            } else {
                                // Om ingen match, visa "Skapa ny"
                                const newId = 'showNewPlatformLink_' + Date.now();
                                platformSearchResults.innerHTML = `
                                    <div class="dropdown-item">
                                        <a href="#" class="text-decoration-none text-dark" id="${newId}">
                                            <i class="fas fa-plus-circle me-1"></i> Skapa ny plattform: "${searchValue}"
                                        </a>
                                    </div>
                                `;
                                platformSearchResults.style.display = 'block';
                                setTimeout(() => {
                                    const link = document.getElementById(newId);
                                    if (link) {
                                        link.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            showNewPlatformSection(searchValue);
                                        });
                                    }
                                }, 0);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            platformSearchResults.innerHTML = `
                                <div class="dropdown-item text-danger">
                                    Fel vid sökning: ${error.message}
                                </div>
                            `;
                            platformSearchResults.style.display = 'block';
                        });
                }, 300);
            } else {
                platformSearchResults.style.display = 'none';
            }
        });
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!platformSearchInput.contains(e.target) && !platformSearchResults.contains(e.target)) {
                platformSearchResults.style.display = 'none';
            }
        });
    }
}); 
</script>
{% endblock %}