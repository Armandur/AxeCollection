{% extends 'axes/base.html' %}

{% block title %}{% if is_edit %}Redigera yxa{% else %}Skapa ny yxa{% endif %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        {% if is_edit %}
                            <i class="fas fa-edit me-2"></i>Redigera yxa
                            <span class="badge bg-secondary ms-2">ID: {{ axe.id }}</span>
                        {% else %}
                            <i class="fas fa-plus-circle me-2"></i>Skapa ny yxa
                            <span class="badge bg-secondary ms-2">ID: {{ next_id }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <form id="axeForm" method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturer.id_for_label }}" class="form-label">
                                        {{ form.manufacturer.label }}
                                    </label>
                                    {{ form.manufacturer }}
                                    {% if form.manufacturer.errors %}
                                        <div class="text-danger">{{ form.manufacturer.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">
                                        {{ form.model.label }}
                                    </label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Kontakthantering -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Försäljare/Kontakt
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.contact_name.id_for_label }}" class="form-label">
                                                {{ form.contact_name.label }}
                                            </label>
                                            {{ form.contact_name }}
                                            <div class="form-text">{{ form.contact_name.help_text }}</div>
                                            {% if form.contact_name.errors %}
                                                <div class="text-danger">{{ form.contact_name.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.contact_alias.id_for_label }}" class="form-label">
                                                {{ form.contact_alias.label }}
                                            </label>
                                            {{ form.contact_alias }}
                                            <div class="form-text">{{ form.contact_alias.help_text }}</div>
                                            {% if form.contact_alias.errors %}
                                                <div class="text-danger">{{ form.contact_alias.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.contact_email.id_for_label }}" class="form-label">
                                                {{ form.contact_email.label }}
                                            </label>
                                            {{ form.contact_email }}
                                            <div class="form-text">{{ form.contact_email.help_text }}</div>
                                            {% if form.contact_email.errors %}
                                                <div class="text-danger">{{ form.contact_email.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.contact_phone.id_for_label }}" class="form-label">
                                                {{ form.contact_phone.label }}
                                            </label>
                                            {{ form.contact_phone }}
                                            <div class="form-text">{{ form.contact_phone.help_text }}</div>
                                            {% if form.contact_phone.errors %}
                                                <div class="text-danger">{{ form.contact_phone.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.contact_comment.id_for_label }}" class="form-label">
                                        {{ form.contact_comment.label }}
                                    </label>
                                    {{ form.contact_comment }}
                                    <div class="form-text">{{ form.contact_comment.help_text }}</div>
                                    {% if form.contact_comment.errors %}
                                        <div class="text-danger">{{ form.contact_comment.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.is_naj_member }}
                                    <label class="form-check-label" for="{{ form.is_naj_member.id_for_label }}">
                                        {{ form.is_naj_member.label }}
                                    </label>
                                    <div class="form-text">{{ form.is_naj_member.help_text }}</div>
                                    {% if form.is_naj_member.errors %}
                                        <div class="text-danger">{{ form.is_naj_member.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Förbättrad bilduppladdning för mobil -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.images.label }}</label>
                            
                            <!-- Mobilvänliga knappar -->
                            <div class="d-flex flex-wrap gap-2 mb-3 mobile-upload-buttons">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openCamera()">
                                    <i class="fas fa-camera me-1"></i>Ta foto
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFiles()">
                                    <i class="fas fa-images me-1"></i>Välj bilder
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleUrlInput()">
                                    <i class="fas fa-link me-1"></i>Lägg till URL
                                </button>
                            </div>

                            <!-- Drag & drop område (dolt på mobil) -->
                            <div class="upload-area d-none d-md-block" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Dra och släpp bilder här</h5>
                                    <p class="text-muted">eller klicka för att välja filer</p>
                                    <p class="text-muted small">Du kan också klistra in bilder (Ctrl+V) eller dra URL:er från webbläsaren</p>
                                    {{ form.images }}
                                </div>
                            </div>

                            <!-- Dolda filinputs för mobil -->
                            <div class="d-none">
                                {{ form.images }}
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                                <input type="file" id="fileInput" accept="image/*" multiple>
                            </div>

                            <div class="form-text">{{ form.images.help_text }}</div>
                            {% if form.images.errors %}
                                <div class="text-danger">{{ form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- URL-input för bilder (kollapsbar) -->
                        <div class="mb-4" id="urlInputSection" style="display: none;">
                            <label for="imageUrl" class="form-label">Lägg till bild från URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/bild.jpg">
                                <button class="btn btn-outline-secondary" type="button" id="addUrlBtn">
                                    <i class="fas fa-plus"></i> Lägg till
                                </button>
                            </div>
                            <div class="form-text">Klistra in URL:er från Tradera, eBay eller andra sidor</div>
                        </div>

                        <!-- Befintliga bilder (endast i redigeringsläge) -->
                        {% if is_edit and axe.images.all %}
                            <div class="mb-4">
                                <h6>Befintliga bilder:</h6>
                                <div class="row" id="existingImagesContainer">
                                    {% for image in axe.images.all %}
                                        <div class="col-6 col-md-3 mb-3 existing-image-item" data-image-id="{{ image.id }}" draggable="true">
                                            <div class="card position-relative">
                                                <img src="{{ image.image.url }}" class="card-img-top" alt="Bild {{ forloop.counter }}" style="height: 150px; object-fit: cover;">
                                                <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removeExistingImage({{ image.id }})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <div class="card-body p-2">
                                                    <small class="text-muted">{{ image.description|default:"Bild" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div id="removedImagesContainer"></div>
                            </div>
                        {% endif %}

                        <!-- Förhandsvisning av nya bilder -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <h6>Förhandsvisning av nya bilder:</h6>
                            <div class="row" id="previewContainer"></div>
                        </div>

                        <!-- Flytta hiddenInputs hit, precis före knapparna -->
                        <div id="hiddenInputs"></div>

                        <div class="d-flex justify-content-between">
                            <a href="{% if is_edit %}{% url 'axe_detail' axe.pk %}{% else %}{% url 'axe_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Uppdatera yxa{% else %}Spara yxa{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: #f8f9fa;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.upload-area input[type="file"] {
    display: none;
}

.preview-item {
    position: relative;
    margin-bottom: 1rem;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
}

.preview-item .remove-btn:hover {
    background: #c82333;
}

/* Mobiloptimeringar */
@media (max-width: 768px) {
    .mobile-upload-buttons {
        justify-content: center;
    }
    
    .mobile-upload-buttons .btn {
        flex: 1;
        min-width: 120px;
    }
    
    .preview-item {
        margin-bottom: 0.5rem;
    }
    
    .preview-item img {
        height: 120px;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation för URL-input */
.url-input-enter {
    animation: slideDown 0.3s ease-out;
}

.url-input-exit {
    animation: slideUp 0.3s ease-in;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

.overlay-remove-indicator {
    padding: 0.75rem !important;
    box-sizing: border-box;
}

.preview-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.preview-item:active {
    cursor: grabbing;
}

.preview-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.preview-item[draggable="true"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const cameraInput = document.getElementById('cameraInput');
    const selectFileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const imageUrlInput = document.getElementById('imageUrl');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const urlInputSection = document.getElementById('urlInputSection');
    const selectedItems = new Map(); // Map för att hålla reda på både filer och URL:er

    // Mobilvänliga funktioner
    window.openCamera = function() {
        cameraInput.click();
    };

    window.selectFiles = function() {
        selectFileInput.click();
    };

    window.toggleUrlInput = function() {
        if (urlInputSection.style.display === 'none') {
            urlInputSection.style.display = 'block';
            urlInputSection.classList.add('url-input-enter');
            imageUrlInput.focus();
        } else {
            urlInputSection.classList.add('url-input-exit');
            setTimeout(() => {
                urlInputSection.style.display = 'none';
                urlInputSection.classList.remove('url-input-exit');
            }, 300);
        }
    };

    // Kamerainput hantering
    cameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        cameraInput.value = '';
    });

    // Filval input hantering
    selectFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        selectFileInput.value = '';
    });

    // Drag & drop funktionalitet (endast desktop)
    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Hantera filer
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
            
            // Hantera URL:er (text)
            const text = e.dataTransfer.getData('text');
            if (text && isImageUrl(text)) {
                handleImageUrl(text);
            }
        });
    }

    // Filval via input
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
    }

    // Klistra in (Ctrl+V) - endast på desktop
    if (!isMobile()) {
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    handleFiles([file]);
                }
            }
            
            // Hantera klistrade URL:er
            const text = e.clipboardData.getData('text');
            if (text && isImageUrl(text)) {
                handleImageUrl(text);
            }
        });
    }

    // URL-knapp
    addUrlBtn.addEventListener('click', () => {
        const url = imageUrlInput.value.trim();
        if (url && isImageUrl(url)) {
            handleImageUrl(url);
            imageUrlInput.value = '';
        } else {
            alert('Vänligen ange en giltig bild-URL');
        }
    });

    // Enter i URL-fältet
    imageUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addUrlBtn.click();
        }
    });

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function isImageUrl(url) {
        return url.match(/\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i) || 
               url.includes('tradera.com') || 
               url.includes('ebay.com') ||
               url.includes('bilder') ||
               url.includes('image');
    }

    function handleFiles(files) {
        files.forEach(file => {
            if (file.type.startsWith('image/') && !selectedItems.has(file.name)) {
                selectedItems.set(file.name, { type: 'file', data: file });
                createPreview(file, file.name);
                
                // Lägg till filen i det faktiska formulärfältet
                const formFileInput = document.querySelector('input[name="images"]');
                if (formFileInput) {
                    // Skapa en ny FileList med den nya filen
                    const dt = new DataTransfer();
                    
                    // Lägg till befintliga filer
                    if (formFileInput.files) {
                        for (let i = 0; i < formFileInput.files.length; i++) {
                            dt.items.add(formFileInput.files[i]);
                        }
                    }
                    
                    // Lägg till den nya filen
                    dt.items.add(file);
                    
                    // Uppdatera input-fältet
                    formFileInput.files = dt.files;
                }
            }
        });
        
        updatePreviewVisibility();
    }

    function handleImageUrl(url) {
        const urlId = 'url_' + Date.now();
        if (!selectedItems.has(urlId)) {
            selectedItems.set(urlId, { type: 'url', data: url });
            createUrlPreview(url, urlId);
        }
        updatePreviewVisibility();
    }

    function createPreview(file, id) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewContainer = document.getElementById('imagePreview');
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item col-md-2 col-sm-3 col-6 mb-3';
            previewItem.draggable = true;
            previewItem.dataset.id = id;
            
            previewItem.innerHTML = `
                <div class="position-relative">
                    <img src="${e.target.result}" class="img-fluid rounded" style="height: 150px; width: 100%; object-fit: cover;" alt="Förhandsvisning">
                    <div class="position-absolute top-0 end-0 p-1">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePreview('${id}')" title="Ta bort bild">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="position-absolute bottom-0 start-0 w-100 p-1">
                        <small class="text-white bg-dark bg-opacity-75 rounded px-1">${id}</small>
                    </div>
                </div>
            `;
            
            // Lägg till drag & drop event listeners
            previewItem.addEventListener('dragstart', handleDragStart);
            previewItem.addEventListener('dragover', handleDragOver);
            previewItem.addEventListener('drop', handleDrop);
            previewItem.addEventListener('dragenter', handleDragEnter);
            previewItem.addEventListener('dragleave', handleDragLeave);
            
            previewContainer.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    }
    
    // Drag & drop funktioner för nya bilder
    let draggedPreviewElement = null;
    
    function handleDragStart(e) {
        draggedPreviewElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (draggedPreviewElement !== this) {
            const previewContainer = document.getElementById('imagePreview');
            const allItems = Array.from(previewContainer.children);
            const draggedIndex = allItems.indexOf(draggedPreviewElement);
            const dropIndex = allItems.indexOf(this);
            
            // Flytta elementet
            if (draggedIndex < dropIndex) {
                this.parentNode.insertBefore(draggedPreviewElement, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedPreviewElement, this);
            }
            
            // Uppdatera ordningen i formulärfältet
            updateFormFileOrder();
        }
        
        draggedPreviewElement.style.opacity = '1';
        draggedPreviewElement = null;
    }
    
    function updateFormFileOrder() {
        const previewContainer = document.getElementById('imagePreview');
        const formFileInput = document.querySelector('input[name="images"]');
        
        if (formFileInput) {
            const dt = new DataTransfer();
            const previewItems = Array.from(previewContainer.children);
            
            previewItems.forEach(item => {
                const id = item.dataset.id;
                const itemData = selectedItems.get(id);
                if (itemData && itemData.type === 'file') {
                    // Hitta filen i original FileList
                    for (let i = 0; i < formFileInput.files.length; i++) {
                        if (formFileInput.files[i].name === id) {
                            dt.items.add(formFileInput.files[i]);
                            break;
                        }
                    }
                }
            });
            
            formFileInput.files = dt.files;
        }
    }

    function createUrlPreview(url, id) {
        const previewItem = document.createElement('div');
        previewItem.className = 'col-6 col-md-3 preview-item';
        previewItem.innerHTML = `
            <img src="${url}" alt="Förhandsvisning" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+QnJva2VuIGltYWdlPC90ZXh0Pjwvc3ZnPg=='">
            <button type="button" class="remove-btn" onclick="removePreview('${id}')">
                <i class="fas fa-times"></i>
            </button>
            <div class="preview-info">
                <small class="text-muted">URL-bild</small>
            </div>
        `;
        previewContainer.appendChild(previewItem);
    }

    function updatePreviewVisibility() {
        if (selectedItems.size > 0) {
            imagePreview.style.display = 'block';
        } else {
            imagePreview.style.display = 'none';
        }
    }

    // Global funktion för att ta bort förhandsvisning
    window.removePreview = function(id) {
        const item = selectedItems.get(id);
        if (item && item.type === 'file') {
            // Ta bort filen från formulärfältet
            const formFileInput = document.querySelector('input[name="images"]');
            if (formFileInput) {
                const dt = new DataTransfer();
                for (let i = 0; i < formFileInput.files.length; i++) {
                    if (formFileInput.files[i].name !== id) {
                        dt.items.add(formFileInput.files[i]);
                    }
                }
                formFileInput.files = dt.files;
            }
        }
        
        selectedItems.delete(id);
        const previewItem = document.querySelector(`[onclick="removePreview('${id}')"]`).closest('.preview-item');
        previewItem.remove();
        updatePreviewVisibility();
    };

    // Lägg till drag & drop för befintliga bilder
    let draggedExistingElement = null; // Deklarera variabeln för befintliga bilder
    
    const existingImageItems = document.querySelectorAll('.existing-image-item');
    existingImageItems.forEach(item => {
        item.addEventListener('dragstart', handleExistingDragStart);
        item.addEventListener('dragover', handleExistingDragOver);
        item.addEventListener('drop', handleExistingDrop);
        item.addEventListener('dragenter', handleExistingDragEnter);
        item.addEventListener('dragleave', handleExistingDragLeave);
    });
    
    function handleExistingDragStart(e) {
        draggedExistingElement = this;
        this.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.outerHTML);
    }
    
    function handleExistingDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleExistingDragEnter(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }
    
    function handleExistingDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    function handleExistingDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (draggedExistingElement !== this) {
            const container = document.getElementById('existingImagesContainer');
            const allItems = Array.from(container.children);
            const draggedIndex = allItems.indexOf(draggedExistingElement);
            const dropIndex = allItems.indexOf(this);
            
            // Flytta elementet
            if (draggedIndex < dropIndex) {
                this.parentNode.insertBefore(draggedExistingElement, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedExistingElement, this);
            }
            
            // Uppdatera ordningen i backend (skicka med i formuläret)
            updateExistingImageOrder();
        }
        
        draggedExistingElement.style.opacity = '1';
        draggedExistingElement = null;
    }
    
    function updateExistingImageOrder() {
        const container = document.getElementById('existingImagesContainer');
        const imageItems = Array.from(container.children);
        const orderData = imageItems.map((item, index) => ({
            id: item.dataset.imageId,
            order: index + 1
        }));
        
        console.log('Uppdaterar bildordning:', orderData); // Debug
        
        // Skapa dolda inputs för ordningen
        const hiddenInputs = document.getElementById('hiddenInputs');
        const existingOrderInputs = hiddenInputs.querySelectorAll('input[name="image_order"]');
        existingOrderInputs.forEach(input => input.remove());
        
        orderData.forEach(item => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'image_order';
            input.value = `${item.id}:${item.order}`;
            hiddenInputs.appendChild(input);
            console.log('Lagt till input:', input.value); // Debug
        });
    }

    // Hantera formulärsubmit
    document.getElementById('axeForm').addEventListener('submit', function(e) {
        const hiddenInputs = document.getElementById('hiddenInputs');
        hiddenInputs.innerHTML = ''; // Rensa ALLTID först!
        updateExistingImageOrder(); // Lägg till bildordning
        console.log('Submit-funktionen körs'); // DEBUG
        // Skapa dolda inputs för URL:er
        selectedItems.forEach((item, id) => {
            if (item.type === 'url') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'image_urls';
                input.value = item.data;
                hiddenInputs.appendChild(input);
            }
        });
        
        // Lägg till dolda inputs för borttagna bilder
        const removedImages = window.removedExistingImages || [];
        removedImages.forEach(imageId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'removed_images';
            input.value = imageId;
            hiddenInputs.appendChild(input);
        });
        
        // DEBUG: Skriv ut vad som finns i hiddenInputs
        console.log('hiddenInputs vid submit:', hiddenInputs.innerHTML);
    });
});

// Global funktion för att ta bort befintliga bilder
window.removeExistingImage = function(imageId) {
    if (confirm('Är du säker på att du vill ta bort denna bild?')) {
        const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
        if (imageItem) {
            // Lägg till i listan över borttagna bilder
            if (!window.removedExistingImages) {
                window.removedExistingImages = [];
            }
            window.removedExistingImages.push(imageId);
            
            // Dölj bilden (lägg till opacity och disabled state)
            imageItem.style.opacity = '0.5';
            imageItem.style.pointerEvents = 'none';
            
            // Lägg till en indikator för att bilden kommer att tas bort
            const card = imageItem.querySelector('.card');
            const removeIndicator = document.createElement('div');
            removeIndicator.className = 'position-absolute w-100 h-100 d-flex align-items-center justify-content-center overlay-remove-indicator';
            removeIndicator.style.cssText = 'top: 0; left: 0; background: rgba(220, 53, 69, 0.8); color: white; font-weight: bold; border-radius: 0.375rem; padding: 0.75rem; box-sizing: border-box;';
            removeIndicator.innerHTML = '<span>KOMMER ATT TAS BORT</span>';
            card.appendChild(removeIndicator);
        }
    }
};
</script>
{% endblock %} 