{% extends 'axes/base.html' %}
{% load static %}
{% load axe_filters %}

{% block title %}{% if is_edit %}Redigera yxa{% else %}Skapa ny yxa{% endif %}{% endblock %}

{% block extra_head %}
{% if axe.pk %}
<script>
window.axeId = {{ axe.pk }};
window.measurementTemplates = {{ measurement_templates|safe }};
</script>
{% else %}
<script>
window.axeId = null;
window.measurementTemplates = {{ measurement_templates|safe }};
</script>
{% endif %}
<script src="{% static 'js/measurement_templates.js' %}"></script>
<style>
/* Tvinga dropdown direkt under inputfältet */
.position-relative .dropdown-menu {
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin-top: 0 !important;
}

/* Custom field för måttformulär */
.custom-field {
    display: none;
    margin-top: 10px;
}
.custom-field.show {
    display: block !important;
}

/* Inline redigering av mått */
tr.editing {
    background-color: #fff3cd;
    border: 2px solid #ffecb3;
}

tr.editing td {
    padding: 8px !important;
}

tr.editing .form-control-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        {% if is_edit %}
                            <i class="fas fa-edit me-2"></i>Redigera yxa
                            <span class="badge bg-secondary ms-2">ID: {{ axe.id }}</span>
                        {% else %}
                            <i class="fas fa-plus-circle me-2"></i>Skapa ny yxa
                            <span class="badge bg-secondary ms-2">ID: {{ next_id }}</span>
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Notifikationssektion -->
                    <div id="notification" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="notification-message"></span>
                    </div>
                    
                    <form id="axeForm" method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        
                        <!-- URL-parsning sektion (endast för nya yxor) -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-link me-2"></i>Hämta data från auktions-URL (valfritt)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="auction_url" class="form-label">Auktions-URL (Tradera/eBay)</label>
                                            <input type="url" class="form-control" id="auction_url" name="auction_url" 
                                                   placeholder="https://www.tradera.com/item/... eller https://www.ebay.com/itm/..." 
                                                   title="Klistra in URL:en till den vunna auktionen här">
                                            <div class="form-text">
                                                Klistra in URL:en till den vunna Tradera- eller eBay-auktionen för att automatiskt fylla i data.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" id="parseUrlBtn" class="btn btn-info w-100">
                                                <i class="fas fa-download me-2"></i>Hämta data
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Visning av extraherad data -->
                                <div id="parsedDataSection" style="display: none;">
                                    <hr class="my-3">
                                    <div class="alert alert-success">
                                        <h6 class="mb-2">
                                            <i class="fas fa-check-circle me-2"></i>Auktionsdata extraherad
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small><strong>Titel:</strong> <span id="parsedTitle"></span></small><br>
                                                <small><strong>Säljare:</strong> <span id="parsedSeller"></span></small><br>
                                                <small><strong>Slutpris:</strong> <span id="parsedPrice"></span></small><br>
                                                <small><strong>Valuta:</strong> <span id="parsedCurrency"></span></small><br>
                                                <small><strong>Slutdatum:</strong> <span id="parsedEndDate"></span></small>
                                            </div>
                                            <div class="col-md-6">
                                                <!-- Beskrivning tas bort eftersom vi använder titeln som beskrivning -->
                                            </div>
                                        </div>
                                        <!-- Valutavarning -->
                                        <div id="currencyWarning" class="alert alert-info mt-3" style="display: none;">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                                <div class="flex-grow-1">
                                                    <div class="fw-bold mb-2">Valutainformation</div>
                                                    <div id="currencyWarningText" class="mb-2"></div>
                                                    
                                                    <!-- Kursinformation -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <small class="text-muted">
                                                                <strong>Live kurs:</strong> <span id="conversionRate"></span>
                                                            </small>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <small class="text-muted">
                                                                <strong>Senast uppdaterad:</strong> <span id="lastUpdated"></span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Konverteringsalternativ -->
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <button type="button" id="convertToSekBtn" class="btn btn-sm btn-primary">
                                                                <i class="fas fa-exchange-alt me-1"></i>Konvertera automatiskt
                                                            </button>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <button type="button" id="manualSekBtn" class="btn btn-sm btn-outline-secondary">
                                                                <i class="fas fa-edit me-1"></i>Ange SEK-belopp manuellt
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Manuell SEK-input (dold) -->
                                                    <div id="manualSekInput" class="mt-3" style="display: none;">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="input-group input-group-sm">
                                                                    <input type="number" id="manualSekValue" class="form-control" 
                                                                           placeholder="Belopp i SEK" step="1" min="1">
                                                                    <span class="input-group-text">kr</span>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <button type="button" id="applyManualSekBtn" class="btn btn-sm btn-success">
                                                                    <i class="fas fa-check me-1"></i>Använd
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">Ange det slutliga beloppet i svenska kronor</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Laddningsindikator -->
                                <div id="loadingIndicator" style="display: none;">
                                    <div class="text-center">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="visually-hidden">Laddar...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Hämtar auktionsdata...</p>
                                    </div>
                                </div>
                                
                                <!-- Felmeddelande -->
                                <div id="errorMessage" class="alert alert-danger" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="errorText"></span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.manufacturer.id_for_label }}" class="form-label">
                                        {{ form.manufacturer.label }}
                                    </label>
                                    {{ form.manufacturer }}
                                    {% if form.manufacturer.errors %}
                                        <div class="text-danger">{{ form.manufacturer.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.model.id_for_label }}" class="form-label">
                                        {{ form.model.label }}
                                    </label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="text-danger">{{ form.model.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">
                                {{ form.comment.label }}
                            </label>
                            {{ form.comment }}
                            {% if form.comment.errors %}
                                <div class="text-danger">{{ form.comment.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }}
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Kontakthantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-user me-2"></i>Försäljare/Kontakt
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig kontakt -->
                                <div class="position-relative">
                                    <div class="mb-3">
                                        <label for="{{ form.contact_search.id_for_label }}" class="form-label">
                                            {{ form.contact_search.label }}
                                            <span id="contact-match-info" class="badge bg-info ms-2" style="display: none;">
                                                <i class="fas fa-info-circle me-1"></i>Ingen kontakt hittad - registrerar ny
                                            </span>
                                        </label>
                                        {{ form.contact_search }}
                                        {% if form.contact_search.help_text %}
                                            <div class="form-text">{{ form.contact_search.help_text }}</div>
                                        {% endif %}
                                        {% if form.contact_search.errors %}
                                            <div class="text-danger">{{ form.contact_search.errors }}</div>
                                        {% endif %}
                                    </div>
                                    <!-- Dropdown för sökresultat -->
                                    <div id="contactSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny kontakt (visas endast om sökning misslyckas) -->
                                <div id="newContactSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny kontakt</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_name %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_alias %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_email %}
                                        </div>
                                        <div class="col-md-6">
                                            {% include 'axes/_form_field.html' with field=form.contact_phone %}
                                        </div>
                                    </div>
                                    {% include 'axes/_form_field.html' with field=form.contact_comment %}
                                    {% include 'axes/_form_checkbox.html' with field=form.is_naj_member %}
                                    
                                    <!-- Adressfält för ny kontakt -->
                                    <hr class="my-3">
                                    <h6 class="text-muted">Adress (valfritt)</h6>
                                    {% include 'axes/_form_field.html' with field=form.contact_street %}
                                    <div class="row">
                                        <div class="col-md-4">
                                            {% include 'axes/_form_field.html' with field=form.contact_postal_code %}
                                        </div>
                                        <div class="col-md-8">
                                            {% include 'axes/_form_field.html' with field=form.contact_city %}
                                        </div>
                                    </div>
                                    {% include 'axes/_form_field.html' with field=form.contact_country_code %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Plattformshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>Plattform
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Sök efter befintlig plattform -->
                                <div class="position-relative">
                                    {% include 'axes/_form_field.html' with field=form.platform_search %}
                                    <!-- Dropdown för sökresultat -->
                                    <div id="platformSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                        <!-- Sökresultat visas här -->
                                    </div>
                                </div>
                                <!-- Ny plattform (visas endast om sökning misslyckas) -->
                                <div id="newPlatformSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny plattform</h6>
                                    {% include 'axes/_form_field.html' with field=form.platform_name %}
                                    {% include 'axes/_form_field.html' with field=form.platform_url %}
                                    {% include 'axes/_form_field.html' with field=form.platform_comment %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Transaktionshantering -->
                        {% if not is_edit %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-money-bill me-2"></i>Transaktion
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        {% include 'axes/_form_input_group.html' with field=form.transaction_price addon_after='<span id="transaction-type-badge" class="input-group-text ms-2"></span>' %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.transaction_shipping.id_for_label }}" class="form-label">
                                                {{ form.transaction_shipping.label }}
                                            </label>
                                            {{ form.transaction_shipping }}
                                            <div class="form-text">{{ form.transaction_shipping.help_text }}</div>
                                            {% if form.transaction_shipping.errors %}
                                                <div class="text-danger">{{ form.transaction_shipping.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_date.id_for_label }}" class="form-label">
                                        {{ form.transaction_date.label }}
                                    </label>
                                    {{ form.transaction_date }}
                                    <div class="form-text">{{ form.transaction_date.help_text }}</div>
                                    {% if form.transaction_date.errors %}
                                        <div class="text-danger">{{ form.transaction_date.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="{{ form.transaction_comment.id_for_label }}" class="form-label">
                                        {{ form.transaction_comment.label }}
                                    </label>
                                    {{ form.transaction_comment }}
                                    <div class="form-text">{{ form.transaction_comment.help_text }}</div>
                                    {% if form.transaction_comment.errors %}
                                        <div class="text-danger">{{ form.transaction_comment.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Förbättrad bilduppladdning för mobil -->
                        <div class="mb-4">
                            <label class="form-label">{{ form.images.label }}</label>
                            
                            <!-- Mobilvänliga knappar -->
                            <div class="d-flex flex-wrap gap-2 mb-3 mobile-upload-buttons">
                                <button type="button" class="btn btn-primary btn-sm" onclick="openCamera()">
                                    <i class="fas fa-camera me-1"></i>Ta foto
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFiles()">
                                    <i class="fas fa-images me-1"></i>Välj bilder
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleUrlInput()">
                                    <i class="fas fa-link me-1"></i>Lägg till URL
                                </button>
                            </div>

                            <!-- Drag & drop område (dolt på mobil) -->
                            <div class="upload-area d-none d-md-block" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Dra och släpp bilder här</h5>
                                    <p class="text-muted">eller klicka för att välja filer</p>
                                    <p class="text-muted small">Du kan också klistra in bilder (Ctrl+V) eller dra URL:er från webbläsaren</p>
                                    {{ form.images }}
                                </div>
                            </div>

                            <!-- Dolda filinputs för mobil -->
                            <div class="d-none">
                                {{ form.images }}
                                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple>
                                <input type="file" id="fileInput" accept="image/*" multiple>
                            </div>

                            <div class="form-text">{{ form.images.help_text }}</div>
                            {% if form.images.errors %}
                                <div class="text-danger">{{ form.images.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- URL-input för bilder (kollapsbar) -->
                        <div class="mb-4" id="urlInputSection" style="display: none;">
                            <label for="imageUrl" class="form-label">Lägg till bild från URL</label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/bild.jpg">
                                <button class="btn btn-outline-secondary" type="button" id="addUrlBtn">
                                    <i class="fas fa-plus"></i> Lägg till
                                </button>
                            </div>
                            <div class="form-text">Klistra in URL:er från Tradera, eBay eller andra sidor</div>
                        </div>

                        <!-- Befintliga bilder (endast i redigeringsläge) -->
                        {% if is_edit and axe.images.all %}
                            <div class="mb-4" id="stampel-sektion">
                                <h6>Befintliga bilder:</h6>
                                <div class="row" id="existingImagesContainer">
                                    {% for image in axe.images.all %}
                                        <div class="col-6 col-md-3 mb-3 existing-image-item" data-image-id="{{ image.id }}" draggable="true">
                                            <div class="card position-relative">
                                                <picture>
                                                    {% if image.webp_url %}
                                                        <source srcset="{{ image.webp_url }}" type="image/webp">
                                                    {% endif %}
                                                    <img src="{{ image.image_url_with_cache_busting }}" class="card-img-top" alt="Bild {{ forloop.counter }}" style="height: 150px; object-fit: cover;">
                                                </picture>
                                                <div class="position-absolute" style="top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                                    {{ image.image.name|basename }}
                                                </div>
                                                <button type="button" class="btn btn-danger btn-sm position-absolute delete-image-btn" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removeExistingImage({{ image.id }})" title="Ta bort bild">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                
                                                                                                   <!-- Stämpelhantering -->
                                                   <div class="position-absolute" style="top: 5px; right: 40px;">
                                                       {% if image.stamp_marks.all %}
                                                           <a href="{% url 'edit_axe_image_stamp' axe.id image.id %}" 
                                                              class="btn btn-sm btn-outline-warning"
                                                              title="Redigera stämpelmarkering">
                                                               <i class="fas fa-edit"></i>
                                                           </a>
                                                       {% else %}
                                                           <a href="{% url 'mark_axe_image_as_stamp' axe.id image.id %}" 
                                                              class="btn btn-sm btn-outline-primary"
                                                              title="Markera stämpel">
                                                               <i class="fas fa-stamp"></i>
                                                           </a>
                                                       {% endif %}
                                                   </div>

                                                <div class="card-body p-2">
                                                    <small class="text-muted">{{ image.description|default:"Bild" }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div id="removedImagesContainer"></div>
                            </div>
                        {% endif %}

                        <!-- Förhandsvisning av nya bilder -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <h6>Förhandsvisning av nya bilder:</h6>
                            <div class="row" id="previewContainer"></div>
                        </div>

                        <!-- Flytta hiddenInputs hit, precis före knapparna -->
                        <div id="hiddenInputs"></div>
                        <div class="d-flex justify-content-between">
                            <a href="{% if is_edit %}{% url 'axe_detail' axe.pk %}{% else %}{% url 'axe_list' %}{% endif %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Tillbaka
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitButton">
                                <i class="fas fa-save me-2"></i>{% if is_edit %}Uppdatera yxa{% else %}Spara yxa{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Måttsektion (endast i redigeringsläge) - Flyttad utanför axeForm -->
{% if is_edit %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-ruler me-2"></i>Mått (<span class="measurement-count">{{ measurements.count }}</span>)
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Måttmallar -->
                    {% if measurement_templates %}
                    <div class="mb-3">
                        <p class="text-muted small mb-2">Välj en mall för att snabbt lägga till vanliga mått:</p>
                        <div class="d-flex flex-wrap">
                            {% for template_name, template_measurements in measurement_templates.items %}
                            <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 template-btn" 
                                    data-template="{{ template_name }}"
                                    title="{{ template_name }}: {{ template_measurements|length }} mått">
                                <i class="fas fa-list me-1"></i>{{ template_name }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Manuellt tillägg av mått -->
                    <div class="measurement-form mb-3">
                        <h6 class="mb-3">Lägg till nytt mått</h6>
                        <form id="measurementForm" method="post" action="{% url 'add_measurement' axe.pk %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-3">
                                    {{ measurement_form.name.label_tag }}
                                    {{ measurement_form.name }}
                                    <div class="custom-field" id="custom-name-field">
                                        {{ measurement_form.custom_name.label_tag }}
                                        {{ measurement_form.custom_name }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    {{ measurement_form.value.label_tag }}
                                    {{ measurement_form.value }}
                                </div>
                                <div class="col-md-5">
                                    {{ measurement_form.unit_option.label_tag }}
                                    <div class="mb-2">
                                        <div class="btn-group w-100" role="group" aria-label="Välj enhet">
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_mm" value="mm" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_mm">mm</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_gram" value="gram" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_gram">gram</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_grader" value="grader" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_grader">grader</label>
                                            
                                            <input type="radio" class="btn-check" name="unit_option" id="unit_ovrig" value="ovrig" autocomplete="off">
                                            <label class="btn btn-outline-primary btn-sm" for="unit_ovrig">Övrig</label>
                                        </div>
                                    </div>
                                    {{ measurement_form.unit }}
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-1"></i>
                                        <span class="d-none d-md-inline">Lägg till</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Batch-måttformulär (dolt från början) -->
                    <div class="measurement-form mt-3" id="batchMeasurementFormContainer" style="display:none;">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Batch-läggning av mått:</strong> Fyll i värdena nedan och klicka "Lägg till alla" för att lägga till alla mått samtidigt. Måtten sparas direkt och visas i tabellen nedan.
                        </div>
                        <h6 class="mb-3">Lägg till flera mått från mall</h6>
                        <form id="batchMeasurementForm" method="post" action="{% url 'add_measurements_from_template' axe.pk %}">
                            {% csrf_token %}
                            <div id="batchMeasurementRows"></div>
                            <div class="text-end mt-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>Lägg till mått
                                </button>
                                <button type="button" class="btn btn-link text-danger" data-action="hideBatchForm">Avbryt</button>
                            </div>
                        </form>
                    </div>

                    <!-- Befintliga mått med inline-redigering -->
                    <div class="table-responsive measurement-list" {% if not measurements %}style="display:none;"{% endif %}>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Måtttyp</th>
                                    <th>Värde</th>
                                    <th>Enhet</th>
                                    <th>Åtgärder</th>
                                </tr>
                            </thead>
                            <tbody id="measurementsTableBody">
                                {% for measurement in measurements %}
                                <tr data-measurement-id="{{ measurement.id }}">
                                    <td class="measurement-name">{{ measurement.name }}</td>
                                    <td class="measurement-value">{{ measurement.value|format_decimal }}</td>
                                    <td class="measurement-unit">{{ measurement.unit }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-edit-measurement" 
                                                    data-measurement-id="{{ measurement.id }}"
                                                    data-name="{{ measurement.name }}"
                                                    data-value="{{ measurement.value|format_decimal }}"
                                                    data-unit="{{ measurement.unit }}"
                                                    title="Redigera mått">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger btn-delete-measurement" 
                                                    data-measurement-id="{{ measurement.id }}"
                                                    title="Ta bort mått">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="measurement-empty-state text-center py-3" {% if measurements %}style="display:none;"{% endif %}>
                        <i class="fas fa-ruler fa-2x mb-2"></i><br>
                        <p class="text-muted">Inga mått registrerade än. Lägg till ditt första mått ovan.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.upload-area {
    border: 2px dashed var(--bs-border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background-color: var(--bs-secondary-bg);
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--bs-primary);
    background-color: var(--bs-primary-bg-subtle);
}

.upload-area input[type="file"] {
    display: none;
}

.preview-item {
    position: relative;
    margin-bottom: 1rem;
}

.preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item .remove-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 12px;
    cursor: pointer;
}

.preview-item .remove-btn:hover {
    background: #c82333;
}

/* Måttsektion CSS */
.measurement-form {
    background-color: var(--bs-secondary-bg);
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}



.template-btn {
    margin: 0.25rem;
}

/* Mobiloptimeringar */
@media (max-width: 768px) {
    .mobile-upload-buttons {
        justify-content: center;
    }
    
    .mobile-upload-buttons .btn {
        flex: 1;
        min-width: 120px;
    }
    
    .preview-item {
        margin-bottom: 0.5rem;
    }
    
    .preview-item img {
        height: 120px;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 0.375rem 0.75rem;
    }
}

/* Animation för URL-input */
.url-input-enter {
    animation: slideDown 0.3s ease-out;
}

.url-input-exit {
    animation: slideUp 0.3s ease-in;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideUp {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
    }
}

.overlay-remove-indicator {
    padding: 0.75rem !important;
    box-sizing: border-box;
}

.preview-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.preview-item:active {
    cursor: grabbing;
}

.preview-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.preview-item[draggable="true"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Drag & drop för befintliga bilder */
.existing-image-item {
    cursor: grab;
    transition: transform 0.2s ease;
}

.existing-image-item:active {
    cursor: grabbing;
}

.existing-image-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.existing-image-item.drag-over {
    border: 2px dashed #007bff;
    transform: scale(1.05);
}

.existing-image-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Stilar för bilder markerade för borttagning */
.existing-image-item.marked-for-deletion {
    opacity: 0.6;
    filter: grayscale(50%);
    position: relative;
}

.existing-image-item.marked-for-deletion::before {
    content: "MARKERAD FÖR BORTTAGNING";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(220, 53, 69, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    z-index: 10;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.existing-image-item.marked-for-deletion .card {
    border: 2px solid #dc3545;
}

.existing-image-item.marked-for-deletion .btn-danger {
    background-color: #6c757d;
    border-color: #6c757d;
}

.existing-image-item.marked-for-deletion .delete-image-btn {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
}

.existing-image-item.marked-for-deletion .delete-image-btn:hover {
    background-color: #218838 !important;
    border-color: #1e7e34 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // === GLOBALA FUNKTIONER ===
    
    // === NOTIFIKATIONER ===
    function showNotification(message, type) {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        
        if (notification && notificationMessage) {
            notification.className = `alert alert-${type === 'error' ? 'danger' : type}`;
            notificationMessage.textContent = message;
            notification.style.display = 'block';
            
            // Dölj notifikationen efter 5 sekunder
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    }
    
            // === TA BORT BILD (flera bilder) ===
        window.removeExistingImage = function(imageId) {
            // Kontrollera om bilden redan är markerad för borttagning
            const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imageElement && imageElement.classList.contains('marked-for-deletion')) {
                // Om bilden redan är markerad, ångra borttagningen
                undoImageDeletion(imageId);
                return;
            }
            
            // Lägg till en dold input för att markera bilden som borttagen
            const hiddenInputs = document.getElementById('hiddenInputs');
            if (hiddenInputs) {
                // Kontrollera om denna bild redan är markerad för borttagning
                const existingInputs = hiddenInputs.querySelectorAll(`input[name="remove_images"][value="${imageId}"]`);
                if (existingInputs.length === 0) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'remove_images';
                    hiddenInput.value = imageId;
                    hiddenInputs.appendChild(hiddenInput);
                }
            }
            
            // Markera bilden visuellt för borttagning istället för att ta bort den från DOM
            if (imageElement) {
                imageElement.classList.add('marked-for-deletion');
                // Uppdatera X-knappen för denna bild
                const deleteBtn = imageElement.querySelector('.delete-image-btn');
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.title = 'Ångra borttagning';
                    deleteBtn.innerHTML = '<i class="fas fa-undo"></i>';
                }
                // Visa notifikation
                showNotification('Bild markerad för borttagning - kommer att tas bort när du sparar yxan', 'success');
            }
        };
    
    // === ÅNGRA BILDBORTTAGNING ===
    function undoImageDeletion(imageId) {
        // Ta bort den dolda input:en för denna bild
        const hiddenInputs = document.getElementById('hiddenInputs');
        if (hiddenInputs) {
            const existingInputs = hiddenInputs.querySelectorAll(`input[name="remove_images"][value="${imageId}"]`);
            existingInputs.forEach(input => input.remove());
        }
        
        // Ta bort visuell markering
        const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
        if (imageElement) {
            imageElement.classList.remove('marked-for-deletion');
            // Återställ X-knappen för denna bild
            const deleteBtn = imageElement.querySelector('.delete-image-btn');
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.title = 'Ta bort bild';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            }
            // Visa notifikation
            showNotification('Borttagning av bild ångrad', 'success');
        }
    }

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.querySelector('input[type="file"]');
    const cameraInput = document.getElementById('cameraInput');
    const selectFileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('previewContainer');
    const imageUrlInput = document.getElementById('imageUrl');
    const addUrlBtn = document.getElementById('addUrlBtn');
    const urlInputSection = document.getElementById('urlInputSection');
    const selectedItems = new Map(); // Map för att hålla reda på både filer och URL:er

    // Mobilvänliga funktioner
    window.openCamera = function() {
        cameraInput.click();
    };

    window.selectFiles = function() {
        selectFileInput.click();
    };

    window.toggleUrlInput = function() {
        if (!urlInputSection) {
            return;
        }
        
        if (urlInputSection.style.display === 'none' || urlInputSection.style.display === '') {
            urlInputSection.style.display = 'block';
            urlInputSection.classList.add('url-input-enter');
            if (imageUrlInput) {
                imageUrlInput.focus();
            }
        } else {
            urlInputSection.classList.add('url-input-exit');
            setTimeout(() => {
                urlInputSection.style.display = 'none';
                urlInputSection.classList.remove('url-input-exit');
            }, 300);
        }
    };

    // Kamerainput hantering
    cameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        cameraInput.value = '';
    });

    // Filval input hantering
    selectFileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        // Rensa input för att tillåta samma fil igen
        selectFileInput.value = '';
    });

    // Drag & drop funktionalitet (endast desktop)
    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Hantera filer
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
            
            // Hantera URL:er - testa olika format
            let urlText = e.dataTransfer.getData('text');
            if (!urlText) {
                urlText = e.dataTransfer.getData('url');
            }
            if (!urlText) {
                // Försök extrahera URL från HTML
                const html = e.dataTransfer.getData('text/html');
                if (html) {
                    const urlMatch = html.match(/href=["']([^"']+)["']/);
                    if (urlMatch) {
                        urlText = urlMatch[1];
                    }
                }
            }
            
            if (urlText && isImageUrl(urlText)) {
                handleImageUrl(urlText);
            }
        });
    }

    // Filval via input
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
    }

    // Bilduppladdningsfunktioner
    function handleFiles(files) {
        files.forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    addImagePreview(file, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function handleImageUrl(url) {
        if (isImageUrl(url)) {
            addImagePreview(null, url, url);
        }
    }

    function isImageUrl(text) {
        // Kontrollera om det är en giltig URL
        try {
            const url = new URL(text);
        } catch (e) {
            return false;
        }
        
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp'];
        const url = text.toLowerCase();
        const hasImageExtension = imageExtensions.some(ext => url.includes(ext));
        const isKnownSite = url.includes('tradera.com') || 
                           url.includes('ebay.com') ||
                           url.includes('blocket.se') ||
                           url.includes('facebook.com') ||
                           url.includes('instagram.com');
        
        return hasImageExtension || isKnownSite;
    }

    function addImagePreview(file, dataUrl, url = null) {
        
        const previewDiv = document.createElement('div');
        previewDiv.className = 'col-6 col-md-3 mb-3 preview-item';
        
        // För URL-bilder, försök ladda ner och visa bilden
        if (url && !file) {
            // Lägg till previewDiv i containern först
            previewContainer.appendChild(previewDiv);
            imagePreview.style.display = 'block';
            
            // Visa en laddningsindikator medan vi försöker ladda bilden
            previewDiv.innerHTML = `
                <div class="card position-relative">
                                            <div class="text-center p-3" style="background: var(--bs-secondary-bg); height: 150px; display: flex; align-items: center; justify-content: center;">
                        <div>
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-2"></i>
                            <br><small class="text-muted">Laddar bild...</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Skapa en temporär img-element för att testa om bilden kan laddas
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            
            tempImg.onload = function() {
                // Bilden laddades framgångsrikt, visa den
                previewDiv.innerHTML = `
                    <div class="card position-relative">
                        <img src="${url}" class="card-img-top" alt="URL-förhandsvisning" style="height: 150px; object-fit: cover;" crossorigin="anonymous">
                        <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-body p-2">
                            <small class="text-muted">URL-bild</small>
                        </div>
                    </div>
                `;
            };
            
            tempImg.onerror = function() {
                // Bilden kunde inte laddas, visa fallback
                previewDiv.innerHTML = `
                    <div class="card position-relative">
                        <div class="text-center p-3" style="background: var(--bs-secondary-bg); height: 150px; display: flex; align-items: center; justify-content: center;">
                            <div>
                                <i class="fas fa-link fa-2x text-muted mb-2"></i>
                                <br><small class="text-muted">URL-bild</small>
                                <br><small class="text-muted">Kommer att laddas på servern</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="card-body p-2">
                            <small class="text-muted">${url}</small>
                        </div>
                    </div>
                `;
            };
            
            // Starta laddningen
            tempImg.src = url;
        } else {
            previewDiv.innerHTML = `
                <div class="card position-relative">
                    <img src="${dataUrl}" class="card-img-top" alt="Förhandsvisning" style="height: 150px; object-fit: cover;">
                    <button type="button" class="btn btn-danger btn-sm position-absolute" style="top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%;" onclick="removePreview(this)">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="card-body p-2">
                        <small class="text-muted">${file ? file.name : 'URL-bild'}</small>
                    </div>
                </div>
            `;
        }
        
        // Spara referens till fil eller URL
        const itemId = Date.now() + Math.random();
        selectedItems.set(itemId, { file, url, element: previewDiv });
        previewDiv.dataset.itemId = itemId;
        
        // Lägg till previewDiv i containern (endast för filer, URL:er hanteras separat)
        if (!url || file) {
            previewContainer.appendChild(previewDiv);
            imagePreview.style.display = 'block';
        }
    }

    window.removePreview = function(button) {
        const previewItem = button.closest('.preview-item');
        const itemId = previewItem.dataset.itemId;
        selectedItems.delete(itemId);
        previewItem.remove();
        
        if (previewContainer.children.length === 0) {
            imagePreview.style.display = 'none';
        }
    };

    // Kontaktsökning
    const contactSearchInput = document.getElementById('{{ form.contact_search.id_for_label }}');
    const newContactSection = document.getElementById('newContactSection');
    const contactSearchResults = document.getElementById('contactSearchResults');
    let contactSearchTimeout;
    
    if (contactSearchInput) {
        contactSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            
            // Rensa tidigare timeout
            clearTimeout(contactSearchTimeout);
            
            if (searchValue.length >= 2) {
                // Debounce sökningen
                contactSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_contacts' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.results.length > 0) {
                                // Visa dropdown med resultat
                                showContactResults(data.results);
                                newContactSection.style.display = 'none';
                            } else {
                                // Inga resultat, visa ny kontaktsektion
                                hideContactResults();
                                showNewContactSection(searchValue);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            hideContactResults();
                            showNewContactSection(searchValue);
                        });
                }, 300);
            } else {
                hideContactResults();
                newContactSection.style.display = 'none';
            }
        });
        
        // Visa ny kontaktsektion om användaren börjar skriva i namn-fältet
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        if (contactNameInput) {
            contactNameInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    hideContactResults();
                    showNewContactSection(this.value.trim());
                }
            });
        }
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!contactSearchInput.contains(e.target) && !contactSearchResults.contains(e.target)) {
                hideContactResults();
            }
        });
    }
    
    function showContactResults(results) {
        contactSearchResults.innerHTML = '';
        results.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <div>
                    <strong>${contact.name}</strong>
                    ${contact.alias ? `<br><small class="text-muted">${contact.alias}</small>` : ''}
                    ${contact.email ? `<br><small class="text-muted">${contact.email}</small>` : ''}
                    ${contact.phone ? `<br><small class="text-muted">${contact.phone}</small>` : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                contactSearchInput.value = contact.name;
                hideContactResults();
                const newContactSection = document.getElementById('newContactSection');
                if (newContactSection) {
                    newContactSection.style.display = 'none';
                }
            });
            contactSearchResults.appendChild(item);
        });
        contactSearchResults.style.display = 'block';
    }
    
    function hideContactResults() {
        contactSearchResults.style.display = 'none';
    }
    
    // Funktioner för att visa/dölja sektioner för nya kontakter och plattformar
    function showNewContactSection(searchValue = '') {
        hideContactResults();
        const newContactSection = document.getElementById('newContactSection');
        const contactNameInput = document.getElementById('{{ form.contact_name.id_for_label }}');
        
        if (newContactSection) {
            newContactSection.style.display = 'block';
        }
        
        if (contactNameInput && searchValue) {
            contactNameInput.value = searchValue;
        }
    }
    
    window.showNewPlatformSection = function(searchValue = '') {
        const platformSearchResults = document.getElementById('platformSearchResults');
        const newPlatformSection = document.getElementById('newPlatformSection');
        const platformNameInput = document.getElementById('{{ form.platform_name.id_for_label }}');
        const platformUrlInput = document.getElementById('{{ form.platform_url.id_for_label }}');
        const platformCommentInput = document.getElementById('{{ form.platform_comment.id_for_label }}');
        
        if (platformSearchResults) {
            platformSearchResults.style.display = 'none';
        }
        
        if (newPlatformSection) {
            newPlatformSection.style.display = 'block';
        }
        
        if (platformNameInput) {
            platformNameInput.value = searchValue;
            platformNameInput.focus();
        }
        if (platformUrlInput) {
            platformUrlInput.value = '';
        }
        if (platformCommentInput) {
            platformCommentInput.value = '';
        }
    };

    // Plattformssökning
    const platformSearchInput = document.getElementById('{{ form.platform_search.id_for_label }}');
    const platformSearchResults = document.getElementById('platformSearchResults');
    let platformSearchTimeout;
    
    if (platformSearchInput) {
        platformSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            clearTimeout(platformSearchTimeout);
            if (searchValue.length >= 2) {
                platformSearchTimeout = setTimeout(() => {
                    fetch(`{% url 'search_platforms' %}?q=${encodeURIComponent(searchValue)}`)
                        .then(response => response.json())
                        .then(data => {
                            platformSearchResults.innerHTML = '';
                            if (data.results && data.results.length > 0) {
                                // Visa dropdown med resultat
                                data.results.forEach(platform => {
                                    const item = document.createElement('div');
                                    item.className = 'dropdown-item';
                                    item.innerHTML = `<div><strong>${platform.name}</strong></div>`;
                                    item.addEventListener('click', () => {
                                        platformSearchInput.value = platform.name;
                                        platformSearchResults.style.display = 'none';
                                        const newPlatformSection = document.getElementById('newPlatformSection');
                                        if (newPlatformSection) {
                                            newPlatformSection.style.display = 'none';
                                        }
                                    });
                                    platformSearchResults.appendChild(item);
                                });
                                platformSearchResults.style.display = 'block';
                            } else {
                                // Om ingen match, visa "Skapa ny"
                                const newId = 'showNewPlatformLink_' + Date.now();
                                platformSearchResults.innerHTML = `
                                    <div class="dropdown-item">
                                        <a href="#" class="text-decoration-none text-dark" id="${newId}">
                                            <i class="fas fa-plus-circle me-1"></i> Skapa ny plattform: "${searchValue}"
                                        </a>
                                    </div>
                                `;
                                platformSearchResults.style.display = 'block';
                                setTimeout(() => {
                                    const link = document.getElementById(newId);
                                    if (link) {
                                        link.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            showNewPlatformSection(searchValue);
                                        });
                                    }
                                }, 0);
                            }
                        })
                        .catch(error => {
                            console.error('Sökfel:', error);
                            platformSearchResults.innerHTML = `
                                <div class="dropdown-item text-danger">
                                    Fel vid sökning: ${error.message}
                                </div>
                            `;
                            platformSearchResults.style.display = 'block';
                        });
                }, 300);
            } else {
                platformSearchResults.style.display = 'none';
            }
        });
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!platformSearchInput.contains(e.target) && !platformSearchResults.contains(e.target)) {
                platformSearchResults.style.display = 'none';
            }
        });
    }

    // === DRAG & DROP FÖR BEFINTLIGA BILDER ===
    const existingImagesContainer = document.getElementById('existingImagesContainer');
    let draggedExisting = null;

    if (existingImagesContainer) {
        existingImagesContainer.querySelectorAll('.existing-image-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedExisting = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedExisting = null;
            });
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedExisting && draggedExisting !== this) {
                    // Flytta elementet i DOM
                    if (Array.from(existingImagesContainer.children).indexOf(draggedExisting) < Array.from(existingImagesContainer.children).indexOf(this)) {
                        this.after(draggedExisting);
                    } else {
                        this.before(draggedExisting);
                    }
                }
            });
        });
    }



    // URL-hantering
    if (addUrlBtn && imageUrlInput) {
        addUrlBtn.addEventListener('click', () => {
            const url = imageUrlInput.value.trim();
            if (url) {
                handleImageUrl(url);
                imageUrlInput.value = '';
                // Visa notifikation
                showNotification('URL-bild tillagd', 'success');
            } else {
                showNotification('Ange en giltig URL', 'error');
            }
        });

        imageUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addUrlBtn.click();
            }
        });
        
        // Lägg till paste-hantering för URL-input
        imageUrlInput.addEventListener('paste', (e) => {
            setTimeout(() => {
                const pastedText = imageUrlInput.value.trim();
                if (pastedText && isImageUrl(pastedText)) {
                    handleImageUrl(pastedText);
                    imageUrlInput.value = '';
                    showNotification('URL-bild tillagd från klistrad text', 'success');
                }
            }, 100);
        });
    }

    // Klistra in hantering
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                handleFiles([file]);
            }
        }
    });

    // Transaktionstyp-beräkning
    const transactionPriceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
    const transactionTypeBadge = document.getElementById('transaction-type-badge');
    
    if (transactionPriceInput && transactionTypeBadge) {
        transactionPriceInput.addEventListener('input', function() {
            const value = parseFloat(this.value) || 0;
            if (value < 0) {
                transactionTypeBadge.textContent = 'KÖP';
                transactionTypeBadge.className = 'input-group-text ms-2 bg-danger text-white';
            } else if (value > 0) {
                transactionTypeBadge.textContent = 'SÄLJ';
                transactionTypeBadge.className = 'input-group-text ms-2 bg-success text-white';
            } else {
                transactionTypeBadge.textContent = '';
                transactionTypeBadge.className = 'input-group-text ms-2';
            }
        });
    }

    // Formulärhantering - Lägg till bilder i formuläret innan submit
    const submitButton = document.getElementById('submitButton');
    
    // Funktion för att förbereda formuläret
    function prepareFormForSubmit() {
        // Skapa en DataTransfer för att lägga till filer i file input
        const dataTransfer = new DataTransfer();
        
        // Lägg till alla förhandsvisade bilder
        selectedItems.forEach((item, itemId) => {
            if (item.file) {
                dataTransfer.items.add(item.file);
            }
        });
        
        // Lägg till filerna i det ursprungliga file input
        if (fileInput) {
            fileInput.files = dataTransfer.files;
        }
        
        // Lägg till URL:er som dolda inputs
        const hiddenInputs = document.getElementById('hiddenInputs');
        if (hiddenInputs) {
            // Ta bara bort URL-inputs, behåll bildborttagnings-inputs och bildordnings-inputs
            const removeImageInputs = hiddenInputs.querySelectorAll('input[name="remove_images"]');
            const imageOrderInputs = hiddenInputs.querySelectorAll('input[name="image_order"]');
            hiddenInputs.innerHTML = '';
            // Återställ bildborttagnings-inputs
            removeImageInputs.forEach(input => {
                hiddenInputs.appendChild(input);
            });
            
            // Hantera bildordning för befintliga bilder
            if (existingImagesContainer) {
                Array.from(existingImagesContainer.children).forEach((item, idx) => {
                    const imageId = item.getAttribute('data-image-id');
                    if (imageId) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'image_order';
                        input.value = imageId + ':' + (idx + 1);
                        hiddenInputs.appendChild(input);
                    }
                });
            }
            
            selectedItems.forEach((item, itemId) => {
                if (item.url) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'image_urls';
                    hiddenInput.value = item.url;
                    hiddenInputs.appendChild(hiddenInput);
                }
            });
            
            // Lägg till auktionsbilder om de finns
            if (window.auctionImages && window.auctionImages.length > 0) {
                window.auctionImages.forEach(imageUrl => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'auction_images';
                    hiddenInput.value = imageUrl;
                    hiddenInputs.appendChild(hiddenInput);
                });
            }
        }
    }
    
    if (axeForm) {
        axeForm.addEventListener('submit', function(e) {
            prepareFormForSubmit();
            
            // Debug: Logga vad som skickas
            const removeImageInputs = document.querySelectorAll('input[name="remove_images"]');
            console.log('Bilder markerade för borttagning:', Array.from(removeImageInputs).map(input => input.value));
        });
    }
    
    // Lägg till click-lyssnare på submit-knappen
    if (submitButton) {
        submitButton.addEventListener('click', function(e) {
            prepareFormForSubmit();
            // Manuellt trigga formuläret
            axeForm.submit();
        });
    }

    // === URL-PARSNING ===
    
    // URL-parsning funktionalitet
    const parseUrlBtn = document.getElementById('parseUrlBtn');
    const auctionUrlInput = document.getElementById('auction_url');
    const parsedDataSection = document.getElementById('parsedDataSection');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const parsedTitle = document.getElementById('parsedTitle');
    const parsedSeller = document.getElementById('parsedSeller');
    const parsedPrice = document.getElementById('parsedPrice');
    
    // Funktion för att hämta valutasymbol
    function getCurrencySymbol(currency) {
        const symbols = {
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'SEK': 'kr'
        };
        return symbols[currency] || currency;
    }
    
    // Funktion för att hämta uppskattade kurser
    function getEstimatedRate(currency) {
        const rates = {
            'USD': 10.5,
            'EUR': 11.4,
            'GBP': 13.2
        };
        return rates[currency] || 1.0;
    }
    
    // Funktion för att konvertera pris till SEK
    function convertPriceToSek(amount, currency) {
        const rate = getEstimatedRate(currency);
        return Math.round(amount * rate);
    }
    
    // Funktion för att hämta valutainformation
    function getCurrencyInfo(currency) {
        const currencyInfo = {
            'USD': { name: 'US Dollar', symbol: '$' },
            'EUR': { name: 'Euro', symbol: '€' },
            'GBP': { name: 'British Pound', symbol: '£' },
            'SEK': { name: 'Swedish Krona', symbol: 'kr' }
        };
        return currencyInfo[currency] || { name: currency, symbol: currency };
    }
    
    if (parseUrlBtn && auctionUrlInput) {
        parseUrlBtn.addEventListener('click', function() {
            const url = auctionUrlInput.value.trim();
            
            if (!url) {
                showError('Ange en auktions-URL');
                return;
            }
            
            if (!url.includes('tradera.com') && !url.includes('ebay.com') && !url.includes('ebay.co.uk') && !url.includes('ebay.de') && !url.includes('ebay.se')) {
                showError('Endast Tradera och eBay-auktions-URL:er stöds för närvarande');
                return;
            }
            
            // Visa laddningsindikator
            showLoading();
            
            // Skicka AJAX-förfrågan
            fetch('{% url "axe_create" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: new URLSearchParams({
                    'auction_url': url,
                    'parse_only': 'true'
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    // Visa extraherad data
                    if (parsedTitle) parsedTitle.textContent = data.auction_data.title;
                    if (parsedSeller) parsedSeller.textContent = data.auction_data.seller_alias;
                    
                    // Visa slutdatum
                    const endDate = data.auction_data.auction_end_date;
                    const parsedEndDateElement = document.getElementById('parsedEndDate');
                    if (endDate && parsedEndDateElement) {
                        // Formatera datum till svenskt format
                        const date = new Date(endDate);
                        const formattedDate = date.toLocaleDateString('sv-SE');
                        parsedEndDateElement.textContent = formattedDate;
                    } else if (parsedEndDateElement) {
                        parsedEndDateElement.textContent = 'N/A';
                    }
                    
                    // Hantera pris och valuta
                    const priceData = data.auction_data.prices.find(p => p.label === 'Slutpris' || p.label === 'Pris');
                    if (priceData && priceData.amount) {
                        const currency = priceData.currency || 'SEK';
                        const currencySymbol = getCurrencySymbol(currency);
                        if (parsedPrice) parsedPrice.textContent = `${priceData.amount} ${currencySymbol}`;
                        
                        const parsedCurrencyElement = document.getElementById('parsedCurrency');
                        if (parsedCurrencyElement) parsedCurrencyElement.textContent = currency;
                        
                        // Spara priceData för konvertering
                        window.currentPriceData = priceData;
                        
                        // Visa valutainformation om det inte är SEK
                        if (currency !== 'SEK') {
                            const currencyInfo = getCurrencyInfo(currency);
                            const warningText = `Priset är i ${currency} (${currencyInfo.name}) men systemet använder SEK. Du kan konvertera priset eller ange en egen kurs.`;
                            
                            const currencyWarningTextElement = document.getElementById('currencyWarningText');
                            if (currencyWarningTextElement) currencyWarningTextElement.textContent = warningText;
                            
                            const currencyWarningElement = document.getElementById('currencyWarning');
                            if (currencyWarningElement) currencyWarningElement.style.display = 'block';
                            
                            // Visa live kurs och timestamp
                            const estimatedRate = getEstimatedRate(currency);
                            const conversionRateElement = document.getElementById('conversionRate');
                            if (conversionRateElement) conversionRateElement.textContent = `1 ${currency} ≈ ${estimatedRate} SEK`;
                            
                            const lastUpdatedElement = document.getElementById('lastUpdated');
                            if (lastUpdatedElement) lastUpdatedElement.textContent = new Date().toLocaleString('sv-SE');
                            
                            // Sätt valutasymbol för manuell kurs
                            const manualCurrencySymbolElement = document.getElementById('manualCurrencySymbol');
                            if (manualCurrencySymbolElement) manualCurrencySymbolElement.textContent = currency;
                        } else {
                            const currencyWarningElement = document.getElementById('currencyWarning');
                            if (currencyWarningElement) currencyWarningElement.style.display = 'none';
                        }
                    } else {
                        if (parsedPrice) parsedPrice.textContent = 'N/A';
                        const parsedCurrencyElement = document.getElementById('parsedCurrency');
                        if (parsedCurrencyElement) parsedCurrencyElement.textContent = 'N/A';
                        
                        const currencyWarningElement = document.getElementById('currencyWarning');
                        if (currencyWarningElement) currencyWarningElement.style.display = 'none';
                        window.currentPriceData = null;
                    }
                    
                    // Beskrivning hanteras inte längre - användaren får titeln som utgångspunkt
                    
                    // Fyll i formulärfält
                    fillFormWithParsedData(data.auction_data);
                    
                    // Visa sektionen med extraherad data
                    parsedDataSection.style.display = 'block';
                    hideError();
                } else {
                    showError(data.error || 'Kunde inte hämta auktionsdata');
                }
            })
            .catch(error => {
                hideLoading();
                showError('Ett fel uppstod vid hämtning av auktionsdata: ' + error.message);
            });
        });
        
        // Automatisk parsning när användaren klistrar in URL
        auctionUrlInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                const url = this.value.trim();
                if (url && (url.includes('tradera.com') || url.includes('ebay.com') || url.includes('ebay.co.uk') || url.includes('ebay.de') || url.includes('ebay.se'))) {
                    parseUrlBtn.click();
                }
            }, 100);
        });
        
        // Hantera automatisk konvertering till SEK
        const convertToSekBtn = document.getElementById('convertToSekBtn');
        if (convertToSekBtn) {
            convertToSekBtn.addEventListener('click', function() {
                const priceData = window.currentPriceData;
                if (priceData && priceData.currency !== 'SEK') {
                    const sekAmount = convertPriceToSek(priceData.amount, priceData.currency);
                    const currencySymbol = getCurrencySymbol(priceData.currency);
                    
                    // Uppdatera visningen
                    const parsedPriceElement = document.getElementById('parsedPrice');
                    if (parsedPriceElement) parsedPriceElement.textContent = `${sekAmount} kr`;
                    
                    const parsedCurrencyElement = document.getElementById('parsedCurrency');
                    if (parsedCurrencyElement) parsedCurrencyElement.textContent = 'SEK';
                    
                    // Fyll i formulärfältet för transaktion
                    const transactionPriceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
                    if (transactionPriceInput) {
                        transactionPriceInput.value = sekAmount;
                    }
                    
                    // Visa bekräftelse
                    const warningDiv = document.getElementById('currencyWarning');
                    if (warningDiv) {
                        warningDiv.className = 'alert alert-success mt-3';
                        warningDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            <span>Priset har konverterats automatiskt: ${priceData.amount} ${currencySymbol} → ${sekAmount} kr</span>
                        `;
                    }
                }
            });
        }
        
        // Hantera manuell SEK-inmatning
        const manualSekBtn = document.getElementById('manualSekBtn');
        const manualSekInput = document.getElementById('manualSekInput');
        const applyManualSekBtn = document.getElementById('applyManualSekBtn');
        
        if (manualSekBtn) {
            manualSekBtn.addEventListener('click', function() {
                if (manualSekInput) manualSekInput.style.display = 'block';
                const manualSekValueElement = document.getElementById('manualSekValue');
                if (manualSekValueElement) manualSekValueElement.focus();
            });
        }
        
        if (applyManualSekBtn) {
            applyManualSekBtn.addEventListener('click', function() {
                const manualSekValueElement = document.getElementById('manualSekValue');
                const manualValue = manualSekValueElement ? manualSekValueElement.value : '';
                if (manualValue && !isNaN(manualValue)) {
                    const sekAmount = parseInt(manualValue);
                    
                    // Uppdatera visningen
                    const parsedPriceElement = document.getElementById('parsedPrice');
                    if (parsedPriceElement) parsedPriceElement.textContent = `${sekAmount} kr`;
                    
                    const parsedCurrencyElement = document.getElementById('parsedCurrency');
                    if (parsedCurrencyElement) parsedCurrencyElement.textContent = 'SEK';
                    
                    // Fyll i formulärfältet för transaktion
                    const transactionPriceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
                    if (transactionPriceInput) {
                        transactionPriceInput.value = sekAmount;
                    }
                    
                    // Visa bekräftelse
                    const warningDiv = document.getElementById('currencyWarning');
                    if (warningDiv) {
                        warningDiv.className = 'alert alert-success mt-3';
                        warningDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            <span>Manuellt belopp använt: ${sekAmount} kr</span>
                        `;
                    }
                } else {
                    alert('Ange ett giltigt belopp i SEK');
                }
            });
        }
    }
    
    function showLoading() {
        loadingIndicator.style.display = 'block';
        parsedDataSection.style.display = 'none';
        hideError();
        
        // Dölj info-badge när vi börjar en ny parsning
        const contactMatchInfo = document.getElementById('contact-match-info');
        if (contactMatchInfo) {
            contactMatchInfo.style.display = 'none';
        }
    }
    
    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }
    
    function showError(message) {
        errorMessage.style.display = 'block';
        document.getElementById('errorText').textContent = message;
        parsedDataSection.style.display = 'none';
        hideLoading();
    }
    
    function hideError() {
        errorMessage.style.display = 'none';
    }
    
    function fillFormWithParsedData(data) {
        // Fyll i modellnamn
        const modelInput = document.getElementById('{{ form.model.id_for_label }}');
        if (modelInput && data.title) {
            modelInput.value = data.title;
        }
        
        // Fyll i kommentar/beskrivning med titeln istället
        const commentInput = document.getElementById('{{ form.comment.id_for_label }}');
        if (commentInput && data.title) {
            commentInput.value = data.title;
        }
        
        // Fyll i auktions-URL
        const auctionUrlInput = document.getElementById('auction_url');
        if (auctionUrlInput && data.url) {
            auctionUrlInput.value = data.url;
        }
        
        // Hantera kontaktinformation och matchning
        const contactAliasInput = document.getElementById('{{ form.contact_alias.id_for_label }}');
        const contactSearchInput = document.getElementById('{{ form.contact_search.id_for_label }}');
        
        if (data.seller_alias) {
            // Sätt alias i kontaktfältet
            if (contactAliasInput) {
                contactAliasInput.value = data.seller_alias;
            }
            
            // Om det finns matchande kontakter, hantera dem
            if (data.matching_contacts && data.matching_contacts.length > 0) {
                if (data.matching_contacts.length === 1) {
                    // Om det finns exakt en matchning, sätt den i sökfältet
                    const contact = data.matching_contacts[0];
                    if (contactSearchInput) {
                        contactSearchInput.value = contact.name;
                    }
                }
                showMatchingContacts(data.matching_contacts, data.seller_alias);
            } else {
                // Om ingen matchning hittades, sätt säljarens namn i sökfältet
                if (contactSearchInput) {
                    contactSearchInput.value = data.seller_alias;
                }
                // Visa notis om att ingen kontakt matchades och visa kontaktformuläret
                showNoContactMatch(data.seller_alias);
            }
        }
        
        // Sätt transaktionspris (negativt för köp)
        const transactionPriceInput = document.getElementById('{{ form.transaction_price.id_for_label }}');
        if (transactionPriceInput) {
            const finalPrice = data.prices.find(p => p.label === 'Slutpris' || p.label === 'Pris');
            if (finalPrice) {
                // Om priset är i annan valuta än SEK, konvertera det
                let priceAmount = finalPrice.amount;
                if (finalPrice.currency && finalPrice.currency !== 'SEK') {
                    priceAmount = convertPriceToSek(finalPrice.amount, finalPrice.currency);
                }
                transactionPriceInput.value = -priceAmount; // Negativt för köp
                // Manuellt trigga badge-uppdatering
                const event = new Event('input', { bubbles: true });
                transactionPriceInput.dispatchEvent(event);
            }
        }
        
        // Sätt transaktionsdatum
        const transactionDateInput = document.getElementById('{{ form.transaction_date.id_for_label }}');
        if (transactionDateInput && data.auction_end_date) {
            transactionDateInput.value = data.auction_end_date;
        }
        
        // Sätt plattform till Tradera (använd platform_search istället för platform)
        const platformSearchInput = document.getElementById('{{ form.platform_search.id_for_label }}');
        if (platformSearchInput && data.platform_id) {
            // Hitta Tradera-plattformen och sätt dess namn i sökfältet
            platformSearchInput.value = 'Tradera';
        }
        
        // Hantera auktionsbilder
        if (data.images && data.images.length > 0) {
            // Spara bilderna för att skicka med formuläret
            window.auctionImages = data.images;
            
            // Visa förhandsgranskning av auktionsbilderna
            const imagePreview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('previewContainer');
            
            if (imagePreview && previewContainer) {
                // Rensa befintliga förhandsvisningar
                previewContainer.innerHTML = '';
                
                // Lägg till varje auktionsbild som förhandsvisning
                data.images.forEach(imageUrl => {
                    addImagePreview(null, null, imageUrl);
                });
                
                // Visa förhandsvisningssektionen
                imagePreview.style.display = 'block';
            }
            
            // Visa notifikation om att bilder kommer att laddas ner
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            
            if (notification && notificationMessage) {
                notification.className = 'alert alert-info';
                notificationMessage.innerHTML = `
                    <i class="fas fa-image me-2"></i>
                    <strong>${data.images.length}</strong> auktionsbilder kommer att laddas ner automatiskt när yxan skapas
                `;
                notification.style.display = 'block';
            }
        }
    }
    
    function showMatchingContacts(contacts, sellerAlias) {
        // Dölj info-badge eftersom vi hittade kontakter
        const contactMatchInfo = document.getElementById('contact-match-info');
        if (contactMatchInfo) {
            contactMatchInfo.style.display = 'none';
        }
        
        // Skapa en notifikation om matchande kontakter
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        
        if (notification && notificationMessage) {
            if (contacts.length === 1) {
                const contact = contacts[0];
                notification.className = 'alert alert-info';
                notificationMessage.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Hittade matchande kontakt: <strong>${contact.name}</strong> (${contact.alias})
                    ${contact.city ? `från ${contact.city}` : ''}
                    ${contact.country ? `, ${contact.country}` : ''}
                `;
            } else {
                notification.className = 'alert alert-warning';
                notificationMessage.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Hittade ${contacts.length} matchande kontakter för "${sellerAlias}". 
                    Välj rätt kontakt från listan eller skapa en ny.
                `;
                
                // Visa kontaktformuläret för att skapa ny kontakt om det finns flera matchningar
                const newContactSection = document.getElementById('newContactSection');
                if (newContactSection) {
                    newContactSection.style.display = 'block';
                }
            }
            notification.style.display = 'block';
            
            // Dölj notifikationen efter 10 sekunder
            setTimeout(() => {
                notification.style.display = 'none';
            }, 10000);
        }
    }
    
    function showNoContactMatch(sellerAlias) {
        // Visa info-badge bredvid "Försäljare"-labeln
        const contactMatchInfo = document.getElementById('contact-match-info');
        if (contactMatchInfo) {
            contactMatchInfo.style.display = 'inline-block';
        }
        
        // Visa hela kontaktformuläret direkt
        const newContactSection = document.getElementById('newContactSection');
        if (newContactSection) {
            newContactSection.style.display = 'block';
        }
    }
    
    // === MÅTT-HANTERING ===
    
    // === ENHETSVÄLJARE FÖR MÅTT ===
    const unitRadios = document.querySelectorAll('input[name="unit_option"]');
    const customUnitInput = document.getElementById('measurement-unit');
    
    if (unitRadios.length > 0 && customUnitInput) {
        unitRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'ovrig') {
                    // Visa textfältet för egen enhet
                    customUnitInput.style.display = 'block';
                    customUnitInput.required = true;
                    customUnitInput.value = '';
                    customUnitInput.focus();
                } else {
                    // Dölj textfältet och sätt vald enhet
                    customUnitInput.style.display = 'none';
                    customUnitInput.required = false;
                    customUnitInput.value = this.value;
                }
            });
        });
        
        // Sätt initial enhet baserat på default-värde (mm)
        const mmRadio = document.getElementById('unit_mm');
        if (mmRadio && !document.querySelector('input[name="unit_option"]:checked')) {
            mmRadio.checked = true;
            customUnitInput.value = 'mm';
        }
        
        // Sätt initial enhet baserat på vald radio button
        const selectedRadio = document.querySelector('input[name="unit_option"]:checked');
        if (selectedRadio && selectedRadio.value !== 'ovrig') {
            customUnitInput.value = selectedRadio.value;
        }
    }
    
    // === SMART ENHETS-IFYLLNING BASERAT PÅ MÅTTTYP ===
    const measurementNameSelect = document.getElementById('measurement-name');
    
            // Måtttyper och deras enheter från servern
        const measurementTypesData = {{ measurement_types_data|safe|default:'{}' }};
    
    if (measurementNameSelect && measurementTypesData) {
        measurementNameSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            if (selectedType && selectedType !== 'Övrigt' && measurementTypesData[selectedType]) {
                const recommendedUnit = measurementTypesData[selectedType];
                
                // Hitta motsvarande radio button
                const matchingRadio = document.querySelector(`input[name="unit_option"][value="${recommendedUnit}"]`);
                
                if (matchingRadio) {
                    // Välj motsvarande radio button
                    matchingRadio.checked = true;
                    matchingRadio.dispatchEvent(new Event('change'));
                } else {
                    // Om enheten inte finns bland radio buttons, välj "Övrig" och fyll i enheten
                    const ovrigRadio = document.querySelector('input[name="unit_option"][value="ovrig"]');
                    if (ovrigRadio) {
                        ovrigRadio.checked = true;
                        ovrigRadio.dispatchEvent(new Event('change'));
                        customUnitInput.value = recommendedUnit;
                    }
                }
            }
        });
    }
    
    // Sätt axeId och måttmallar för automatisk initiering
    // window.axeId = {{ axe.pk }}; // Moved to extra_head
    // const measurementTemplates = {{ measurement_templates|safe }}; // Moved to extra_head

    // === STÄMPEL-MODAL-HANTERING ===
    function showUnmarkStampModal(url) {
        fetch(url)
            .then(response => response.text())
            .then(html => {
                const modal = document.getElementById('unmarkStampModal');
                const modalBody = modal.querySelector('.modal-content');
                modalBody.innerHTML = html;
                new bootstrap.Modal(modal).show();
            })
            .catch(error => {
                console.error('Fel vid laddning av modal:', error);
                alert('Ett fel uppstod vid laddning av bekräftelsen.');
            });
    }

});
</script>

<!-- Modal för stämpelmarkering -->
<div class="modal fade" id="unmarkStampModal" tabindex="-1" aria-labelledby="unmarkStampModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal-innehåll laddas dynamiskt -->
        </div>
    </div>
</div>

{% endblock %}