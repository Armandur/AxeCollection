{% extends 'axes/base.html' %}
{% load axe_filters %}

{% block extra_head %}
<style>
    /* Anpassningar specifika för Yxlistan */
    .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .column-toggle {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    #axesTable td:nth-child(4) { /* Kommentar-kolumnen */
        white-space: normal;
    }

    /* Klickbara rader för dator/tablett */
    @media (min-width: 768px) {
        #axesTable tbody tr {
            cursor: pointer;
        }
    }
    
    .profit-positive { color: #198754; }
    .profit-negative { color: #dc3545; }

    .price-buy { color: #dc3545; font-weight: bold; }
    .price-sell { color: #198754; font-weight: bold; }
    .shipping-cost { font-size: 0.8em; color: #6c757d; }

    /* Mobilanpassningar för DataTables */
    @media (max-width: 767px) {
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            width: 100%;
            margin: 0.25rem 0;
        }
        
        /* Ta bort klickbara rader på mobil */
        #axesTable tbody tr {
            cursor: default;
        }
        
        #axesTable tbody tr:hover {
            background-color: transparent !important;
        }
        
        /* Stil för responsiva detaljer */
        .dtr-details {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Gör detaljer-knappen tydligare */
        .dtr-control {
            background-color: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 50% !important;
            width: 24px !important;
            height: 24px !important;
            line-height: 24px !important;
            text-align: center !important;
            font-weight: bold !important;
        }
        
        /* Stil för Visa-knappen i modal */
        .modal-body .btn-primary {
            margin-top: 1rem;
        }
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Samling</h1>
    <a href="{% url 'axe_gallery' %}" class="btn btn-outline-primary">
        <i class="fas fa-images"></i> Visa som galleri
    </a>
</div>

<!-- Statistik-kort -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Antal köp</h6>
                <h4 class="text-danger">{{ total_buys }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Antal försäljningar</h6>
                <h4 class="text-success">{{ total_sales }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Total köpvärde</h6>
                <h4 class="text-danger">{{ total_buy_value|format_decimal }} kr</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Total försäljningsvärde</h6>
                <h4 class="text-success">{{ total_sale_value|format_decimal }} kr</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Total frakt köp</h6>
                <h4 class="text-danger">{{ total_buy_shipping|format_decimal }} kr</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stats-card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title text-muted">Total frakt försäljning</h6>
                <h4 class="text-success">{{ total_sale_shipping|format_decimal }} kr</h4>
            </div>
        </div>
    </div>
</div>

<!-- Total vinst/förlust -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Total vinst/förlust</h5>
                <h2 class="{% if total_profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                    {{ total_profit|format_decimal }} kr
                </h2>
                <small class="text-muted">
                    {{ total_profit_with_shipping|format_decimal }} kr (inkl. frakt)
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Tabell -->
<div class="table-responsive">
    <table id="axesTable" class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Tillverkare</th>
                <th>Modell</th>
                <th>Kommentar</th>
                <th>Ekonomi</th>
                <th>Bilder</th>
            </tr>
        </thead>
        <tbody>
            {% for axe in axes %}
            <tr class="{% if axe.id in sold_axe_ids %}sold-axe{% endif %}" data-href="{% url 'axe_detail' axe.id %}">
                <td>{{ axe.id }}</td>
                <td>{{ axe.manufacturer.name }}</td>
                <td>
                    {{ axe.model }}
                    {% if axe.id in sold_axe_ids %}
                        <span class="badge bg-secondary ms-2">SÅLD</span>
                    {% endif %}
                </td>
                <td>{{ axe.comment|default:"" }}</td>
                <td data-order="{{ axe.net_value|default:0 }}">
                    {% for trans in axe.transaction_set.all %}
                        {% if trans.type == 'KÖP' %}
                            <span class="text-danger">{{ trans.price|format_decimal }} kr</span>
                            {% if trans.shipping_cost > 0 %}
                                <span class="text-muted">({{ trans.shipping_cost|format_decimal }} kr)</span>
                            {% endif %}
                            <br>
                        {% elif trans.type == 'SÄLJ' %}
                             <span class="text-success">{{ trans.price|format_decimal }} kr</span>
                             {% if trans.shipping_cost > 0 %}
                                <span class="text-muted">({{ trans.shipping_cost|format_decimal }} kr)</span>
                            {% endif %}
                            <br>
                            {% if axe.net_value != 0 %}
                                <span class="{% if axe.net_value >= 0 %}profit-positive{% else %}profit-negative{% endif %} fw-bold">
                                    {{ axe.net_value|format_decimal }} kr
                                </span>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </td>
                <td class="text-center">
                    {% if axe.images.all %}
                        {% with images=axe.images.all %}
                            {% if images|length > 0 %}
                                <span tabindex="0" class="axe-image-popover" data-bs-toggle="popover" data-bs-html="true" data-bs-trigger="hover focus" data-bs-content='
                                    <div id="carousel-{{ axe.id }}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="800" style="width:140px;">
                                        <div class="carousel-inner">
                                            {% for img in images %}
                                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                <img src="{{ img.webp_url|default:img.image.url }}" class="d-block w-100 img-thumbnail" style="max-width:130px;max-height:130px;" loading="lazy">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>'>
                                    <i class="bi bi-camera-fill"></i>
                                </span>
                            {% endif %}
                        {% endwith %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block scripts %}
<script>
$(document).ready(function() {
    var table = $('#axesTable').DataTable({
        order: [[0, 'desc']],
        responsive: {
            details: {
                display: $.fn.dataTable.Responsive.display.modal({
                    header: function (row) {
                        var data = row.data();
                        return 'Detaljer för yxa ' + data[0];
                    }
                }),
                renderer: function (api, rowIdx, columns) {
                    var data = $.map(columns, function (col, i) {
                        return col.hidden ?
                            '<tr>' +
                                '<td class="fw-bold">' + col.title + ':</td> ' +
                                '<td>' + col.data + '</td>' +
                            '</tr>' : '';
                    }).join('');

                    // Lägg till Visa-knapp
                    var href = $(api.row(rowIdx).node()).data('href');
                    var viewButton = '';
                    if (href) {
                        viewButton = '<tr><td colspan="2" class="text-center pt-3">' +
                            '<a href="' + href + '" class="btn btn-primary btn-sm">' +
                            '<i class="bi bi-eye"></i> Visa yxa</a></td></tr>';
                    }

                    return data ?
                        $('<table class="table table-sm"/>')
                            .append('<tbody>' + data + viewButton + '</tbody>') : false;
                }
            },
            breakpoints: [
                { name: 'desktop', width: Infinity },
                { name: 'tablet', width: 1024 },
                { name: 'phone', width: 480 }
            ]
        },
        language: {
            "emptyTable": "Ingen data tillgänglig i tabellen",
            "info": "Visar _START_ till _END_ av _TOTAL_ poster",
            "infoEmpty": "Visar 0 till 0 av 0 poster",
            "infoFiltered": "(filtrerat från _MAX_ totala poster)",
            "lengthMenu": "Visa _MENU_ poster",
            "loadingRecords": "Laddar...",
            "processing": "Bearbetar...",
            "search": "Sök:",
            "zeroRecords": "Inga matchande poster hittades",
            "paginate": {
                "first": "Första",
                "last": "Sista",
                "next": "Nästa",
                "previous": "Föregående"
            },
            "aria": {
                "sortAscending": ": aktivera för att sortera kolumnen stigande",
                "sortDescending": ": aktivera för att sortera kolumnen fallande"
            },
             "buttons": {
                "copy": "Kopiera",
                "csv": "CSV",
                "excel": "Excel",
                "pdf": "PDF",
                "print": "Skriv ut",
                "colvis": "Visa kolumner"
            }
        },
        layout: {
            topStart: 'pageLength',
            topCenter: 'search',
            topEnd: {
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print', 'colvis'
                ]
            }
        },
        columnDefs: [
            {
                targets: [3], // Kommentar-kolumnen
                responsivePriority: 2
            },
            {
                targets: [0, 5], // ID och Bilder
                responsivePriority: 1,
                className: 'all' // Visa alltid
            },
            {
                targets: [1, 2, 4], // Tillverkare, Modell, Ekonomi
                responsivePriority: 2,
                className: 'all' // Visa alltid
            }
        ],
        drawCallback: function(settings) {
            // Initiera popovers på nya rader efter sidbyte/sortering/filtrering
            var popoverTriggerList = [].slice.call(document.querySelectorAll('.axe-image-popover'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl, {
                    boundary: 'window',
                    placement: 'auto'
                });
            });
        }
    });

    // Klickbara rader (endast på dator/tablett)
    $('#axesTable tbody').on('click', 'tr', function (event) {
        // Förhindra att klicket propagerar om man klickar på en länk eller knapp inuti raden
        if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || $(event.target).closest('a, button').length) {
            return;
        }
        
        // Endast aktivera klickbara rader på större skärmar
        if (window.innerWidth > 768) {
            var href = $(this).data('href');
            if (href) {
                window.location.href = href;
            }
        }
    });

    // Hantera klick på responsiva detaljer-knappar
    $('#axesTable tbody').on('click', 'td.dtr-control', function (event) {
        // Låt DataTables Responsive hantera detta klick
        return true;
    });

    // Starta carousel när popover visas
    $(document).on('shown.bs.popover', '.axe-image-popover', function () {
        var axeId = $(this).closest('tr').find('td:first').text().trim();
        var carouselId = '#carousel-' + axeId;
        var carouselEl = document.querySelector(carouselId);
        var carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl, { interval: 1200 });
        carousel.cycle();
    });
});
</script>
{% endblock %} 