{% extends 'axes/base.html' %}
{% load static %}
{% load axe_filters %}

{% block title %}Mottagningsarbetsflöde - {{ axe.manufacturer.name }} {{ axe.model }}{% endblock %}

{% block extra_head %}
<script src="{% static 'js/measurement_templates.js' %}"></script>
<style>
    .workflow-step {
        border-left: 4px solid #dee2e6;
        padding-left: 1rem;
        margin-bottom: 2rem;
    }
    .workflow-step.active {
        border-left-color: #0d6efd;
    }
    .workflow-step.completed {
        border-left-color: #198754;
    }
    .measurement-card {
        transition: transform 0.2s;
    }
    .measurement-card:hover {
        transform: translateY(-2px);
    }
    .template-btn {
        margin: 0.25rem;
    }
    .image-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        transition: border-color 0.3s;
    }
    .image-upload-area:hover {
        border-color: #0d6efd;
    }
    .image-upload-area.dragover {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
    }
    .measurement-form {
        background-color: var(--bs-secondary-bg);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .custom-field {
        display: none;
        margin-top: 10px;
    }
    .custom-field.show {
        display: block !important;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'axe_list' %}">Yxsamling</a></li>
        <li class="breadcrumb-item"><a href="{% url 'axe_detail' axe.pk %}">{{ axe.manufacturer.name }} - {{ axe.model }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Mottagning</li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-box-open me-2"></i>
                    Mottagning: {{ axe.manufacturer.name }} - {{ axe.model }}
                </h1>
                <div>
                    <a href="{% url 'axe_detail' axe.pk %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i>
                        <span class="d-none d-md-inline">Tillbaka till yxa</span>
                    </a>
                    <a href="{% url 'axe_edit' axe.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>
                        <span class="d-none d-md-inline">Redigera yxa</span>
                    </a>
                </div>
            </div>

            <!-- Notifikationer -->
            <div id="notification" class="alert" style="display: none;">
                <span id="notification-message"></span>
            </div>

            <!-- Status-indikator -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Status:</strong> 
                {% if axe.status == 'KÖPT' %}
                    <span class="badge bg-warning text-dark">Köpt - Väntar på mottagning</span>
                {% else %}
                    <span class="badge bg-success">Mottagen/Ägd</span>
                {% endif %}
            </div>

            <!-- Arbetsflödessteg -->
            <div class="row">
                <div class="col-lg-8">
                    <!-- Steg 1: Måttinmatning -->
                    <div class="workflow-step active" id="step-measurements">
                        <h3 class="h5 mb-3">
                            <i class="fas fa-ruler me-2"></i>
                            Steg 1: Mät och registrera mått
                        </h3>
                        
                        <!-- Måttmallar -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Måttmallar</h6>
                            </div>
                            <div class="card-body">
                                {% if measurement_templates %}
                                    <p class="text-muted small mb-2">Välj en mall för att snabbt lägga till vanliga mått:</p>
                                    <div class="d-flex flex-wrap">
                                        {% for template_name, measurements in measurement_templates.items %}
                                        <button type="button" class="btn btn-outline-primary btn-sm template-btn" 
                                                data-template="{{ template_name }}"
                                                title="{{ template_name }}: {{ measurements|length }} mått">
                                            <i class="fas fa-list me-1"></i>{{ template_name }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted small mb-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Inga måttmallar konfigurerade än. 
                                        <a href="/admin/axes/measurementtemplate/" target="_blank">Skapa mallar i admin</a>
                                    </p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Måttformulär -->
                        <div class="measurement-form">
                            <h6 class="mb-3">Lägg till nytt mått</h6>
                            <form id="measurementForm" method="post" action="{% url 'add_measurement' axe.pk %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-md-4">
                                        {{ measurement_form.name.label_tag }}
                                        {{ measurement_form.name }}
                                        <div class="custom-field" id="custom-name-field">
                                            {{ measurement_form.custom_name.label_tag }}
                                            {{ measurement_form.custom_name }}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        {{ measurement_form.value.label_tag }}
                                        {{ measurement_form.value }}
                                    </div>
                                    <div class="col-md-3">
                                        {{ measurement_form.unit.label_tag }}
                                        {{ measurement_form.unit }}
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-plus me-1"></i>
                                            <span class="d-none d-md-inline">Lägg till</span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Batch-måttformulär (dolt från början) -->
                        <div class="measurement-form mt-3" id="batchMeasurementFormContainer" style="display:none;">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Batch-läggning av mått:</strong> Fyll i värdena nedan och klicka "Lägg till mått" för att lägga till alla mått samtidigt. Måtten sparas direkt och visas i tabellen nedan.
                            </div>
                            <h6 class="mb-3">Lägg till flera mått från mall</h6>
                            <form id="batchMeasurementForm" method="post" action="{% url 'add_measurements_from_template' axe.pk %}">
                                {% csrf_token %}
                                <div id="batchMeasurementRows"></div>
                                <div class="text-end mt-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus me-1"></i>Lägg till mått
                                    </button>
                                    <button type="button" class="btn btn-link text-danger" data-action="hideBatchForm">Avbryt</button>
                                </div>
                            </form>
                        </div>

                        <!-- Befintliga mått -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Registrerade mått (<span class="measurement-count">{{ measurements.count }}</span>)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row measurement-list" id="measurementsList" {% if not measurements %}style="display:none;"{% endif %}>
                                    {% for measurement in measurements %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card measurement-card h-100" data-measurement-id="{{ measurement.id }}">
                                            <div class="card-body">
                                                <h6 class="card-title">{{ measurement.name }}</h6>
                                                <p class="card-text">
                                                    <span class="h5 text-primary">{{ measurement.value|format_decimal }}</span>
                                                    <small class="text-muted">{{ measurement.unit }}</small>
                                                </p>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteMeasurement({{ measurement.id }})">
                                                    <i class="fas fa-trash me-1"></i>Ta bort
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="measurement-empty-state text-center py-3" {% if measurements %}style="display:none;"{% endif %}>
                                    <i class="fas fa-ruler fa-2x mb-2"></i><br>
                                    <p class="text-muted">Inga mått registrerade än. Lägg till ditt första mått ovan.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Steg 2: Mottagningsbilder -->
                    <div class="workflow-step" id="step-images">
                        <h3 class="h5 mb-3">
                            <i class="fas fa-camera me-2"></i>
                            Steg 2: Lägg till mottagningsbilder
                        </h3>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Bilder ({{ images.count }})</h6>
                            </div>
                            <div class="card-body">
                                {% if images %}
                                    <div class="row">
                                        {% for image in images %}
                                        <div class="col-md-4 col-lg-3 mb-3">
                                            <div class="card">
                                                <img src="{{ image.webp_url|default:image.image.url }}" 
                                                     class="card-img-top" 
                                                     alt="{{ image.description|default:'Yxbild' }}"
                                                     style="height: 150px; object-fit: cover;">
                                                <div class="card-body">
                                                    <p class="card-text small">{{ image.description|default:'Ingen beskrivning' }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center py-3">
                                        <i class="fas fa-camera fa-2x mb-2"></i><br>
                                        Inga bilder uppladdade än.
                                    </p>
                                {% endif %}
                                
                                <div class="text-center mt-3">
                                    <a href="{% url 'axe_edit' axe.pk %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>
                                        Lägg till bilder
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Steg 3: Slutför mottagning -->
                    <div class="workflow-step" id="step-complete">
                        <h3 class="h5 mb-3">
                            <i class="fas fa-check-circle me-2"></i>
                            Steg 3: Slutför mottagning
                        </h3>
                        
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-box-open fa-3x text-success mb-3"></i>
                                <h5>Redo att markera som mottagen?</h5>
                                <p class="text-muted">
                                    När du är nöjd med måtten och bilderna kan du markera yxan som mottagen.
                                </p>
                                <button class="btn btn-success btn-lg" onclick="markAsReceived()">
                                    <i class="fas fa-check me-2"></i>
                                    Markera som mottagen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidopanel med yxinfo -->
                <div class="col-lg-4">
                    <div class="card sticky-top" style="top: 1rem;">
                        <div class="card-header">
                            <h6 class="mb-0">Yxinformation</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Tillverkare:</strong><br>{{ axe.manufacturer.name }}</p>
                            <p><strong>Modell:</strong><br>{{ axe.model }}</p>
                            {% if axe.comment %}
                                <p><strong>Kommentar:</strong><br>{{ axe.comment }}</p>
                            {% endif %}
                            
                            <hr>
                            
                            <div class="d-grid gap-2">
                                <a href="{% url 'axe_detail' axe.pk %}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Visa yxa
                                </a>
                                <a href="{% url 'axe_edit' axe.pk %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-edit me-1"></i>Redigera yxa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Måttmallar data -->
<script>
window.axeId = {{ axe.pk }};
window.measurementTemplates = {{ measurement_templates|safe }};
</script>
{% endblock %} 