{% extends 'axes/base.html' %}
{% load axe_filters %}

{% block title %}{{ axe.manufacturer.name }} - {{ axe.model }} - {{ block.super }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/photoswipe@5.4.4/dist/photoswipe.css" />
<style>
    .measurement-card {
        transition: transform 0.2s;
    }
    .measurement-card:hover {
        transform: translateY(-2px);
    }
    .image-gallery img {
        transition: transform 0.3s;
        cursor: pointer;
    }
    .image-gallery img:hover {
        transform: scale(1.05);
    }
    .contact-link {
        text-decoration: none;
        color: inherit;
    }
    .contact-link:hover {
        color: #0d6efd;
        text-decoration: underline;
    }
    .edit-col {
        white-space: nowrap;
    }
    .edit-transaction-btn,
    .delete-transaction-btn {
        display: inline-block;
        margin-right: 0.25rem;
        margin-bottom: 0;
        vertical-align: middle;
    }
    .stamp-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .stamp-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stamp-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 0.375rem;
    }
    .stamp-image-container img {
        transition: transform 0.3s;
    }
    .stamp-image-container:hover img {
        transform: scale(1.05);
    }
    @media (max-width: 480px) {
        .edit-col {
            text-align: center;
        }
        .edit-transaction-btn,
        .delete-transaction-btn {
            font-size: 1rem;
            padding: 0.3rem 0.5rem;
        }
    }
    @media (max-width: 767px) {
        .btn.btn-sm {
            font-size: 0.95rem;
            padding: 0.3rem 0.6rem;
        }
    }
</style>
{% endblock %}

{% block content %}
{% include 'axes/_breadcrumbs.html' with breadcrumbs=breadcrumbs %}

<!-- Titel och navigering -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">{{ axe.display_id }} - {{ axe.manufacturer.name }} - {{ axe.model }}</h1>
            <div>
                {% if axe.status == 'KÖPT' %}
                    <a href="{% url 'receiving_workflow' axe.pk %}" class="btn btn-primary me-2">
                        <i class="fas fa-box-open me-1"></i>
                        <span class="d-none d-md-inline">Mottagning</span>
                    </a>
                {% endif %}
                <a href="{% url 'axe_gallery_detail' axe.pk %}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-images me-1"></i>
                    <span class="d-none d-md-inline">Galleri</span>
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'axe_edit' axe.pk %}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-edit me-1"></i>
                    <span class="d-none d-md-inline">Redigera</span>
                </a>
                {% if axe.is_latest %}
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAxeModal" title="Ta bort yxa">
                        <i class="fas fa-trash me-1"></i>
                        <span class="d-none d-md-inline">Ta bort</span>
                    </button>
                {% else %}
                    <button type="button" class="btn btn-danger" disabled title="Endast den senaste yxan kan tas bort">
                        <i class="fas fa-trash me-1"></i>
                        <span class="d-none d-md-inline">Ta bort</span>
                    </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Vänstra kolumnen -->
    <div class="col-md-8">
        <!-- Yxinformation -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Yxinformation</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Tillverkare:</strong> 
                            <a href="{% url 'manufacturer_detail' axe.manufacturer.id %}" class="text-decoration-none">
                                {% if axe.manufacturer.country_code %}
                                    <span class="me-1">{{ axe.manufacturer.country_code|country_flag }}</span>
                                {% endif %}
                                {{ axe.manufacturer.name }}
                            </a>
                        </p>
                        <p><strong>Modell:</strong> {{ axe.model }}</p>
                        {% if axe.comment %}
                            <p><strong>Kommentar:</strong> {{ axe.comment }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if axe.measurements.all %}
                            <h6><strong>Mått:</strong></h6>
                            <ul class="list-unstyled">
                                {% for measurement in axe.measurements.all %}
                                    <li>{{ measurement.name }}: {{ measurement.value|format_decimal }} {{ measurement.unit }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
                
            </div> <!-- card-body -->
        </div> <!-- card -->

{% if not transactions %}
{% if user.is_authenticated %}
<div class="mt-4">
    <button class="btn btn-primary" id="addTransactionBtn" type="button">
        <i class="fas fa-plus-circle me-1"></i> Lägg till transaktion
    </button>
</div>
{% endif %}
{% endif %}

        <!-- Transaktionshistorik -->
        {% if transactions %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Transaktionshistorik</h4>
                    {% if user.is_authenticated %}
                    <div>
                        <button class="btn btn-primary btn-sm me-2" id="addTransactionBtn" type="button">
                            <i class="fas fa-plus-circle me-1"></i>
                            <span class="d-none d-md-inline">Lägg till transaktion</span>
                        </button>
                        <button id="toggleEditTransactions" class="btn btn-outline-secondary btn-sm" type="button">
                            <span id="toggleEditIcon"><i class="bi bi-pencil-square me-1"></i></span>
                            <span id="toggleEditText" class="d-none d-md-inline">Redigera</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm" id="transactionTable">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Typ</th>
                                    {% if user.is_authenticated or public_settings.show_prices %}
                                    <th>Pris</th>
                                    <th>Frakt</th>
                                    {% endif %}
                                    {% if user.is_authenticated or public_settings.show_contacts %}
                                    <th>Kontakt</th>
                                    {% endif %}
                                    {% if user.is_authenticated or public_settings.show_platforms %}
                                    <th>Plattform</th>
                                    {% endif %}
                                    <th>Kommentar</th>
                                    <th class="edit-col" style="display:none;">Åtgärder</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                    {% include 'axes/_transaction_row.html' with transaction=transaction show_actions=True %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Stämplar -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Stämplar</h4>
                {% if user.is_authenticated %}
                <a href="{% url 'add_axe_stamp' axe.id %}" class="btn btn-primary btn-sm" title="Ange stämpel">
                    <i class="fas fa-plus"></i>
                    <span class="d-none d-md-inline">Ange stämpel</span>
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if axe_stamps %}
                    <div class="row">
                        {% for axe_stamp in axe_stamps %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 stamp-card">
                                    <div class="card-body p-3">
                                        <!-- Stämpelbild -->
                                        <div class="text-center mb-3 stamp-image-container">
                                            {% if axe_stamp.stamp.images.exists %}
                                                <img src="{{ axe_stamp.stamp.images.first.image_url_with_cache_busting }}" 
                                                     class="img-fluid rounded" 
                                                     style="max-height: 150px; object-fit: contain;"
                                                     alt="{{ axe_stamp.stamp.name }}">
                                            {% elif axe_stamp.stamp.axe_image_marks.exists %}
                                                {% with image_mark=axe_stamp.stamp.axe_image_marks.first %}
                                                    <div class="position-relative d-inline-block">
                                                        <img src="{{ image_mark.axe_image.image_url_with_cache_busting }}" 
                                                             class="img-fluid rounded" 
                                                             style="max-height: 150px; object-fit: contain;"
                                                             alt="{{ axe_stamp.stamp.name }}">
                                                        {% if image_mark.has_coordinates %}
                                                            <div class="position-absolute border border-warning bg-warning bg-opacity-25" 
                                                                 style="left: {{ image_mark.x_coordinate }}px; top: {{ image_mark.y_coordinate }}px; width: {{ image_mark.width }}px; height: {{ image_mark.height }}px;">
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endwith %}
                                            {% else %}
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                     style="height: 150px;">
                                                    <i class="fas fa-stamp fa-3x text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Stämpelinformation -->
                                        <h6 class="card-title mb-2">
                                            <a href="{% url 'stamp_detail' axe_stamp.stamp.id %}" class="text-decoration-none">
                                                {{ axe_stamp.stamp.name }}
                                            </a>
                                            {% if axe_stamp.stamp.status == 'unknown' %}
                                                <span class="badge bg-warning ms-1">Okänd</span>
                                            {% endif %}
                                        </h6>
                                        
                                        <div class="mb-2">
                                            {% if axe_stamp.stamp.manufacturer %}
                                                <small class="text-muted">
                                                    <a href="{% url 'manufacturer_detail' axe_stamp.stamp.manufacturer.id %}" class="text-decoration-none">
                                                        {{ axe_stamp.stamp.manufacturer.name }}
                                                    </a>
                                                </small>
                                            {% else %}
                                                <small class="text-muted">Okänd tillverkare</small>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mb-2">
                                            <span class="badge bg-info">{{ axe_stamp.stamp.get_stamp_type_display }}</span>
                                            {% if axe_stamp.uncertainty_level == 'uncertain' %}
                                                <span class="badge bg-warning">Osäker</span>
                                            {% elif axe_stamp.uncertainty_level == 'tentative' %}
                                                <span class="badge bg-secondary">Preliminär</span>
                                            {% else %}
                                                <span class="badge bg-success">Säker</span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if axe_stamp.position %}
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    {{ axe_stamp.position }}
                                                </small>
                                            </div>
                                        {% endif %}
                                        
                                        {% if axe_stamp.comment %}
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    {{ axe_stamp.comment|truncatewords:8 }}
                                                </small>
                                            </div>
                                        {% endif %}
                                        
                                        {% if user.is_authenticated %}
                                            <div class="mt-auto">
                                                <div class="btn-group btn-group-sm w-100" role="group">
                                                    <a href="{% url 'edit_axe_stamp' axe.id axe_stamp.id %}" class="btn btn-outline-primary" title="Redigera stämpel">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <a href="{% url 'stamp_detail' axe_stamp.stamp.id %}" class="btn btn-outline-info" title="Visa stämpel">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-danger" title="Ta bort stämpel"
                                                            onclick="showRemoveStampModal('{% url 'remove_axe_stamp' axe.id axe_stamp.stamp.id %}')">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-stamp fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Inga stämplar definierade</h5>
                        <p class="text-muted">Denna yxa har inga stämplar kopplade än.</p>
                        {% if user.is_authenticated %}
                            <a href="{% url 'add_axe_stamp' axe.id %}" class="btn btn-primary" title="Ange stämpel">
                                <i class="fas fa-plus"></i>
                                Ange stämpel
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Högra kolumnen -->
    <div class="col-md-4">
        <!-- Bildgalleri -->
        {% if axe.images.all %}
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Bilder</h4>
                </div>
                <div class="card-body">
                    <div class="axe-detail-images">
                        <div id="axeCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for image in axe.images.all %}
                                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                        <div class="position-relative">
                                            <a href="{{ image.image_url_with_cache_busting }}" data-pswp-width="{{ image.image.width }}" data-pswp-height="{{ image.image.height }}">
                                                <picture>
                                                    {% if image.webp_url %}
                                                        <source srcset="{{ image.webp_url }}" type="image/webp">
                                                    {% endif %}
                                                    <img src="{{ image.image_url_with_cache_busting }}" class="d-block w-100" alt="Yxa {{ forloop.counter }}" loading="lazy">
                                                </picture>
                                            </a>
                                            
                                            <!-- Stämpelmarkeringar -->
                                            {% for stamp_mark in image.stamp_marks.all %}
                                                <div class="position-absolute border border-warning bg-warning bg-opacity-25" 
                                                     style="left: {{ stamp_mark.x_coordinate }}px; top: {{ stamp_mark.y_coordinate }}px; width: {{ stamp_mark.width }}px; height: {{ stamp_mark.height }}px;"
                                                     title="{{ stamp_mark.stamp.name }}">
                                                    {% if stamp_mark.is_primary %}
                                                        <span class="position-absolute top-0 start-0 badge bg-success">★</span>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                            

                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if axe.images.count > 1 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#axeCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Föregående</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#axeCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Nästa</span>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal för att lägga till/redigera transaktion (alltid i DOM) -->
<div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTransactionModalLabel">Lägg till transaktion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
      </div>
      <div class="modal-body">
        <!-- Här kommer formuläret för att lägga till/redigera transaktion att visas -->
        {% if transaction_form %}
            <form method="post" id="addTransactionForm">
                {% csrf_token %}
                                
                                <!-- Datum -->
                                <div class="mb-3">
                                    <label for="{{ transaction_form.transaction_date.id_for_label }}" class="form-label">
                                        {{ transaction_form.transaction_date.label }}
                                    </label>
                                    {{ transaction_form.transaction_date }}
                                    <div class="form-text">{{ transaction_form.transaction_date.help_text }}</div>
                                    {% if transaction_form.transaction_date.errors %}
                                        <div class="text-danger">{{ transaction_form.transaction_date.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Kontakthantering -->
                                <div class="mb-3">
                                    <label for="contactSearchInput" class="form-label">Kontakt</label>
                                    <div class="position-relative">
                                        <input type="text" id="contactSearchInput" name="contact_search" class="form-control" placeholder="Sök efter befintlig kontakt eller ange ny...">
                                        <input type="hidden" id="selectedContactId" name="selected_contact_id" value="">
                                        <div id="contactSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            <!-- Sökresultat visas här -->
                                        </div>
                                    </div>
                                    <div class="form-text">Börja skriva för att söka efter befintlig kontakt</div>
                                </div>
                                
                                <!-- Ny kontakt (visas endast om sökning misslyckas) -->
                                <div id="newContactSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted">Skapa ny kontakt</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="contactName" class="form-label">Namn</label>
                                                <input type="text" id="contactName" name="contact_name" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="contactAlias" class="form-label">Alias</label>
                                                <input type="text" id="contactAlias" name="contact_alias" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="contactEmail" class="form-label">E-post</label>
                                                <input type="email" id="contactEmail" name="contact_email" class="form-control">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="contactPhone" class="form-label">Telefon</label>
                                                <input type="text" id="contactPhone" name="contact_phone" class="form-control">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="contactComment" class="form-label">Kommentar</label>
                                        <textarea id="contactComment" name="contact_comment" class="form-control" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input type="checkbox" id="isNajMember" name="is_naj_member" class="form-check-input">
                                        <label class="form-check-label" for="isNajMember">NAJ-medlem</label>
                                    </div>
                                </div>
                                
                                <!-- Plattformshantering -->
                                <div class="mb-3">
                                    <label for="platformSearchInput" class="form-label">Plattform</label>
                                    <div class="position-relative">
                                        <input type="text" id="platformSearchInput" name="platform_search" class="form-control" placeholder="Sök efter befintlig plattform eller ange ny...">
                                        <input type="hidden" id="selectedPlatformId" name="selected_platform_id" value="">
                                        <div id="platformSearchResults" class="dropdown-menu w-100" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                            <!-- Sökresultat visas här -->
                                        </div>
                                    </div>
                                    <div class="form-text">Börja skriva för att söka efter befintlig plattform eller skapa ny</div>
                                </div>
                                
                                <!-- Kostnader -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ transaction_form.price.id_for_label }}" class="form-label">
                                                {{ transaction_form.price.label }}
                                            </label>
                                            {{ transaction_form.price }}
                                            <div class="form-text">{{ transaction_form.price.help_text }}</div>
                                            {% if transaction_form.price.errors %}
                                                <div class="text-danger">{{ transaction_form.price.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ transaction_form.shipping_cost.id_for_label }}" class="form-label">
                                                {{ transaction_form.shipping_cost.label }}
                                            </label>
                                            {{ transaction_form.shipping_cost }}
                                            <div class="form-text">{{ transaction_form.shipping_cost.help_text }}</div>
                                            {% if transaction_form.shipping_cost.errors %}
                                                <div class="text-danger">{{ transaction_form.shipping_cost.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Kommentar -->
                                <div class="mb-3">
                                    <label for="{{ transaction_form.comment.id_for_label }}" class="form-label">
                                        {{ transaction_form.comment.label }}
                                    </label>
                                    {{ transaction_form.comment }}
                                    <div class="form-text">{{ transaction_form.comment.help_text }}</div>
                                    {% if transaction_form.comment.errors %}
                                        <div class="text-danger">{{ transaction_form.comment.errors }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
                                    <button type="submit" class="btn btn-primary">Spara</button>
                                </div>
                            </form>
        {% else %}
            <div class="alert alert-info">Formulär för att lägga till transaktion kommer här.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.js';
import PhotoSwipe from 'https://unpkg.com/photoswipe@5.4.4/dist/photoswipe.esm.js';

const lightbox = new PhotoSwipeLightbox({
  gallery: '.axe-detail-images',
  children: 'a[data-pswp-width]',
  pswpModule: PhotoSwipe
});
lightbox.init();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Gemensamma variabler för modalhantering ---
    const addTransactionBtn = document.getElementById('addTransactionBtn');
    const addTransactionModal = document.getElementById('addTransactionModal');
    const addTransactionModalLabel = document.getElementById('addTransactionModalLabel');
    const addTransactionForm = document.getElementById('addTransactionForm');
    const submitBtn = addTransactionForm ? addTransactionForm.querySelector('button[type="submit"]') : null;
    let editingTransactionId = null;

    // Lägg till transaktion-knapp öppnar alltid tom modal
    if (addTransactionBtn && addTransactionModal) {
        addTransactionBtn.addEventListener('click', function() {
            if (addTransactionForm) addTransactionForm.reset();
            document.getElementById('selectedContactId').value = '';
            document.getElementById('contactSearchInput').value = '';
            document.getElementById('platformSearchInput').value = '';
            document.getElementById('selectedPlatformId').value = '';
            document.getElementById('newContactSection').style.display = 'none';
            addTransactionModalLabel.textContent = 'Lägg till transaktion';
            if (submitBtn) submitBtn.textContent = 'Spara';
            editingTransactionId = null;
            const modal = new bootstrap.Modal(addTransactionModal);
            modal.show();
        });
    }

    // --- Redigera transaktion ---
    const editTransactionBtns = document.querySelectorAll('.edit-transaction-btn');
    editTransactionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const transactionId = this.getAttribute('data-transaction-id');
            fetch(`/api/transaction/${transactionId}/`)
                .then(response => response.json())
                .then(data => {
                    let price = data.price || '';
                    let shipping = data.shipping_cost || '';
                    if (data.type === 'KÖP') {
                        price = price ? -Math.abs(price) : '';
                        shipping = shipping ? -Math.abs(shipping) : '';
                    }
                    document.getElementById('id_price').value = price;
                    document.getElementById('id_shipping_cost').value = shipping;
                    document.getElementById('id_transaction_date').value = data.transaction_date || '';
                    document.getElementById('id_comment').value = data.comment || '';
                    document.getElementById('selectedContactId').value = data.contact_id || '';
                    document.getElementById('contactSearchInput').value = data.contact_name || '';
                    document.getElementById('platformSearchInput').value = data.platform_name || '';
                    document.getElementById('selectedPlatformId').value = data.platform_id || '';
                    document.getElementById('newContactSection').style.display = 'none';
                    addTransactionModalLabel.textContent = 'Redigera transaktion';
                    if (submitBtn) submitBtn.textContent = 'Spara ändringar';
                    editingTransactionId = data.id;
                    const modal = new bootstrap.Modal(addTransactionModal);
                    modal.show();
                });
        });
    });
    // Återställ modal vid stängning
    if (addTransactionModal) {
        addTransactionModal.addEventListener('hidden.bs.modal', function() {
            addTransactionModalLabel.textContent = 'Lägg till transaktion';
            if (submitBtn) submitBtn.textContent = 'Spara';
            editingTransactionId = null;
            if (addTransactionForm) addTransactionForm.reset();
        });
    }

    // --- AJAX-sökning för kontakt ---
    const contactSearchInput = document.getElementById('contactSearchInput');
    const newContactSection = document.getElementById('newContactSection');
    const contactSearchResults = document.getElementById('contactSearchResults');
    const selectedContactId = document.getElementById('selectedContactId');
    let contactSearchTimeout;
    if (contactSearchInput) {
        contactSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            clearTimeout(contactSearchTimeout);
            // Rensa vald kontakt när användaren skriver
            selectedContactId.value = '';
            if (searchValue.length >= 2) {
                contactSearchTimeout = setTimeout(() => {
                    fetch('/api/search/contacts/?q=' + encodeURIComponent(searchValue))
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                showContactResults(data.results);
                                newContactSection.style.display = 'none';
                            } else {
                                newContactSection.style.display = 'block';
                                contactSearchResults.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            newContactSection.style.display = 'block';
                            contactSearchResults.style.display = 'none';
                        });
                }, 300);
            } else {
                contactSearchResults.style.display = 'none';
                newContactSection.style.display = 'none';
            }
        });
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!contactSearchInput.contains(e.target) && !contactSearchResults.contains(e.target)) {
                contactSearchResults.style.display = 'none';
            }
        });
    }
    function showContactResults(results) {
        contactSearchResults.innerHTML = '';
        results.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `
                <div>
                    <strong>${contact.name}</strong>
                    ${contact.alias ? `<br><small class='text-muted'>${contact.alias}</small>` : ''}
                    ${contact.email ? `<br><small class='text-muted'>${contact.email}</small>` : ''}
                    ${contact.phone ? `<br><small class='text-muted'>${contact.phone}</small>` : ''}
                </div>
            `;
            item.addEventListener('click', () => {
                contactSearchInput.value = contact.name;
                selectedContactId.value = contact.id;
                hideContactResults();
                newContactSection.style.display = 'none';
            });
            contactSearchResults.appendChild(item);
        });
        contactSearchResults.style.display = 'block';
    }
    function hideContactResults() {
        contactSearchResults.style.display = 'none';
    }
    // --- AJAX-sökning för plattform ---
    const platformSearchInput = document.getElementById('platformSearchInput');
    const platformSearchResults = document.getElementById('platformSearchResults');
    const selectedPlatformId = document.getElementById('selectedPlatformId');
    let platformSearchTimeout;
    if (platformSearchInput) {
        platformSearchInput.addEventListener('input', function() {
            const searchValue = this.value.trim();
            clearTimeout(platformSearchTimeout);
            // Rensa vald plattform när användaren skriver
            selectedPlatformId.value = '';
            if (searchValue.length >= 2) {
                platformSearchTimeout = setTimeout(() => {
                    fetch('/api/search/platforms/?q=' + encodeURIComponent(searchValue))
                        .then(response => response.json())
                        .then(data => {
                            if (data.results && data.results.length > 0) {
                                showPlatformResults(data.results);
                            } else {
                                // Om ingen match, visa "Skapa ny"
                                platformSearchResults.innerHTML = `
                                    <div class="dropdown-item">
                                        <a href="#" class="text-decoration-none text-dark" onclick="createNewPlatform('${encodeURIComponent(searchValue)}')">
                                            <i class="fas fa-plus-circle me-1"></i> Skapa ny plattform: "${searchValue}"
                                        </a>
                                    </div>
                                `;
                                platformSearchResults.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            platformSearchResults.innerHTML = `
                                <div class="dropdown-item text-danger">
                                    Fel vid sökning: ${error.message}
                                </div>
                            `;
                            platformSearchResults.style.display = 'block';
                        });
                }, 300);
            } else {
                platformSearchResults.style.display = 'none';
            }
        });
        
        // Dölj dropdown när användaren klickar utanför
        document.addEventListener('click', function(e) {
            if (!platformSearchInput.contains(e.target) && !platformSearchResults.contains(e.target)) {
                platformSearchResults.style.display = 'none';
            }
        });
    }
    function showPlatformResults(results) {
        platformSearchResults.innerHTML = '';
        results.forEach(platform => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.innerHTML = `<div><strong>${platform.name}</strong></div>`;
            item.addEventListener('click', () => {
                platformSearchInput.value = platform.name;
                selectedPlatformId.value = platform.id;
                hidePlatformResults();
            });
            platformSearchResults.appendChild(item);
        });
        platformSearchResults.style.display = 'block';
    }
    function hidePlatformResults() {
        platformSearchResults.style.display = 'none';
    }

    const toggleEditBtn = document.getElementById('toggleEditTransactions');
    const editCols = document.querySelectorAll('.edit-col');
    let editMode = false;
    if (toggleEditBtn) {
        toggleEditBtn.addEventListener('click', function() {
            editMode = !editMode;
            editCols.forEach(col => {
                col.style.display = editMode ? '' : 'none';
            });
            toggleEditBtn.classList.toggle('btn-primary', editMode);
            toggleEditBtn.classList.toggle('btn-outline-secondary', !editMode);
            // Byta text på knappen
            const iconSpan = toggleEditBtn.querySelector('#toggleEditIcon');
            const textSpan = toggleEditBtn.querySelector('#toggleEditText');
            if (editMode) {
                iconSpan.innerHTML = '<i class="bi bi-x-lg me-1"></i>';
                textSpan.textContent = 'Avsluta redigering';
            } else {
                iconSpan.innerHTML = '<i class="bi bi-pencil-square me-1"></i>';
                textSpan.textContent = 'Redigera';
            }
        });
    }

    // --- Hantera submit för lägg till/redigera transaktion ---
    if (addTransactionForm) {
        addTransactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (editingTransactionId) {
                // Redigera: AJAX-anrop
                const formData = new FormData(addTransactionForm);
                fetch(`/api/transaction/${editingTransactionId}/update/`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Stäng modal och ladda om sidan (eller uppdatera tabell via JS)
                        const modal = bootstrap.Modal.getInstance(addTransactionModal);
                        if (modal) modal.hide();
                        location.reload();
                    } else {
                        // Visa felmeddelanden
                        let errorMsg = 'Fel vid uppdatering:';
                        if (data.errors) {
                            errorMsg += '\n' + Object.values(data.errors).join('\n');
                        } else if (data.error) {
                            errorMsg += '\n' + data.error;
                        }
                        alert(errorMsg);
                    }
                })
                .catch(() => {
                    alert('Något gick fel vid uppdatering.');
                });
            } else {
                // Skicka som vanligt (lägg till ny transaktion)
                addTransactionForm.submit();
            }
        });
    }

    // --- Ta bort transaktion ---
    let currentTransactionId = null;
    const deleteTransactionModal = new bootstrap.Modal(document.getElementById('deleteTransactionModal'));
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const confirmDeleteTransactionBtn = document.getElementById('confirmDeleteTransactionBtn');
    const errorModalMessage = document.getElementById('errorModalMessage');
    
    // Funktion för att visa felmeddelande
    function showError(message) {
        errorModalMessage.textContent = message;
        errorModal.show();
    }
    
    const deleteTransactionBtns = document.querySelectorAll('.delete-transaction-btn');
    deleteTransactionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            currentTransactionId = this.getAttribute('data-transaction-id');
            deleteTransactionModal.show();
        });
    });
    
    // Hantera bekräftelse av borttagning
    confirmDeleteTransactionBtn.addEventListener('click', function() {
        if (currentTransactionId) {
            fetch(`/api/transaction/${currentTransactionId}/delete/`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                deleteTransactionModal.hide();
                if (data.success) {
                    location.reload();
                } else {
                    showError('Kunde inte ta bort transaktionen: ' + (data.error || 'Okänt fel.'));
                }
            })
            .catch(() => {
                deleteTransactionModal.hide();
                showError('Något gick fel vid borttagning.');
            });
        }
    });
});
</script>

<!-- Modal för att ta bort transaktion -->
<div class="modal fade" id="deleteTransactionModal" tabindex="-1" aria-labelledby="deleteTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTransactionModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Ta bort transaktion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <p>Är du säker på att du vill ta bort denna transaktion?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Varning:</strong> Denna åtgärd kan inte ångras.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Avbryt
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTransactionBtn">
                    <i class="fas fa-trash me-2"></i>Ta bort transaktion
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal för felmeddelanden -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">
                    <i class="fas fa-exclamation-circle text-danger me-2"></i>
                    Fel
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <p id="errorModalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Stäng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal för att ta bort yxa -->
{% if axe.is_latest %}
<div class="modal fade" id="deleteAxeModal" tabindex="-1" aria-labelledby="deleteAxeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAxeModalLabel">Ta bort yxa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
            </div>
            <div class="modal-body">
                <p>Är du säker på att du vill ta bort yxan <strong>{{ axe.manufacturer.name }} - {{ axe.model }}</strong> (ID: {{ axe.id }})?</p>
                <div class="alert alert-info">
                    <strong>{{ axe.manufacturer.name }} - {{ axe.model }}</strong><br>
                    <small class="text-muted">
                        ID: {{ axe.id }} | 
                        Bilder: {{ axe.images.count }} | 
                        Transaktioner: {{ axe.transactions.count }} |
                        {% if axe.transactions.first.contact %}
                            Kontakt: {{ axe.transactions.first.contact.name }}
                        {% else %}
                            Kontakt: Ingen
                        {% endif %}
                    </small>
                </div>
                <form id="deleteAxeForm" method="post" action="{% url 'delete_latest_axe' %}">
                    {% csrf_token %}
                    <input type="hidden" name="axe_id" value="{{ axe.id }}">
                    {% if axe.images.count > 0 %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="deleteImages" name="delete_images">
                            <label class="form-check-label" for="deleteImages">
                                Ta bort kopplade bilder ({{ axe.images.count }})
                            </label>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> Om inte markerat flyttas bilderna till en mapp för "okopplade bilder" med timestamp och a-b-c-namngivning (t.ex. 20250717_225600-a.jpg)
                            </div>
                        </div>
                    {% else %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="deleteImages" name="delete_images" disabled>
                            <label class="form-check-label text-muted" for="deleteImages">
                                Ta bort kopplade bilder (inga bilder)
                            </label>
                        </div>
                    {% endif %}
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="deleteTransactions" name="delete_transactions" checked>
                        <label class="form-check-label" for="deleteTransactions">
                            Ta bort kopplade transaktioner ({{ axe.transactions.count }})
                        </label>
                    </div>
                    {% if axe.transactions.first.contact %}
                        {% with contact=axe.transactions.first.contact %}
                            {% if contact.unique_axes_count == 1 %}
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="deleteContact" name="delete_contact">
                                    <label class="form-check-label" for="deleteContact">
                                        Ta bort kontakt "{{ contact.name }}" (är kopplad endast till denna yxa)
                                    </label>
                                </div>
                            {% else %}
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="deleteContact" name="delete_contact" disabled>
                                    <label class="form-check-label text-muted" for="deleteContact">
                                        Ta bort kontakt "{{ contact.name }}" (är kopplad till {{ contact.unique_axes_count }} yxor)
                                    </label>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Kontakter kan endast tas bort om de inte är kopplade till andra yxor
                                    </div>
                                </div>
                            {% endif %}
                        {% endwith %}
                    {% else %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="deleteContact" name="delete_contact" disabled>
                            <label class="form-check-label text-muted" for="deleteContact">
                                Ta bort kontakt (ingen kontakt kopplad)
                            </label>
                        </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="submit" form="deleteAxeForm" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Ta bort yxa
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal för att ta bort stämpel från yxa -->
<div class="modal fade" id="removeStampModal" tabindex="-1" aria-labelledby="removeStampModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="removeStampModalContent">
            <!-- Innehåll laddas dynamiskt -->
        </div>
    </div>
</div>

<!-- Modal för att ta bort stämpelmarkering från bild -->
<div class="modal fade" id="unmarkStampModal" tabindex="-1" aria-labelledby="unmarkStampModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="unmarkStampModalContent">
            <!-- Innehåll laddas dynamiskt -->
        </div>
    </div>
</div>

<script>
// Funktioner för stämpelmodaler
function showRemoveStampModal(url) {
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('removeStampModalContent').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('removeStampModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Fel vid laddning av modal:', error);
        alert('Ett fel uppstod vid laddning av bekräftelsedialog.');
    });
}

function showUnmarkStampModal(url) {
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('unmarkStampModalContent').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('unmarkStampModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Fel vid laddning av modal:', error);
        alert('Ett fel uppstod vid laddning av bekräftelsedialog.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Hantera submit för remove stamp modal
    document.addEventListener('submit', function(e) {
        if (e.target.closest('#removeStampModal')) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Stäng modal och ladda om sidan
                    const modal = bootstrap.Modal.getInstance(document.getElementById('removeStampModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Ett fel uppstod: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Fel vid submit:', error);
                alert('Ett fel uppstod vid borttagning av stämpel.');
            });
        }
        
        // Hantera submit för unmark stamp modal
        if (e.target.closest('#unmarkStampModal')) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Stäng modal och ladda om sidan
                    const modal = bootstrap.Modal.getInstance(document.getElementById('unmarkStampModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Ett fel uppstod: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Fel vid submit:', error);
                alert('Ett fel uppstod vid borttagning av stämpelmarkering.');
            });
        }
    });
});
</script>
{% endblock %} 