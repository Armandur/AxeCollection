{% extends 'axes/base.html' %}
{% load axe_filters %}

{% block title %}Tillverkare - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
    }

    #manufacturersTable td:nth-child(3) { /* Kommentar-kolumnen */
        white-space: normal;
    }

    /* Klickbara rader för dator/tablett */
    @media (min-width: 768px) {
        #manufacturersTable tbody tr {
            cursor: pointer;
        }
    }
    
    .profit-positive { color: #198754; }
    .profit-negative { color: #dc3545; }

    .price-buy { color: #dc3545; font-weight: bold; }
    .price-sell { color: #198754; font-weight: bold; }
    .shipping-cost { font-size: 0.8em; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Tillverkare</h1>

<!-- Statistik-kort -->
<div class="row mb-4">
    <div class="col-md-3">
        {% include "axes/_stat_card.html" with title="Antal tillverkare" value=total_manufacturers %}
    </div>
    <div class="col-md-3">
        {% include "axes/_stat_card.html" with title="Totala yxor" value=total_axes %}
    </div>
    <div class="col-md-3">
        {% include "axes/_stat_card.html" with title="Totala transaktioner" value=total_transactions %}
    </div>
    <div class="col-md-3">
        {% include "axes/_stat_card.html" with title="Genomsnitt yxor/tillverkare" value=average_axes_per_manufacturer|floatformat:1 %}
    </div>
</div>

<!-- Tabell -->
<div class="table-responsive">
    <table id="manufacturersTable" class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Namn</th>
                <th>Kommentar</th>
                <th>Antal yxor</th>
                <th>Köp / Sälj</th>
                <th>Ekonomi</th>
            </tr>
        </thead>
        <tbody>
            {% for manufacturer in manufacturers %}
            <tr data-href="{% url 'manufacturer_detail' manufacturer.id %}">
                <td>{{ manufacturer.id }}</td>
                <td>{{ manufacturer.name }}</td>
                <td>{{ manufacturer.information|strip_markdown_and_truncate:150 }}</td>
                <td data-order="{{ manufacturer.axe_count }}">{{ manufacturer.axe_count }}</td>
                <td>
                    <span class="text-danger">{{ manufacturer.buy_count }}</span> / <span class="text-success">{{ manufacturer.sale_count }}</span>
                </td>
                <td>
                    <span class="text-danger">{{ manufacturer.total_buy_value|format_decimal }} kr</span>
                    <br>
                    <span class="text-success">{{ manufacturer.total_sale_value|format_decimal }} kr</span>
                    <br>
                    <span class="{% if manufacturer.net_value >= 0 %}profit-positive{% else %}profit-negative{% endif %} fw-bold">
                        {{ manufacturer.net_value|format_decimal }} kr
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Document ready - manufacturer_list.html');
    
    $('#manufacturersTable').DataTable({
        language: {
            "emptyTable": "Ingen data tillgänglig i tabellen",
            "info": "Visar _START_ till _END_ av _TOTAL_ poster",
            "infoEmpty": "Visar 0 till 0 av 0 poster",
            "infoFiltered": "(filtrerat från _MAX_ totala poster)",
            "lengthMenu": "Visa _MENU_ poster",
            "loadingRecords": "Laddar...",
            "processing": "Bearbetar...",
            "search": "Sök:",
            "zeroRecords": "Inga matchande poster hittades",
            "paginate": {
                "first": "Första",
                "last": "Sista",
                "next": "Nästa",
                "previous": "Föregående"
            },
            "aria": {
                "sortAscending": ": aktivera för att sortera kolumnen stigande",
                "sortDescending": ": aktivera för att sortera kolumnen fallande"
            },
             "buttons": {
                "copy": "Kopiera",
                "csv": "CSV",
                "excel": "Excel",
                "pdf": "PDF",
                "print": "Skriv ut",
                "colvis": "Visa kolumner"
            }
        },
        layout: {
            topStart: 'pageLength',
            topCenter: 'search',
            topEnd: {
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print', 'colvis'
                ]
            }
        },
        order: [[3, 'desc']], // Sortera efter antal yxor som standard
        initComplete: function() {
            console.log('DataTables initierad');
        }
    });

    // Klickbara rader
    $('#manufacturersTable tbody').on('click', 'tr', function () {
        // Förhindra att klicket propagerar om man klickar på en länk eller knapp inuti raden
        if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || $(event.target).closest('a, button').length) {
            return;
        }
        var href = $(this).data('href');
        if (href) {
            window.location.href = href;
        }
    });
});
</script>
{% endblock %} 