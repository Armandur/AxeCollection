{% extends 'axes/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
.stamp-search-item:hover {
    background-color: #f8f9fa;
}

.stamp-search-item:last-child {
    border-bottom: none !important;
}

.stamp-thumbnail {
    flex-shrink: 0;
}

#stamp_search_results {
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
}

#stamp_search:focus + #stamp_search_results {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Light mode (default) */
#stamp_search_results.stamp-search-dropdown {
    background-color: #ffffff;
    border-color: #dee2e6;
    color: #212529;
}

#stamp_search_results.stamp-search-dropdown .stamp-search-item {
    color: #212529;
    border-color: #dee2e6;
}

#stamp_search_results.stamp-search-dropdown .stamp-search-item:hover {
    background-color: #f8f9fa;
}

#stamp_search_results.stamp-search-dropdown .stamp-search-item .fw-bold {
    color: #000000;
}

#stamp_search_results.stamp-search-dropdown .stamp-search-item .text-muted {
    color: #6c757d;
}

/* Dark mode (Bootstrap theme) */
[data-bs-theme="dark"] #stamp_search_results.stamp-search-dropdown {
    background-color: #212529;
    border-color: #495057;
    color: #f8f9fa;
}

[data-bs-theme="dark"] #stamp_search_results.stamp-search-dropdown .stamp-search-item {
    color: #f8f9fa;
    border-color: #495057;
}

[data-bs-theme="dark"] #stamp_search_results.stamp-search-dropdown .stamp-search-item:hover {
    background-color: #343a40;
}

[data-bs-theme="dark"] #stamp_search_results.stamp-search-dropdown .stamp-search-item .fw-bold {
    color: #ffffff;
}

[data-bs-theme="dark"] #stamp_search_results.stamp-search-dropdown .stamp-search-item .text-muted {
    color: #adb5bd;
}
</style>
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'axe_list' %}">Yxor</a></li>
            <li class="breadcrumb-item"><a href="{% url 'axe_detail' axe.id %}">{{ axe.display_id }}</a></li>
            <li class="breadcrumb-item active">Ange stämpel</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>
                        <i class="fas fa-stamp me-2"></i>
                        Ange stämpel för {{ axe.display_id }}
                    </h4>
                </div>
                <div class="card-body">
                    {% if selected_image %}
                        <!-- Steg 2: Bildmarkering och stämpeldetaljer -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Markera stämpelområde</h6>
                                <div class="position-relative" style="max-width: 100%; overflow: hidden;">
                                    <img id="stampImage" 
                                         src="{{ selected_image.image_url_with_cache_busting }}" 
                                         class="img-fluid" 
                                         alt="Yxbild för stämpelmarkering"
                                         style="max-width: 100%; height: auto;">
                                    
                                    <!-- Markeringsoverlay -->
                                    <div id="markingOverlay" 
                                         class="position-absolute" 
                                         style="top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto; cursor: crosshair;">
                                        <div id="stampMarking" 
                                             class="position-absolute border border-danger bg-danger bg-opacity-25"
                                             style="display: none; min-width: 20px; min-height: 20px;">
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Klicka och dra för att markera stämpelområde</small>
                            </div>
                            <div class="col-md-6">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="save_stamp">
                                    <input type="hidden" name="selected_image" value="{{ selected_image.id }}">
                                    
                                    <div class="mb-3">
                                        <label for="stamp_search" class="form-label">Sök stämpel *</label>
                                        <div class="position-relative">
                                            <input type="text" 
                                                   id="stamp_search" 
                                                   class="form-control" 
                                                   placeholder="Skriv för att söka stämplar..."
                                                   autocomplete="off">
                                            <div id="stamp_search_results" class="stamp-search-dropdown position-absolute w-100 border border-top-0 rounded-bottom shadow-lg" 
                                                 style="z-index: 1000; max-height: 400px; overflow-y: auto; display: none;">
                                            </div>
                                        </div>
                                        <input type="hidden" name="stamp" id="stamp" required>
                                        <div class="form-text">Skriv minst 2 tecken för att söka stämplar</div>
                                        
                                        <!-- Förhandsvisning av vald stämpel -->
                                        <div id="selected_stamp_preview" class="mt-3" style="display: none;">
                                            <div class="card">
                                                <div class="card-body p-3">
                                                    <div class="row">
                                                        <div class="col-auto">
                                                            <div id="selected_stamp_image" class="stamp-thumbnail" style="width: 80px; height: 80px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                                <i class="fas fa-stamp fa-2x text-muted"></i>
                                                            </div>
                                                        </div>
                                                        <div class="col">
                                                            <h6 class="mb-1" id="selected_stamp_name">Stämpelnamn</h6>
                                                            <p class="text-muted mb-1 small" id="selected_stamp_manufacturer">Tillverkare</p>
                                                            <p class="text-muted mb-0 small" id="selected_stamp_details">Detaljer</p>
                                                        </div>
                                                        <div class="col-auto">
                                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear_stamp_selection">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="position" class="form-label">Position på yxan</label>
                                        <input type="text" name="position" id="position" class="form-control" 
                                               placeholder="Var på yxan stämpeln finns (t.ex. 'på bladet', 'vid nacken')"
                                               value="{% if stamp_mark %}{{ stamp_mark.position }}{% endif %}">
                                        <div class="form-text">Var på yxan stämpeln finns</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="uncertainty_level" class="form-label">Osäkerhet</label>
                                        <select name="uncertainty_level" id="uncertainty_level" class="form-select">
                                            <option value="certain" {% if stamp_mark and stamp_mark.uncertainty_level == 'certain' %}selected{% endif %}>Säker</option>
                                            <option value="uncertain" {% if stamp_mark and stamp_mark.uncertainty_level == 'uncertain' %}selected{% endif %}>Osäker</option>
                                            <option value="tentative" {% if stamp_mark and stamp_mark.uncertainty_level == 'tentative' %}selected{% endif %}>Preliminär</option>
                                        </select>
                                        <div class="form-text">
                                            <strong>Säker:</strong> Stämpeln är tydligt identifierad<br>
                                            <strong>Osäker:</strong> Stämpeln är svår att läsa eller tolka<br>
                                            <strong>Preliminär:</strong> Stämpeln är preliminärt identifierad
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Kommentar</label>
                                        <textarea name="comment" id="comment" class="form-control" rows="3" 
                                                  placeholder="Lägg till kommentarer om stämpeln (kvalitet, synlighet, etc.)">{% if stamp_mark %}{{ stamp_mark.comment }}{% endif %}</textarea>
                                        <div class="form-text">Lägg till kommentarer om stämpeln</div>
                                    </div>

                                    <!-- Dolda fält för koordinater -->
                                    <input type="hidden" name="x_coordinate" id="x_coordinate" value="{% if stamp_mark %}{{ stamp_mark.x_coordinate }}{% endif %}">
                                    <input type="hidden" name="y_coordinate" id="y_coordinate" value="{% if stamp_mark %}{{ stamp_mark.y_coordinate }}{% endif %}">
                                    <input type="hidden" name="width" id="width" value="{% if stamp_mark %}{{ stamp_mark.width }}{% endif %}">
                                    <input type="hidden" name="height" id="height" value="{% if stamp_mark %}{{ stamp_mark.height }}{% endif %}">

                                    <div class="d-flex justify-content-between">
                                        <a href="{% url 'axe_detail' axe.id %}" class="btn btn-secondary">Avbryt</a>
                                        <button type="submit" class="btn btn-primary">
                                            {% if stamp_mark %}Uppdatera stämpel{% else %}Spara stämpel{% endif %}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <!-- Steg 1: Bildval -->
                        <div class="mb-4">
                            <h5>Välj bild för stämpelmarkering</h5>
                            <p class="text-muted">Välj en bild som innehåller stämpeln du vill markera.</p>
                            
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="select_image">
                                
                                <div class="row">
                                    {% for image in existing_images %}
                                    <div class="col-md-4 col-sm-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body p-2">
                                                <img src="{{ image.image_url_with_cache_busting }}" 
                                                     class="img-fluid mb-2" 
                                                     style="height: 150px; object-fit: cover;"
                                                     alt="Bild {{ forloop.counter }}">
                                                <div class="d-grid">
                                                    <button type="submit" name="selected_image" value="{{ image.id }}" 
                                                            class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-stamp me-1"></i>
                                                        Välj denna bild
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3">
                                    <a href="{% url 'axe_detail' axe.id %}" class="btn btn-secondary">Avbryt</a>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if selected_image %}
<script src="{% static 'js/stamp_crop_canvas.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Stämpelsökning
    const stampSearch = document.getElementById('stamp_search');
    const stampSearchResults = document.getElementById('stamp_search_results');
    const stampHidden = document.getElementById('stamp');
    const selectedStampPreview = document.getElementById('selected_stamp_preview');
    const clearStampSelection = document.getElementById('clear_stamp_selection');
    
    let searchTimeout;
    let selectedStamp = null;
    
    // Debounced search function
    function searchStamps(query) {
        if (query.length < 2) {
            stampSearchResults.style.display = 'none';
            return;
        }
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetch(`{% url 'search_stamps_ajax' %}?q=${encodeURIComponent(query)}&axe_id={{ axe.id }}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.stamps);
            })
            .catch(error => {
                console.error('Sökfel:', error);
                stampSearchResults.innerHTML = '<div class="p-3 text-muted">Ett fel uppstod vid sökning</div>';
                stampSearchResults.style.display = 'block';
            });
        }, 300);
    }
    
    function displaySearchResults(stamps) {
        if (stamps.length === 0) {
            stampSearchResults.innerHTML = '<div class="p-3 text-muted">Inga stämplar hittades</div>';
        } else {
            // Kontrollera om dark mode är aktivt
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                              window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Ingen inline-styling; låt CSS hantera temat
            stampSearchResults.style.backgroundColor = '';
            stampSearchResults.style.color = '';
            stampSearchResults.style.borderColor = '';
            
            let html = '';
            stamps.forEach(stamp => {
                const manufacturerInfo = stamp.manufacturer ? 
                    `${stamp.manufacturer} (${stamp.manufacturer_type})` : 'Okänd tillverkare';
                let imageHtml;
                if (stamp.has_image) {
                    if (stamp.has_coordinates && stamp.x_coordinate !== null && stamp.y_coordinate !== null && stamp.width !== null && stamp.height !== null) {
                        // Beskuren bild - använd CSS för att visa rätt del
                        const xPos = -stamp.x_coordinate;
                        const yPos = -stamp.y_coordinate;
                        imageHtml = `<div class="stamp-crop-container me-3" style="width: 60px; height: 60px; overflow: hidden; border-radius: 4px;">
                            <img src="${stamp.image_url}" 
                                 style="width: 100%; height: 100%; object-fit: cover; object-position: ${xPos}% ${yPos}%;" 
                                 alt="${stamp.name}"
                                 data-crop-x="${stamp.x_coordinate}"
                                 data-crop-y="${stamp.y_coordinate}"
                                 data-stamp-width="${stamp.width}"
                                 data-stamp-height="${stamp.height}">
                        </div>`;
                    } else {
                        // Hela bilden
                        imageHtml = `<img src="${stamp.image_url}" class="stamp-thumbnail me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;" alt="${stamp.name}">`;
                    }
                } else {
                    imageHtml = `<div class="stamp-thumbnail me-3 d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: ${isDarkMode ? '#343a40' : '#f8f9fa'}; border-radius: 4px;"><i class="fas fa-stamp text-muted"></i></div>`;
                }
                
                html += `
                    <div class="stamp-search-item p-3 border-bottom" data-stamp-id="${stamp.id}" style="cursor: pointer;">
                        <div class="d-flex align-items-center">
                            ${imageHtml}
                            <div class="flex-grow-1">
                                <div class="fw-bold">${stamp.name}</div>
                                <div class="text-muted small">${manufacturerInfo}</div>
                                <div class="text-muted small">${stamp.stamp_type} • ${stamp.status}</div>
                                ${stamp.description ? `<div class="text-muted small mt-1">${stamp.description}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            stampSearchResults.innerHTML = html;
            
            // Använd befintlig funktion för att beskära bilder
            setTimeout(() => {
                if (typeof createCroppedStampImages === 'function') {
                    createCroppedStampImages();
                }
            }, 100);
        }
        stampSearchResults.style.display = 'block';
    }
    
    function selectStamp(stamp) {
        selectedStamp = stamp;
        stampHidden.value = stamp.id;
        
        // Kontrollera om dark mode är aktivt
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark' || 
                          window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // Uppdatera förhandsvisning
        const imageContainer = document.getElementById('selected_stamp_image');
        if (stamp.has_image) {
            if (stamp.has_coordinates && stamp.x_coordinate !== null && stamp.y_coordinate !== null && stamp.width !== null && stamp.height !== null) {
                // Beskuren bild - använd CSS för att visa rätt del
                const xPos = -stamp.x_coordinate;
                const yPos = -stamp.y_coordinate;
                imageContainer.innerHTML = `<img src="${stamp.image_url}" 
                    style="width: 80px; height: 80px; object-fit: cover; object-position: ${xPos}% ${yPos}%; border-radius: 4px;" 
                    alt="${stamp.name}"
                    data-crop-x="${stamp.x_coordinate}"
                    data-crop-y="${stamp.y_coordinate}"
                    data-stamp-width="${stamp.width}"
                    data-stamp-height="${stamp.height}">`;
            } else {
                // Hela bilden
                imageContainer.innerHTML = `<img src="${stamp.image_url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" alt="${stamp.name}">`;
            }
        } else {
            const bgColor = isDarkMode ? '#343a40' : '#f8f9fa';
            imageContainer.innerHTML = `<i class="fas fa-stamp fa-2x text-muted"></i>`;
            imageContainer.style.backgroundColor = bgColor;
        }
        
        document.getElementById('selected_stamp_name').textContent = stamp.name;
        document.getElementById('selected_stamp_manufacturer').textContent = 
            stamp.manufacturer ? `${stamp.manufacturer} (${stamp.manufacturer_type})` : 'Okänd tillverkare';
        document.getElementById('selected_stamp_details').textContent = 
            `${stamp.stamp_type} • ${stamp.status}${stamp.year_range ? ' • ' + stamp.year_range : ''}`;
        
        selectedStampPreview.style.display = 'block';
        stampSearchResults.style.display = 'none';
        stampSearch.value = stamp.name;
        
        // Använd befintlig funktion för att beskära bilder i förhandsvisningen
        setTimeout(() => {
            if (typeof createCroppedStampImages === 'function') {
                createCroppedStampImages();
            }
        }, 100);
    }
    
    function clearSelection() {
        selectedStamp = null;
        stampHidden.value = '';
        selectedStampPreview.style.display = 'none';
        stampSearch.value = '';
        stampSearchResults.style.display = 'none';
    }
    
    // Event listeners
    stampSearch.addEventListener('input', function() {
        searchStamps(this.value);
    });
    
    stampSearch.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            searchStamps(this.value);
        }
    });
    
    stampSearchResults.addEventListener('click', function(e) {
        const item = e.target.closest('.stamp-search-item');
        if (item) {
            const stampId = item.dataset.stampId;
            const stamp = Array.from(item.parentNode.children).find(child => 
                child.dataset.stampId === stampId
            );
            if (stamp) {
                // Hitta stamp-data från sökresultatet
                const name = stamp.querySelector('.fw-bold').textContent;
                const manufacturerText = stamp.querySelector('.text-muted.small').textContent;
                const detailsText = stamp.querySelectorAll('.text-muted.small')[1].textContent;
                const description = stamp.querySelector('.text-muted.small.mt-1')?.textContent || '';
                
                // Skapa stamp-objekt
                const stampData = {
                    id: stampId,
                    name: name,
                    manufacturer: manufacturerText.split(' (')[0],
                    manufacturer_type: manufacturerText.includes('(') ? manufacturerText.split(' (')[1].replace(')', '') : '',
                    stamp_type: detailsText.split(' • ')[0],
                    status: detailsText.split(' • ')[1],
                    description: description,
                    has_image: stamp.querySelector('img') !== null,
                    image_url: stamp.querySelector('img')?.src || null
                };
                
                selectStamp(stampData);
            }
        }
    });
    
    clearStampSelection.addEventListener('click', clearSelection);
    
    // Dölj sökresultat när man klickar utanför
    document.addEventListener('click', function(e) {
        if (!stampSearch.contains(e.target) && !stampSearchResults.contains(e.target)) {
            stampSearchResults.style.display = 'none';
        }
    });
    
    // Lyssna på ändringar i tema
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        // Om sökresultat är synliga, uppdatera dem
        if (stampSearchResults.style.display === 'block' && stampSearch.value.length >= 2) {
            searchStamps(stampSearch.value);
        }
    });
    
    // Visa befintlig vald stämpel om den finns
    {% if stamp_mark and stamp_mark.stamp %}
    const existingStamp = {
        id: {{ stamp_mark.stamp.id }},
        name: "{{ stamp_mark.stamp.name }}",
        manufacturer: "{{ stamp_mark.stamp.manufacturer.name|default:'' }}",
        manufacturer_type: "{{ stamp_mark.stamp.manufacturer.manufacturer_type|default:'' }}",
        stamp_type: "{{ stamp_mark.stamp.get_stamp_type_display }}",
        status: "{{ stamp_mark.stamp.get_status_display }}",
        year_range: "{{ stamp_mark.stamp.year_range|default:'' }}",
        description: "{{ stamp_mark.stamp.description|default:'' }}",
        has_image: {% if stamp_mark.stamp.primary_image %}true{% else %}false{% endif %},
        image_url: "{% if stamp_mark.stamp.primary_image %}{% if stamp_mark.stamp.primary_image.image_type == 'axe_mark' and stamp_mark.stamp.primary_image.axe_image %}{{ stamp_mark.stamp.primary_image.axe_image.image_url_with_cache_busting }}{% else %}{{ stamp_mark.stamp.primary_image.image_url_with_cache_busting }}{% endif %}{% endif %}",
        has_coordinates: {% if stamp_mark.stamp.primary_image and stamp_mark.stamp.primary_image.has_coordinates %}true{% else %}false{% endif %},
        x_coordinate: {% if stamp_mark.stamp.primary_image and stamp_mark.stamp.primary_image.x_coordinate %}{{ stamp_mark.stamp.primary_image.x_coordinate }}{% else %}null{% endif %},
        y_coordinate: {% if stamp_mark.stamp.primary_image and stamp_mark.stamp.primary_image.y_coordinate %}{{ stamp_mark.stamp.primary_image.y_coordinate }}{% else %}null{% endif %},
        width: {% if stamp_mark.stamp.primary_image and stamp_mark.stamp.primary_image.width %}{{ stamp_mark.stamp.primary_image.width }}{% else %}null{% endif %},
        height: {% if stamp_mark.stamp.primary_image and stamp_mark.stamp.primary_image.height %}{{ stamp_mark.stamp.primary_image.height }}{% else %}null{% endif %},
        image_type: "{% if stamp_mark.stamp.primary_image %}{{ stamp_mark.stamp.primary_image.image_type }}{% endif %}"
    };
    selectStamp(existingStamp);
    {% endif %}
});

document.addEventListener('DOMContentLoaded', function() {
    const image = document.getElementById('stampImage');
    const overlay = document.getElementById('markingOverlay');
    const marking = document.getElementById('stampMarking');
    
    // Debug: Kontrollera att elementen finns
    console.log('Image element:', image);
    console.log('Overlay element:', overlay);
    console.log('Marking element:', marking);
    
    if (!image || !overlay || !marking) {
        console.error('Kunde inte hitta alla nödvändiga element');
        return;
    }
    
    let isDrawing = false;
    let startX, startY;
    
    // Sätt overlay-storlek till bildstorlek
    function updateOverlaySize() {
        const rect = image.getBoundingClientRect();
        overlay.style.width = rect.width + 'px';
        overlay.style.height = rect.height + 'px';
        console.log('Overlay size updated:', rect.width, 'x', rect.height);
    }
    
    // Uppdatera storlek när bilden laddas
    image.addEventListener('load', updateOverlaySize);
    window.addEventListener('resize', updateOverlaySize);
    updateOverlaySize();
    
    // Om vi redigerar en befintlig markering, visa den
    {% if stamp_mark and stamp_mark.x_coordinate and stamp_mark.y_coordinate and stamp_mark.width and stamp_mark.height %}
    function showExistingMarking() {
        const x = {{ stamp_mark.x_coordinate }};
        const y = {{ stamp_mark.y_coordinate }};
        const width = {{ stamp_mark.width }};
        const height = {{ stamp_mark.height }};
        
        // Vänta tills bilden är laddad och storleken är uppdaterad
        if (image.complete && image.naturalWidth > 0) {
            const rect = image.getBoundingClientRect();
            
            // Konvertera procent till pixlar för visning
            const displayX = (x / 100) * rect.width;
            const displayY = (y / 100) * rect.height;
            const displayWidth = (width / 100) * rect.width;
            const displayHeight = (height / 100) * rect.height;
            
            marking.style.left = displayX + 'px';
            marking.style.top = displayY + 'px';
            marking.style.width = displayWidth + 'px';
            marking.style.height = displayHeight + 'px';
            marking.style.display = 'block';
            
            console.log('Existing marking displayed:', displayX, displayY, displayWidth, displayHeight);
        } else {
            // Om bilden inte är laddad än, vänta och försök igen
            setTimeout(showExistingMarking, 100);
        }
    }
    
    // Visa befintlig markering när bilden laddas
    image.addEventListener('load', showExistingMarking);
    // Försök också direkt om bilden redan är laddad
    if (image.complete) {
        showExistingMarking();
    }
    {% endif %}
    
    // Hantera musinteraktion
    overlay.addEventListener('mousedown', function(e) {
        console.log('Mouse down detected');
        e.preventDefault();
        e.stopPropagation();
        isDrawing = true;
        const rect = image.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        
        console.log('Start position:', startX, startY);
        
        marking.style.left = startX + 'px';
        marking.style.top = startY + 'px';
        marking.style.width = '0px';
        marking.style.height = '0px';
        marking.style.display = 'block';
    });
    
    overlay.addEventListener('mousemove', function(e) {
        if (!isDrawing) return;
        
        e.preventDefault();
        e.stopPropagation();
        const rect = image.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        
        marking.style.left = left + 'px';
        marking.style.top = top + 'px';
        marking.style.width = width + 'px';
        marking.style.height = height + 'px';
    });
    
    overlay.addEventListener('mouseup', function(e) {
        if (!isDrawing) return;
        
        console.log('Mouse up detected');
        e.preventDefault();
        e.stopPropagation();
        isDrawing = false;
        
        // Uppdatera koordinatfält - konvertera till procent
        const rect = image.getBoundingClientRect();
        const markingRect = marking.getBoundingClientRect();
        
        // Beräkna koordinater som procent av bildens naturliga storlek
        const x = Math.round(((markingRect.left - rect.left) / rect.width) * 100);
        const y = Math.round(((markingRect.top - rect.top) / rect.height) * 100);
        const width = Math.round((markingRect.width / rect.width) * 100);
        const height = Math.round((markingRect.height / rect.height) * 100);
        
        console.log('Coordinates (percentages):', x, y, width, height);
        
        document.getElementById('x_coordinate').value = x;
        document.getElementById('y_coordinate').value = y;
        document.getElementById('width').value = width;
        document.getElementById('height').value = height;
    });
    
    // Global mouseup-hanterare för att hantera när musen släpps utanför overlay
    document.addEventListener('mouseup', function(e) {
        if (isDrawing) {
            console.log('Global mouse up detected');
            isDrawing = false;
        }
    });
    
    // Lägg till touch-events för mobila enheter
    overlay.addEventListener('touchstart', function(e) {
        console.log('Touch start detected');
        e.preventDefault();
        isDrawing = true;
        const rect = image.getBoundingClientRect();
        const touch = e.touches[0];
        startX = touch.clientX - rect.left;
        startY = touch.clientY - rect.top;
        
        marking.style.left = startX + 'px';
        marking.style.top = startY + 'px';
        marking.style.width = '0px';
        marking.style.height = '0px';
        marking.style.display = 'block';
    });
    
    overlay.addEventListener('touchmove', function(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const rect = image.getBoundingClientRect();
        const touch = e.touches[0];
        const currentX = touch.clientX - rect.left;
        const currentY = touch.clientY - rect.top;
        
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        
        marking.style.left = left + 'px';
        marking.style.top = top + 'px';
        marking.style.width = width + 'px';
        marking.style.height = height + 'px';
    });
    
    overlay.addEventListener('touchend', function(e) {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
        
        const rect = image.getBoundingClientRect();
        const markingRect = marking.getBoundingClientRect();
        
        // Beräkna koordinater som procent av bildens naturliga storlek
        const x = Math.round(((markingRect.left - rect.left) / rect.width) * 100);
        const y = Math.round(((markingRect.top - rect.top) / rect.height) * 100);
        const width = Math.round((markingRect.width / rect.width) * 100);
        const height = Math.round((markingRect.height / rect.height) * 100);
        
        document.getElementById('x_coordinate').value = x;
        document.getElementById('y_coordinate').value = y;
        document.getElementById('width').value = width;
        document.getElementById('height').value = height;
    });
});
</script>
{% endif %}
{% endblock %} 