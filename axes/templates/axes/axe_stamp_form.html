{% extends 'axes/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'axe_list' %}">Yxor</a></li>
            <li class="breadcrumb-item"><a href="{% url 'axe_detail' axe.id %}">{{ axe.display_id }}</a></li>
            <li class="breadcrumb-item active">Ange stämpel</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>
                        <i class="fas fa-stamp me-2"></i>
                        Ange stämpel för {{ axe.display_id }}
                    </h4>
                </div>
                <div class="card-body">
                    {% if selected_image %}
                        <!-- Steg 2: Bildmarkering och stämpeldetaljer -->
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Markera stämpelområde</h6>
                                <div class="position-relative" id="image-container">
                                    <img src="{{ selected_image.image_url_with_cache_busting }}" 
                                         class="img-fluid" 
                                         alt="Yxbild"
                                         id="axe-image"
                                         style="max-width: 100%; height: auto;">
                                    <div id="crop-overlay" class="position-absolute border border-primary" 
                                         style="display: none; background: rgba(0, 123, 255, 0.2);"></div>
                                </div>
                                <small class="text-muted">Klicka och dra för att markera stämpelområde</small>
                            </div>
                            <div class="col-md-6">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="save_stamp">
                                    <input type="hidden" name="selected_image" value="{{ selected_image.id }}">
                                    
                                    <div class="mb-3">
                                        <label for="stamp" class="form-label">Välj stämpel *</label>
                                        <select name="stamp" id="stamp" class="form-select" required>
                                            <option value="">-- Välj stämpel --</option>
                                            {% for stamp in available_stamps %}
                                                <option value="{{ stamp.id }}">
                                                    {{ stamp.name }}
                                                    {% if stamp.manufacturer %}
                                                        ({{ stamp.manufacturer.name }})
                                                    {% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">Välj vilken stämpel som finns på bilden</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="position" class="form-label">Position på yxan</label>
                                        <input type="text" name="position" id="position" class="form-control" 
                                               placeholder="Var på yxan stämpeln finns (t.ex. 'på bladet', 'vid nacken')">
                                        <div class="form-text">Var på yxan stämpeln finns</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="uncertainty_level" class="form-label">Osäkerhet</label>
                                        <select name="uncertainty_level" id="uncertainty_level" class="form-select">
                                            <option value="säker">Säker</option>
                                            <option value="osäker">Osäker</option>
                                            <option value="preliminär">Preliminär</option>
                                        </select>
                                        <div class="form-text">
                                            <strong>Säker:</strong> Stämpeln är tydligt identifierad<br>
                                            <strong>Osäker:</strong> Stämpeln är svår att läsa eller tolka<br>
                                            <strong>Preliminär:</strong> Stämpeln är preliminärt identifierad
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="comment" class="form-label">Kommentar</label>
                                        <textarea name="comment" id="comment" class="form-control" rows="3" 
                                                  placeholder="Lägg till kommentarer om stämpeln (kvalitet, synlighet, etc.)"></textarea>
                                        <div class="form-text">Lägg till kommentarer om stämpeln</div>
                                    </div>

                                    <!-- Dolda fält för koordinater -->
                                    <input type="hidden" name="x_coordinate" id="x_coordinate" value="">
                                    <input type="hidden" name="y_coordinate" id="y_coordinate" value="">
                                    <input type="hidden" name="width" id="width" value="">
                                    <input type="hidden" name="height" id="height" value="">

                                    <div class="d-flex justify-content-between">
                                        <a href="{% url 'axe_detail' axe.id %}" class="btn btn-secondary">Avbryt</a>
                                        <button type="submit" class="btn btn-primary">Spara stämpel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {% else %}
                        <!-- Steg 1: Bildval -->
                        <div class="mb-4">
                            <h5>Välj bild för stämpelmarkering</h5>
                            <p class="text-muted">Välj en bild som innehåller stämpeln du vill markera.</p>
                            
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="select_image">
                                
                                <div class="row">
                                    {% for image in existing_images %}
                                    <div class="col-md-4 col-sm-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body p-2">
                                                <img src="{{ image.image_url_with_cache_busting }}" 
                                                     class="img-fluid mb-2" 
                                                     style="height: 150px; object-fit: cover;"
                                                     alt="Bild {{ forloop.counter }}">
                                                <div class="d-grid">
                                                    <button type="submit" name="selected_image" value="{{ image.id }}" 
                                                            class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-stamp me-1"></i>
                                                        Välj denna bild
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="mt-3">
                                    <a href="{% url 'axe_detail' axe.id %}" class="btn btn-secondary">Avbryt</a>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if selected_image %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const image = document.getElementById('axe-image');
    const overlay = document.getElementById('crop-overlay');
    const xInput = document.getElementById('x_coordinate');
    const yInput = document.getElementById('y_coordinate');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    
    let isDrawing = false;
    let startX, startY;
    
    function updateOverlay() {
        const x = parseInt(xInput.value) || 0;
        const y = parseInt(yInput.value) || 0;
        const width = parseInt(widthInput.value) || 0;
        const height = parseInt(heightInput.value) || 0;
        
        if (x > 0 && y > 0 && width > 0 && height > 0) {
            overlay.style.left = x + 'px';
            overlay.style.top = y + 'px';
            overlay.style.width = width + 'px';
            overlay.style.height = height + 'px';
            overlay.style.display = 'block';
        } else {
            overlay.style.display = 'none';
        }
    }
    
    function getImageCoordinates(clientX, clientY) {
        const rect = image.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const y = Math.max(0, Math.min(clientY - rect.top, rect.height));
        return { x: Math.round(x), y: Math.round(y) };
    }
    
    image.addEventListener('mousedown', function(e) {
        isDrawing = true;
        const coords = getImageCoordinates(e.clientX, e.clientY);
        startX = coords.x;
        startY = coords.y;
        
        xInput.value = startX;
        yInput.value = startY;
        widthInput.value = 0;
        heightInput.value = 0;
        
        updateOverlay();
    });
    
    image.addEventListener('mousemove', function(e) {
        if (!isDrawing) return;
        
        const coords = getImageCoordinates(e.clientX, e.clientY);
        const width = Math.abs(coords.x - startX);
        const height = Math.abs(coords.y - startY);
        
        widthInput.value = width;
        heightInput.value = height;
        
        updateOverlay();
    });
    
    image.addEventListener('mouseup', function() {
        isDrawing = false;
    });
    
    // Uppdatera overlay när input-värden ändras
    [xInput, yInput, widthInput, heightInput].forEach(input => {
        input.addEventListener('input', updateOverlay);
    });
    
    // Visa befintlig markering vid laddning
    updateOverlay();
});
</script>
{% endif %}
{% endblock %} 